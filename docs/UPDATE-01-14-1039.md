# 更新日志：内存监控体系 (v4.1)

**日期**: 2026-01-14
**范围**: 公共 API (Schema) & 采集端 (Host Collector)

## 1. Schema 变更 (`collector/common/schema.py`)

### `UnifiedEvent` 新增 `memory` 字段
为了支持主机层面的内存异常检测（无文件攻击检测），我们在统一事件模型中新增了 `MemoryInfo` 结构。

```python
@dataclass
class MemoryAnomaly:
    """v4.1 新增: 内存异常详情"""
    type: str = ""          # 异常类型 (如 MEMFD_EXEC, RWX_REGION)
    address: str = ""       # 内存起始地址 (如 7f...)
    size: int = 0           # 区域大小
    perms: str = ""         # 权限字符串 (如 rwxp)
    path: str = ""          # 映射路径 (如 /memfd:...)
    is_elf: bool = False    # 是否包含 ELF 头 (指纹识别)
    risk_level: str = ""    # 风险等级 (LOW, MEDIUM, HIGH, CRITICAL)
    confidence: float = 0.0 # 置信度
    details: str = ""       # 详细描述

@dataclass
class MemoryInfo:
    """v4.1 新增: 内存监控信息"""
    anomalies: List[MemoryAnomaly] = field(default_factory=list)

@dataclass
class UnifiedEvent:
    # ... 现有字段 ...
    memory: MemoryInfo = field(default_factory=MemoryInfo) # v4.1 新增
```

## 2. 采集端更新 (`collector/host_collector/auditd_agent.py`)

### 内存行为分析器 (BehaviorAnalyzer)
集成 C++ 内存扫描器，实现定期的内存完整性检查。

*   **双重触发机制**:
    1.  **定时扫描**: 每 5 分钟进行一次全量扫描（低负载时）。
    2.  **事件驱动**: (TODO) 监控到敏感系统调用时触发特定 PID 扫描。

*   **去重与降噪**:
    *   **签名去重**: 对同一 PID 的同一组异常生成 MD5 签名，5 分钟内不重复告警。
    *   **风险过滤**: 仅上报 `HIGH` 和 `CRITICAL` 级别的异常，自动过滤系统进程的 `LOW/MEDIUM` 噪音。

*   **数据流**:
    MemScanner (C++) -> JSON Output -> AuditdAgent (Python) -> UnifiedEvent -> Elasticsearch

## 3. 检测能力覆盖
通过此次更新，TraceX 新增了对以下无文件攻击技术的检测能力：
1.  **Memfd 匿名执行**: 利用 `memfd_create` 在内存中运行 ELF 二进制。
2.  **Shellcode 注入**: 识别具有 RWX (读写执行) 权限的匿名内存段。
3.  **Reflective Loading**: 识别隐藏在正常内存段中的 ELF 文件头。
4.  **Buffer Overflow**: 识别栈 (Stack) 或堆 (Heap) 变为可执行状态的异常。
