# 更新日志：登录会话重建 (v4.1)

**日期**: 2026-01-14
**范围**: 公共 API (Schema) & 核心逻辑 (Log Parser)

## 1. Schema 变更 (`collector/common/schema.py`)

### `UserInfo` 类更新
新增 `session_id` 字段以支持审计会话追踪。

```python
@dataclass
class UserInfo:
    # ... 现有字段 ...
    session_id: str = "" # v4.1 新增: Audit Session ID (ses)
```

## 2. 用途 (`collector/host_collector/log_parser.py`)

### 会话上下文增强 (Session Context Enrichment)
实现了一种有状态的会话缓存机制，以解决登录后活动的“IP 归因”问题。

*   **机制**:
    1.  **缓存**: 维护一个 `_session_cache` 映射表: `{ session_id: source_ip }`。
    2.  **捕获**: 当解析 `USER_LOGIN` 事件时，提取 `ses` (会话ID) 和 `addr` (源IP) 并存入缓存。
    3.  **增强**: 当解析后续的 `SYSCALL` 或 `EXECVE` 事件（这些事件原生缺乏 IP 信息）时，根据 `ses` 查找缓存并回填 `event.source.ip`。

### 逻辑流程
1.  **登录事件**: `USER_LOGIN` (ses=100, addr=192.168.1.50) -> 写入缓存: `{100: "192.168.1.50"}`。
2.  **命令事件**: `SYSCALL` (ses=100, exe="/bin/rm") -> 查找缓存(100) -> 事件增强: `source.ip = "192.168.1.50"`。

## 3. 影响
*   **数据融合**: 使得能够基于 Session ID 重建完整的用户活动时间线。
*   **可追溯性**: 允许将特定的危险命令（如 `rm -rf`）溯源到原始的远程 IP 地址，即使该命令日志本身不包含 IP 信息。
