# 组员1任务详解：主机日志采集与防御

**目录 (Table of Contents)**

1.  [任务总览 (Overview)](#1-任务总览-overview)
2.  [Linux 采集与防御体系 (Linux Collection & Defense System)](#2-linux-采集与防御体系-linux-collection--defense-system)
    *   [2.1 Linux Host Collector (纯 Python 采集引擎)](#21-linux-host-collector-纯-python-采集引擎)
    *   [2.2 核心机制：聚合与标准化 (Core Mechanism)](#22-核心机制聚合与标准化-core-mechanism)
    *   [2.3 内存行为防御体系 (TraceX MemDefense)](#23-内存行为防御体系-tracex-memdefense)
3.  [Windows 采集与防御体系 (Windows Collection & Defense System)](#3-windows-采集与防御体系-windows-collection--defense-system)
    *   [3.1 Windows Host Collector (WinAgent)](#31-windows-host-collector-winagent)
    *   [3.2 Windows 内存扫描库 (MemScanner Library)](#32-windows-内存扫描库-memscanner-library)
    *   [3.3 Windows 从零部署指南 (Deployment From Scratch)](#33-windows-从零部署指南-deployment-from-scratch)
    *   [3.4 Windows 事件解析支持 (Event Parsing Logic)](#34-windows-事件解析支持-event-parsing-logic)
4.  [测试与验证指南 (Testing & Verification Guide)](#4-测试与验证指南-testing--verification-guide)
    *   [4.1 Linux 核心测试套件](#41-linux-核心测试套件)
    *   [4.2 Windows 核心测试套件](#42-windows-核心测试套件)
    *   [4.3 通用/集成测试](#43-通用集成测试)

---

## 1. 任务总览 (Overview)

负责主机侧安全数据的全生命周期管理，包括：Linux/Windows 双平台的主机日志采集、解析与标准化，以及基于内存行为的高级威胁检测。
重点关注系统审计日志（Auditd）、Windows 事件日志（EventLog）及跨平台的内存无文件攻击防御。

---

## 2. Linux 采集与防御体系 (Linux Collection & Defense System)

### 2.1 Linux Host Collector (纯 Python 采集引擎)

#### 2.1.1 采集架构
系统采用轻量级的纯 Python 架构，直接从内核审计子系统获取数据，无需依赖 Filebeat 等外部组件。
*   **链路**: Linux Auditd -> **auditd_agent.py (Direct)** -> Elasticsearch
*   **优势**: 零外部依赖，单进程部署，资源占用极低。

#### 2.1.2 高可用与数据可靠性 (Reliability)
为了确保生产环境的数据完整性，采集引擎内置了以下核心机制：
*   **断点续传 (Checkpointing)**: 维护状态文件 `agent_state.json`，持久化记录 `inode` 和 `offset`，服务重启可毫秒级恢复，杜绝数据丢失。
*   **日志轮转处理 (Log Rotation)**: 实时监控 `inode` 变化，自动感知日志切割并无缝切换。
*   **智能解析与降级 (Smart Parsing)**: 采用 **Try-Catch-Fallback** 策略。无法解析的日志自动标记为 `raw_log` 并保留原始文本入库。

#### 2.1.3 启动与运行
Host Collector 提供了三种不同模式的启动脚本（**均需 Root 权限**）：

1.  **标准采集模式 (`auditd_agent.py`)**: 生产环境主程序。
    ```bash
    export PYTHONPATH=$PYTHONPATH:.
    python3 collector/host_collector/auditd_agent.py
    ```
2.  **无过滤模式 (`auditd_agent_no_filter.py`)**: 采集全量日志，用于排查漏报（数据量极大）。
3.  **调试输出模式 (`auditd_agent_withPrintf.py`)**: 控制台打印详细流程，用于开发调试。

### 2.2 核心机制：聚合与标准化 (Core Mechanism)

#### 2.2.1 Linux 多行日志聚合
*   **业务场景**: Linux Auditd 单次操作（如 `cat /etc/shadow`）会分散在 SYSCALL、CWD、PATH 等多条记录中。
*   **技术实现**: 采用 **有状态解析 (Stateful Parsing)**，利用 `_audit_buffer` 缓存上下文，基于 **“新 ID 触发旧事件刷新”** 策略。
*   **效果**: 自动拼接 `EXECVE` 命令行，智能提取 `PATH` 路径，生成单条完整事件。

#### 2.2.2 数据标准化与元数据增强
*   **时间对齐**: 统一使用 `process.start_time`。
*   **自动打标 (Auto-Tagging)**: 基于行为特征自动填充 `metadata.atlas_label` (如 `TEMP_FILE`, `SCRIPT_EXEC`)。
*   **进程树补全**: 内置 PPID 提取逻辑，还原 `parent -> child` 调用链。

### 2.3 内存行为防御体系 (TraceX MemDefense)

#### 2.3.1 功能能力
检测无文件攻击 (Fileless Attack) 和高级内存注入：
1.  **Shellcode 注入**: 识别 RWX 内存区域。
2.  **Reflective ELF Loading**: 检测内存中的 ELF 二进制文件。
3.  **Process Hollowing**: 发现匿名内存映射中的非法代码。

#### 2.3.2 技术架构 (Architecture)
采用 **“C++ 核心引擎 + Python 行为调度”** 的双层混合架构：
*   **C++ 核心引擎 (`mem_scanner`)**: 高性能底层扫描。
    *   **技术**: RWX Hunting, ELF Fingerprinting (`process_vm_readv`).
    *   **风险分级**: CRITICAL (ELF头), HIGH (匿名RWX), MEDIUM (文件映射RWX).
*   **Python 行为调度器 (`BehaviorAnalyzer`)**:
    *   **事件驱动**: 监控 `ptrace`, `memfd_create` 等敏感调用触发扫描。
    *   **动态巡检**: 系统空闲时（CPU < 80%）执行全量检查。

#### 2.3.3 部署方式
*   **模式 A (生产环境)**: 在构建机编译后，使用 `scp` 将二进制文件 `mem_scanner` 传输至生产服务器 `/opt/tracex/bin/`。
*   **模式 B (开发环境)**: 在目标机器直接运行 `./build_mem_scanner.sh` 进行源码编译。

---

## 3. Windows 采集与防御体系 (Windows Collection & Defense System)

### 3.1 Windows Host Collector (WinAgent)

*   **脚本路径**: `collector/host_collector/win_agent.py`
*   **定位**: Windows 环境下的核心采集守护进程。
*   **功能**:
    *   **进程监控**: 实时遍历系统进程列表。
    *   **内存扫描**: 周期性调用内存扫描库检测异常。
    *   **告警上报**: 发现威胁时自动封装 Schema 并上报 ES。
*   **运行命令**: `python collector/host_collector/win_agent.py`

### 3.2 Windows 内存扫描库 (MemScanner Library)

*   **脚本路径**: `collector/host_collector/win_mem_scanner.py`
*   **定位**: 基于 `ctypes` 的底层内存扫描库 (Library)。
*   **原理**: 调用 Windows API (`OpenProcess`, `VirtualQueryEx`, `ReadProcessMemory`) 直接操作内存。
*   **检测能力**:
    *   **RWX Hunting**: 发现具有 `PAGE_EXECUTE_READWRITE` 权限的内存区域。
    *   **Private Exec**: 发现 `MEM_PRIVATE` 类型的可执行内存（Shellcode/JIT 特征）。

### 3.3 Windows 从零部署指南 (Deployment From Scratch)

本指南适用于在全新的 Windows 虚拟机（如 Web Server, DC, PC-1）上部署采集 Agent。

#### 3.3.1 基础环境准备
1.  **安装 Python**: 下载并安装 Python 3.8+ (建议 3.10)，务必勾选 "**Add Python to PATH**"。
2.  **获取代码**: 使用 Git Clone 或直接复制项目文件夹。

#### 3.3.2 安装依赖库
在 PowerShell (管理员) 中执行：
```powershell
python -m pip install --upgrade pip
pip install -r requirements.txt
# 确保核心库已安装
pip install psutil requests pywin32
```

#### 3.3.3 验证与启动
1.  **验证配置**: 检查 `win_agent.py` 中的 `ES_HOST`，确保能 `curl` 通 ES 端口。
2.  **启动服务**:
    ```powershell
    python collector/host_collector/win_agent.py
    ```
    看到 `[INFO] WinAgent initialized` 即表示运行成功。

### 3.4 Windows 事件解析支持 (Event Parsing Logic)

为了支持跨平台日志采集，系统在 `collector/host_collector/log_parser.py` 中集成了 Windows Event Log 解析逻辑。

*   **支持事件**:
    *   **4624 (Login)** -> `authentication`
    *   **4688 (Process)** -> `process_created`
    *   **4663 (File Access)** -> `file.access`
*   **实现逻辑**: 统一入口 `HostLogParser.parse(..., log_type="windows")`，自动清洗十六进制 PID 和非标时间戳。

---

## 4. 测试与验证指南 (Testing & Verification Guide)

### 4.1 Linux 核心测试套件

| 脚本文件 | 功能描述 | 运行命令 |
| :--- | :--- | :--- |
| **test_host_collector.py** | **[核心]** 集成测试。包含连接性、Schema、LogParser 及 Auditd 模拟。 | `python3 tests/test_host_collector.py` |
| **test_host_collector_memory_attack.py** | **[高危]** 内存攻击模拟。触发真实的 Memfd/Ptrace 攻击以验证防御。 | `python3 tests/test_host_collector_memory_attack.py` |
| **test_host_collector_auditd_aggregation.py** | **[逻辑]** Auditd 多行日志聚合逻辑测试。 | `python3 tests/test_host_collector_auditd_aggregation.py` |

### 4.2 Windows 核心测试套件

| 脚本文件 | 功能描述 | 运行命令 |
| :--- | :--- | :--- |
| **test_host_collector_win_mem_scanner.py** | **[单元]** 验证 Windows 内存扫描库能否正常调用 API 扫描自身。 | `python tests/test_host_collector_win_mem_scanner.py` |
| **test_host_collector_win_test_sender.py** | **[工具]** 流量生成器。构造模拟的 Windows 日志和告警发送至 ES。 | `python tests/test_host_collector_win_test_sender.py` |

### 4.3 通用/集成测试

| 脚本文件 | 功能描述 | 运行命令 |
| :--- | :--- | :--- |
| **test_host_collector_windows_es_integration.py** | **[集成]** 模拟 Windows 事件日志写入 ES，验证 Kibana 展示。 | `python3 tests/test_host_collector_windows_es_integration.py` |
| **test_host_collector_windows_parser_compliance.py** | **[合规]** 验证 Windows 解析逻辑是否符合 Schema v4.1 标准。 | `python3 tests/test_host_collector_windows_parser_compliance.py` |
