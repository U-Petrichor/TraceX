# 组员1任务详解：主机日志采集与防御

## 任务概览
负责 Linux 主机日志的采集、解析与标准化，以及基于内存行为的高级威胁检测。重点关注系统审计日志（Auditd）、系统日志（Syslog）及内存无文件攻击防御。

## 1. Linux Host Collector (纯 Python 采集引擎)

### 1.1 采集架构
系统采用轻量级的纯 Python 架构，直接从内核审计子系统获取数据，无需依赖 Filebeat 等外部组件。
*   **链路**: Linux Auditd -> **auditd_agent.py (Direct)** -> Elasticsearch
*   **优势**: 零外部依赖，单进程部署，资源占用极低。

### 1.2 高可用与数据可靠性 (Reliability)
为了确保生产环境的数据完整性，采集引擎内置了以下核心机制：

#### 1.2.1 断点续传 (Checkpointing)
*   **机制**: 维护状态文件 `agent_state.json`，持久化记录当前文件的 `inode` 和读取偏移量 `offset`。
*   **效果**: 服务重启或异常崩溃后，可毫秒级恢复至上次读取位置，杜绝数据重复或丢失。

#### 1.2.2 日志轮转处理 (Log Rotation Handling)
*   **机制**: 实时监控 `/var/log/audit/audit.log` 的 `inode` 变化。
*   **效果**: 当系统自动切割日志时，Agent 能够自动感知并无缝切换至新文件头部继续采集。

#### 1.2.3 智能解析与降级 (Smart Parsing with Fallback)
*   **机制**: 采用 **Try-Catch-Fallback** 策略处理日志流。
    *   **Normal**: 解析为符合 Schema 标准的结构化数据。
    *   **Fallback**: 遇到非标或截断日志时，自动标记为 `event.category="raw_log"` 并保留原始文本入库。
*   **效果**: 确保所有审计痕迹100%留存。

### 1.3 启动与验证

#### 1.3.1 环境准备 (Prerequisites)
运行 Host Collector 之前，请确保已安装必要的 Python 依赖库：

```bash
# 在项目根目录下执行
pip3 install -r requirements.txt
# 或者手动安装
pip3 install psutil elasticsearch pyyaml requests
```

#### 1.3.3 启动服务
Host Collector 提供了三种不同模式的启动脚本，分别适用于生产环境、全量采集和开发调试（**注意：均需 Root 权限**）：

1. **标准采集模式 (`auditd_agent.py`)**
   - **功能**: 生产环境主程序。包含完整的日志解析、白名单过滤、内存扫描、告警去重及 Elasticsearch 上传功能。
   - **运行命令**:
     ```bash
     export PYTHONPATH=$PYTHONPATH:.
     python3 collector/host_collector/auditd_agent.py
     ```

2. **无过滤模式 (`auditd_agent_no_filter.py`)**
   - **功能**: 采集全量原始日志。禁用所有过滤规则，适用于需要完整审计记录或排查漏报的场景（注意：会产生超级超级超级超级超级超级超级超级多的数据，一小时能写36GB的那种）。
   - **运行命令**:
     ```bash
     export PYTHONPATH=$PYTHONPATH:.
     python3 collector/host_collector/auditd_agent_no_filter.py
     ```

3. **调试输出模式 (`auditd_agent_withPrintf.py`)**
   - **功能**: 详细打印模式。在控制台实时输出日志解析流程和中间状态，仅用于开发调试和逻辑验证（注意：一样会产生超级超级超级超级超级超级超级超级多的数据）。
   - **运行命令**:
     ```bash
     export PYTHONPATH=$PYTHONPATH:.
     python3 collector/host_collector/auditd_agent_withPrintf.py
     ```

## 2. Windows 事件日志解析支持

为了支持跨平台日志采集，系统在 `collector/host_collector/log_parser.py` 中集成了 Windows Event Log (JSON 格式) 解析引擎。

### 2.1 支持的事件类型
目前支持以下核心安全事件的标准化映射：

| EventID | 事件类型 | 映射到 UnifiedEvent (Schema) | 关键字段提取 |
| :--- | :--- | :--- | :--- |
| **4624** | 登录成功 | `event.category="authentication"`<br>`event.action="login"` | `user.name` (TargetUserName)<br>`source.ip` (IpAddress) |
| **4688** | 进程创建 | `event.category="process"`<br>`event.action="process_created"` | `process.executable` (NewProcessName)<br>`process.command_line` (CommandLine)<br>`process.pid` (ProcessId) |
| **4663** | 对象访问 | `event.category="file"`<br>`event.action="access"` | `file.path` (ObjectName)<br>`file.name` (文件名) |

### 2.2 实现逻辑
*   **统一入口**: `HostLogParser.parse(raw_data, log_type="windows")`
*   **兼容性**: 通过 `log_type` 参数区分 Linux/Windows 日志流。
*   **数据清洗**: 自动规范化 Windows XML/JSON 中的十六进制 PID 和非标时间戳。

### 2.3 测试与演示 (Testing & Demo)

#### 2.3.1 单元测试 (Unit Test)
*   **目标**: 验证 Windows 日志解析逻辑的 Schema 合规性。
*   **命令**: `python tests/test_host_collector_windows_parser_compliance.py`

#### 2.3.2 集成演示 (Integration Demo)
*   **目标**: 模拟从日志生成到 Kibana 可视化的全过程。
*   **命令**: `python3 tests/test_host_collector_windows_es_integration.py`
*   **结果**: 控制台输出 `Ingested Event... Result: created` 即表示成功。

## 3. 核心功能实现 (Function Implementation)

### 3.1 Linux 多行日志聚合

#### 业务场景
Linux Auditd 日志采用“流式多行记录”格式，单次操作（如 `cat /etc/shadow`）会分散在 SYSCALL（进程）、CWD（目录）、PATH（文件）等多条记录中。

#### 技术实现 (Implementation)
系统引入了 **有状态解析 (Stateful Parsing)** 机制：
*   **聚合逻辑**: 利用 `_audit_buffer` 缓存同一 `audit_id` 的上下文，采用 **“新 ID 触发旧事件刷新 (Flush-on-New-ID)”** 策略。
*   **字段还原**:
    *   **EXECVE**: 自动拼接 `a0`, `a1`... 参数为完整命令行。
    *   **PATH**: 智能提取 `nametype=NORMAL` 的目标文件路径。

#### 实测效果
在执行 `sudo cat /etc/shadow` 的测试中，系统能生成单条包含完整上下文的事件：
*   **Event**: `process.name="cat"` AND `file.path="/etc/shadow"`
*   **Value**: 直接还原攻击链路，无需人工二次关联。

### 3.2 数据标准化与元数据增强 (Data Enrichment)
系统在解析阶段注入了丰富的上下文信息，以提升分析价值：
*   **时间对齐**: 统一使用 `process.start_time` 记录进程启动时间。
*   **自动打标 (Auto-Tagging)**: 基于行为特征自动填充 `metadata.atlas_label`。
    *   例如：操作 `/tmp/` 目录标记为 `TEMP_FILE`；执行 `.sh` 脚本标记为 `SCRIPT_EXEC`。
*   **进程树补全**: 内置 PPID 提取逻辑，完整还原 `parent -> child` 调用链。

## 4. 内存行为防御体系 (TraceX MemDefense)

### 4.1 功能能力 (Capabilities)
本系统包含一套独立的**内存防御子系统**，用于检测无文件攻击 (Fileless Attack) 和高级内存注入行为：
1.  **Shellcode 注入**: 识别内存中异常的“写+执行” (RWX) 区域。
2.  **Reflective ELF Loading (反射加载)**: 检测不落地直接在内存中执行的 ELF 二进制文件。
3.  **Process Hollowing**: 发现匿名内存映射中的非法可执行代码。

### 4.2 技术架构 (Architecture)
采用**“C++ 核心引擎 + Python 行为调度”**的双层混合架构：

#### 4.2.1 C++ 核心引擎 (`mem_scanner`)
*   **定位**: 高性能底层扫描单元。
*   **核心技术**:
    *   **RWX Hunting**: 快速定位 `vm_flags` 包含 `rd`+`wr`+`ex` 的内存页。
    *   **ELF Fingerprinting**: 使用 `process_vm_readv` 远程读取内存头，匹配 `\x7fELF` 魔数。
    *   **风险分级 (Risk Scoring)**:
        *   **CRITICAL**: 发现 ELF 头 或 堆栈可执行。
        *   **HIGH**: 匿名 RWX 内存。
        *   **MEDIUM**: 有文件映射的 RWX。
*   **安全机制**: 强制 Root 权限运行，内置白名单机制（`--whitelist`）以兼容 JIT 进程。

#### 4.2.2 Python 行为调度器 (`BehaviorAnalyzer`)
*   **定位**: 业务决策与调度中心。
*   **双模触发机制**:
    1.  **攻击序列触发 (Event-Driven)**: 实时监控系统调用，匹配 `ptrace` + `write` (注入) 或 `memfd_create` + `execve` (无文件执行) 等攻击序列，毫秒级触发扫描。
    2.  **动态负载巡检 (Smart Periodic)**: 智能感知系统负载，在空闲时段（CPU < 80%）执行全量健康检查。

### 4.3 使用与部署 (Deployment)

#### 4.3.1 部署方式
由于生产服务器通常不具备编译环境 (g++)，我们提供两种部署模式。请根据实际情况选择：

**模式 A：预编译部署（推荐，标准生产环境）**
*   **适用场景**: 生产服务器 (Target Server) 禁止安装编译器，或为了统一部署版本。
*   **操作流程**:
    1.  **构建 (Build)**: 在与生产环境架构一致（如 Linux x86_64）的 **开发机/构建机** 上运行：
        ```bash
        cd collector/host_collector/mem_scanner
        make
        # 成功后会在当前目录生成二进制文件: mem_scanner
        ```
    2.  **传输 (Transfer)**: 将生成的 `mem_scanner` 文件上传至 **生产服务器** 的指定目录。
        ```bash
        # 示例: 上传至生产服务器
        scp mem_scanner root@prod-server:/opt/tracex/bin/
        ```
    3.  **赋权 (Permission)**: 在 **生产服务器** 上赋予执行权限。
        ```bash
        chmod +x /opt/tracex/bin/mem_scanner
        ```

**模式 B：源码编译部署（测试环境/开发调试）**
*   **适用场景**: 开发调试，或服务器已具备完整的开发工具链。
*   **操作流程**:
    直接在 **目标服务器** 上运行根目录下的自动化构建脚本：
    ```bash
    ./build_mem_scanner.sh
    # 脚本会自动检查 g++ 环境 -> 编译 -> 安装至 /opt/tracex/bin
    ```

#### 4.3.2 运行与监控
部署完成后，Python Agent (`auditd_agent.py`) 会自动探测 `/opt/tracex/bin/mem_scanner` 是否存在。若存在，将自动接管调度，无需人工干预。
*   **Kibana 查询**: `event.category: "memory"`
*   **告警样例**:
    ```json
    {
      "event.action": "anomaly_detected",
      "event.reason": "Fileless Execution",
      "memory.anomalies": [
        {
          "type": "MEMFD_EXEC",
          "risk_level": "CRITICAL",
          "details": "Executable memfd with valid ELF header"
        }
      ]
    }
    ```

## 5. 测试文件使用指南

本章节详细说明 `tests/` 目录下各个测试脚本的功能与使用方法。

### 5.1 Host Collector 核心测试 (`test_host_collector.py`)
*   **功能**: Host Collector 的主要集成测试套件。包含连接性检查、Schema 验证、LogParser 单元测试以及 Auditd 行为模拟测试。
*   **适用环境**: Linux (推荐) / Windows (部分跳过)。
*   **依赖**: 需要安装 `elasticsearch` Python 库。
*   **配置**: 支持 `ES_HOST` 环境变量。
*   **运行命令**:
    ```bash
    python3 tests/test_host_collector.py
    ```

### 5.2 内存攻击模拟测试 (`test_host_collector_memory_attack.py`)
*   **功能**: 模拟高级内存攻击场景，用于验证内存防御子系统的检测能力。
    *   **模拟场景 1**: Memfd 无文件执行 (Fileless Execution)。
    *   **模拟场景 2**: 内存篡改 (Memory Tampering) 与 Ptrace 注入。
*   **适用环境**: **Linux Only** (依赖 `memfd_create` 系统调用)。
*   **注意事项**: 运行此脚本会触发真实的内存异常，请勿在生产环境运行。
*   **运行命令**:
    ```bash
    python3 tests/test_host_collector_memory_attack.py
    ```

### 5.3 Auditd 聚合逻辑测试 (`test_host_collector_auditd_aggregation.py`)
*   **功能**: 专门测试 `HostLogParser` 对 Auditd 多行日志的聚合逻辑（SYSCALL + EXECVE + CWD + PATH）。
*   **适用环境**: Linux / Windows (纯逻辑测试，无系统依赖)。
*   **运行命令**:
    ```bash
    python3 tests/test_host_collector_auditd_aggregation.py
    ```

### 5.4 Windows ES 集成测试 (`test_host_collector_windows_es_integration.py`)
*   **功能**: 模拟 Windows 安全事件日志，解析并直接写入 Elasticsearch，用于验证数据流路通畅及 Kibana 展示效果。
*   **适用环境**: Windows / Linux (只要能连上 ES)。
*   **配置**: 支持 `ES_HOST` 环境变量。
*   **运行命令**:
    ```bash
    python3 tests/test_host_collector_windows_es_integration.py
    ```

### 5.5 Windows 解析合规性测试 (`test_host_collector_windows_parser_compliance.py`)
*   **功能**: 验证 Windows 事件日志 (EventID 4624/4688/4663) 是否能正确解析为符合 Schema v4.1 标准的 `UnifiedEvent` 对象。
*   **适用环境**: Windows / Linux (纯逻辑测试)。
*   **运行命令**:
    ```bash
    python3 tests/test_host_collector_windows_parser_compliance.py
    ```

### 5.6 Windows 内存扫描库测试 (`test_host_collector_win_mem_scanner.py`)
*   **功能**: 单元测试。验证 `win_mem_scanner` 库能否正确调用 Windows API 并扫描当前进程自身。
*   **适用环境**: **Windows Only**。
*   **运行命令**:
    ```powershell
    python tests/test_host_collector_win_mem_scanner.py
    ```

### 5.7 Windows 连通性测试发送器 (`test_host_collector_win_test_sender.py`)
*   **功能**: 流量生成器。构造模拟的 Windows 进程创建日志和内存威胁告警并发送至 ES，用于验证网络连通性和 Kibana 展示。
*   **适用环境**: Windows / Linux (只要能连上 ES)。
*   **运行命令**:
    ```powershell
    python tests/test_host_collector_win_test_sender.py
    ```

## 6. Windows Host Collector & Memory Defense (New)

为了适配 Windows 虚拟机集群环境，系统扩展了专用的 Windows 采集 Agent 与内存防御组件。

### 6.1 Windows Agent (`win_agent.py`)
*   **定位**: Windows 环境下的核心采集守护进程。
*   **功能**:
    *   **进程监控**: 实时遍历系统进程列表。
    *   **内存扫描**: 周期性调用内存扫描库检测异常。
    *   **告警上报**: 发现威胁时自动封装 Schema 并上报 ES。
*   **运行方式**:
    ```powershell
    python collector/host_collector/win_agent.py
    ```

### 6.2 Windows Memory Scanner Library (`win_mem_scanner.py`)
*   **定位**: 基于 `ctypes` 的底层内存扫描库 (Library)。
*   **原理**: 调用 Windows API (`OpenProcess`, `VirtualQueryEx`, `ReadProcessMemory`) 直接操作内存。
*   **检测能力**:
    *   **RWX Hunting**: 发现具有“读写执行”权限的内存区域。
    *   **Private Exec**: 发现私有可执行内存（常见于 Shellcode/JIT）。

### 6.3 Windows 环境从零部署指南 (From Scratch)

本指南适用于在全新的 Windows 虚拟机（如 Web Server, DC, PC-1）上部署采集 Agent。

#### 6.3.1 基础环境准备
1. **安装 Python**:
   - 下载并安装 Python 3.8+ (建议 3.10)。
   - **重要**: 安装时务必勾选 "**Add Python to PATH**"。
   - 验证: 打开 PowerShell 输入 `python --version`。

2. **获取代码**:
   - 方式 A (推荐): 安装 Git for Windows，执行 `git clone`。
   - 方式 B (离线): 将 `TraceX` 整个项目文件夹复制到 `C:\TraceX`。

#### 6.3.2 安装依赖库
在项目根目录下打开 PowerShell (管理员身份)，执行：
```powershell
# 1. 升级 pip (可选)
python -m pip install --upgrade pip

# 2. 安装项目依赖
pip install -r requirements.txt

# 3. 确保核心库已安装 (如果上面的报错)
pip install psutil requests pywin32
```

#### 6.3.3 验证配置
打开 `collector/host_collector/win_agent.py`，确认顶部配置：
*   **ES_HOST**: 默认为 `http://182.92.114.32:9200`。
*   **网络连通性**: 在 PowerShell 中执行 `curl http://182.92.114.32:9200`，确保能看到 Elasticsearch 的 JSON 响应。

#### 6.3.4 启动服务
在项目根目录下执行：
```powershell
# 启动 Windows Agent
python collector/host_collector/win_agent.py
```
*   **成功标志**: 控制台输出 `[INFO] WinAgent initialized on <Hostname>`。
*   **运行状态**: Agent 会每 60 秒自动扫描一次全系统进程内存。

#### 6.3.5 常见问题排查
*   **ImportError: No module named 'win32api'**: 说明 `pywin32` 未安装成功，请重新运行 `pip install pywin32`。
*   **ConnectionError**: 检查本机网络是否能 ping 通 ES 服务器，或防火墙是否拦截了 9200 端口。

