# **TraceX 恶意行为溯源分析系统 - 技术原理与设计文档**

## **📚 目录**

```table-of-contents
```
## **第一部分：技术原理 (Technical Principles)**

**定位：** 阐述系统背后的计算机网络与操作系统底层机制，解释“为什么这样做”。

### **1.1 基于反向代理的内网穿透技术 (NAT Traversal via Reverse Proxy)**

* 核心痛点：  
  在真实攻防场景中，高价值目标（如域控制器 DC、核心终端 PC-1）通常位于 NAT 网关或企业防火墙之后，不具备公网 IP。外部控制端（C2 服务器或安全分析平台）无法主动向内网发起连接请求（Inbound Connection Blocked）。  
* 技术原理：  
  本系统采用 FRP (Fast Reverse Proxy) 协议实现内网穿透。  
  1. **中继节点 (Relay Server):** 利用一台具有公网 IP 的云服务器部署 frps 服务。  
  2. **出站连接 (Outbound Connection):** 内网网关节点（Web Server）主动向公网服务器的特定端口（7000）发起 TCP 连接。由于大多数防火墙默认允许出站流量，握手得以成功建立。  
  3. **多路复用隧道 (Multiplexing Tunnel):** FRP 在这条已建立的 TCP 长连接上构建虚拟隧道。当外部用户访问公网服务器的特定端口（如 6030）时，流量被封装并通过隧道“逆向”推送到内网主机，实现流量穿透。

### **1.2 覆盖网络 (Overlay Network) 与星型汇聚架构**

* 技术原理：  
  系统在物理网络之上构建了一个逻辑上的覆盖网络 (Overlay Network)，采用星型拓扑结构。  
  * **物理层：** PC-1、DC、Web Server 通过虚拟交换机（vSwitch）连接在同一网段（192.168.52.x/24）。  
  * **逻辑层：** 选定 **Web Server** 作为逻辑子网的 **流量网关 (Gateway)**。所有内网节点不直接与云端通信，而是将 Web Server 配置为下一跳代理。  
  * **优势：** 这种设计模拟了真实企业内网的“DMZ区 - 核心区”分层架构，减少了公网暴露面（Attack Surface），仅暴露 Web Server 一个入口，提高了系统的仿真度与安全性。

### **1.3 基于 Win32 API 的无文件监控机制 (Agent Implementation)**

* 技术原理：  
  针对 Windows 操作系统，本系统摒弃了传统的文件系统轮询（File-based Polling）方式，转而采用 “Everything is an API” 的内核交互理念。  
  * **动态调用：** Python Agent 利用 ctypes 库动态加载 Windows 核心动态链接库 (kernel32.dll, psapi.dll, advapi32.dll)。  
  * **内存与进程快照：** 调用 CreateToolhelp32Snapshot 获取进程列表，调用 VirtualQueryEx 遍历进程内存段信息（Memory Basic Information）。  
  * **行为捕获：** 通过订阅 ETW (Event Tracing for Windows) 或轮询 Sysmon 事件日志，实时捕获进程创建、网络连接等高频行为。  
  * **优势：** 相比于解析 /proc 文件系统（Linux 方式），直接调用 Win32 API 具有更低的 I/O 开销和毫秒级的响应速度。

## **第二部分：概要设计 (High-Level Design, HLD)**

**定位：** 宏观展示系统架构、模块划分与数据流向。

### **2.1 系统拓扑架构 (System Topology)**

系统采用典型的 **“云-边-端” (Cloud-Edge-End)** 三层协同架构：

* **云端 (Cloud Layer):**  
  * 部署 FRP Server (frps) 作为通信枢纽。  
  * 部署 Elasticsearch 与 Kibana 作为数据汇聚与分析中心。  
  * 负责指令下发与全局态势感知。  
* **边缘层 (Edge Layer):**  
  * 部署 Web Server (192.168.52.20)。  
  * 作为内网的 **网关 (Gateway)**，负责维持与云端的隧道连接、流量清洗与路由分发。  
* **端侧 (Endpoint Layer):**  
  * 部署 PC-1 (.30) 和 DC (.10)。  
  * 作为高交互蜜罐与数据采集源，运行 Python Agent，负责底层行为数据的生产。

### **2.2 功能模块设计**

1. **隧道通信模块 (Tunneling Module):**  
   * 负责维护一条从内网到云端的加密 TCP 长连接。  
   * 包含 **心跳保活 (Heartbeat)** 机制，防止 NAT 会话超时中断。  
   * 具备 **断线重连 (Automatic Reconnection)** 功能，确保持续在线。  
2. **数据采集模块 (Agent Module):**  
   * 驻留于各 Windows 节点（PC-1, DC, Web）。  
   * 周期性（或触发式）采集进程、网络、文件、注册表行为数据。  
   * 负责数据的清洗与序列化（JSON 格式）。  
3. **远程管理模块 (Remote Management Module):**  
   * 提供 **SSH**（命令行）通道，用于代码部署与调试。  
   * 提供 **RDP**（图形化）通道，用于系统配置与可视化操作。  
   * 支持多并发连接与流量转发。

### **2.3 数据流向设计 (Data Flow)**

* **控制流 (Inbound - 入站):**  
  * **路径：** 运维人员 -> 云公网 IP:端口 -> \[FRP 隧道\] -> Web 网关 -> 目标主机 22/3389 端口。  
  * **作用：** 远程管理、代码更新、指令下发。  
* **数据流 (Outbound - 出站):**  
  * **路径：** Win Agent (PC-1/DC) -> JSON 数据包 -> Web 网关转发 -> \[FRP 隧道\] -> 云端数据库 (ES:9200)。  
  * **作用：** 日志上报、告警推送、心跳同步。

## **第三部分：详细设计 (Low-Level Design, LLD)**

**定位：** 具体实现细节、参数配置与代码逻辑。

### **3.1 端口映射方案 (Port Mapping Specification)**

为避免端口冲突并规范管理，系统采用 **“IP尾号对齐法”** 进行端口分配。云端防火墙需放行 6000-6050 端口段。

| 节点名称 | 内网 IP | SSH 映射端口 (TCP) | RDP 映射端口 (TCP) | 备注 |
| :---- | :---- | :---- | :---- | :---- |
| **DC (域控)** | 192.168.52.**10** | **6012** (避开6010) | 6002 | 通过 Web 网关转发 |
| **Web Server** | 192.168.52.**20** | **6020** | 6001 | 本机直连 |
| **PC-1 (员工)** | 192.168.52.**30** | **6030** | 6003 | 通过 Web 网关转发 |

### **3.2 网关路由配置 (Gateway Configuration)**

Web Server 上的 frpc.ini 采用 **多代理 (Multi-Proxy)** 配置模式，利用 local_ip 参数指定下一跳地址，实现“单点接入，全网路由”。

**关键配置片段 (frpc.ini)：**
```
[common]  
server_addr = 182.92.114.32  
server_port = 7000  
token = 123456

# --- Web Server 自身映射 ---  
[ssh_web]  
type = tcp  
local_ip = 127.0.0.1  
local_port = 22  
remote_port = 6020

# --- 转发至 PC-1 (路由功能) ---  
[ssh_pc1]  
type = tcp  
local_ip = 192.168.52.30  ; 目标指向内网 PC-1  
local_port = 22  
remote_port = 6030        ; 云端暴露端口

# --- 转发至 DC (路由功能) ---  
[ssh_dc]  
type = tcp  
local_ip = 192.168.52.10  ; 目标指向内网 DC  
local_port = 22  
remote_port = 6012
```
### **3.3 Agent 数据采集逻辑 (Agent Logic)**

* **开发语言：** Python 3.10 + pywin32 + ctypes
* **核心类设计：** `WinAgent` (调度器) + `WinMemoryScanner` (扫描器)
  * **输入：** 全系统进程 PID 列表。
  * **处理流程：**
    1. **提权：** 自动申请 `SeDebugPrivilege` 权限（若以 Admin 运行），确保能访问系统进程。
    2. **句柄获取：** 调用 `OpenProcess` 获取目标进程句柄。
    3. **内存遍历：** 循环调用 `VirtualQueryEx` 获取内存块信息 (MBI)。
    4. **特征匹配：**
        *   **RWX Hunting**: 检查 `mbi.Protect` 是否包含 `PAGE_EXECUTE_READWRITE` (RWX)。
        *   **Private Exec**: 检查 `MEM_PRIVATE` + `PAGE_EXECUTE_READ` (Shellcode 特征)。
  * **输出：** 风险等级 (High/Medium/Low) 及元数据 JSON。
  * **域控扩展 (DC Only):** `WinAgentDC` 额外开启后台线程，通过 PowerShell 实时轮询 Security Event Log (ID 4624/4625)，补充 IAM 审计数据。

### **3.4 通信协议与格式 (Protocol & Format)**

* **传输层：** 采用 TCP 协议。利用 FRP 的 **Mux (多路复用)** 技术，在单一物理连接中并发处理多个逻辑会话，提高传输效率。  
* **应用层数据载荷：** 统一采用 **JSON (JavaScript Object Notation)** 格式，确保跨平台兼容性。  
  * **Schema 定义 (v4.1)：**  
    ```json
    {
      "@timestamp": "2026-01-15T13:45:00Z",
      "event": {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "category": "host",
        "type": "info",
        "action": "memory_scan",
        "severity": 8
      },
      "host": {
        "name": "PC-1",
        "ip": ["192.168.52.30"]
      },
      "process": {
        "pid": 4512,
        "name": "powershell.exe",
        "command_line": "powershell.exe -w hidden -enc AAB..."
      },
      "memory": {
        "anomalies": [
          {
            "type": "RWX_REGION",
            "address": "0x7ff...",
            "risk_level": "HIGH"
          }
        ]
      },
      "detection": {
        "severity": "high",
        "confidence": 0.9
      },
      "message": "Detected memory anomalies in PID 4512"
    }
    ```
