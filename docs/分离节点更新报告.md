# 系统架构与数据流详解 (System Architecture & Data Flow)

## 1. 架构总览：云-边-端协同 (Cloud-Edge-Endpoint Architecture)

本系统采用 “云-边-端” 协同架构。内网主机产生的安全数据，经过加密隧道透传至云端进行汇聚与分析。

### 1.1 核心架构关系图 (Topology & Relationship)
我们在逻辑上构建了一个以 Web Server 为跳板的星型汇聚网络。

| 节点角色 | 定义 | 职责描述 |
| :--- | :--- | :--- |
| **云端服务器 (Cloud Server)** | **大脑** | 负责接收指令、存储数据 (ELK/Database) 和维持隧道入口。 |
| **Web Server (Gateway)** | **咽喉** | 内网唯一的出入口。DC 和 PC-1 的流量通常通过它进行“流量清洗”或“端口转发”到达云端（或在直连模式下作为管理跳板）。 |
| **PC-1 & DC (Agents)** | **触手** | 负责采集最底层的系统行为数据（进程、网络、注册表），不仅是数据生产者，也是被控端。 |

---

## 2. 三大核心数据流详解 (Data Flows)

我们在系统中设计了三类完全不同的数据流，它们混跑在同一条物理网线上，但在逻辑上是隔离的。

### 🔄 流向一：控制信道 (Control Plane) - FRP 隧道
这是系统的“生命线”，确保内网机器能与云端通信。
*   **发送方**: Web Server (代表所有内网机器)
*   **接收方**: 云端服务器 (FRP Server)
*   **传输内容**: 
    *   **心跳包 (Heartbeat)**: 每隔几秒发送一次，内容是：“我还在，别断开”。
    *   **路由表注册**: “我是 PC-1，请把公网 6030 端口的数据转给我”。
*   **数据格式**: FRP 私有二进制协议 (Binary / Mux)。
*   **作用**: 打穿防火墙，建立一条从内网到外网的长连接隧道。
    *   **关键架构**: 内网所有流量必须汇聚到 Web Server，由 Web Server 统一转发到公网。

### 📊 流向二：业务数据流 (Data Plane) - TraceX Agent
这是我们项目的核心价值，即 Agent 采集到的安全日志。
*   **发送方**: PC-1 (`win_agent.py`) / DC (`win_agent_dc.py`)
*   **中转方**: Web Server (Gateway)
*   **接收方**: 云端数据库 (Elasticsearch)
*   **传输路径**: `Agent` -> `Web Server` -> `Cloud Server`
    *   **配置说明**: Agent 上的 `ES_HOST` 应指向 Web Server 的 IP，Web Server 再将流量代理至云端。
*   **传输内容**: 
    *   进程创建日志 (Process Creation)
    *   网络连接日志 (Network Connection)
    *   敏感文件访问 (File Access)
*   **数据格式**: **JSON (JavaScript Object Notation)**
    *   这是最关键的格式。无论底层系统多复杂，我们最终上传的一定是标准化的 JSON 字符串。
*   **JSON 示例**:
    ```json
    { 
       "timestamp": "2026-01-15T13:45:00", 
       "host": "PC-1", 
       "event_id": 1, 
       "process_name": "powershell.exe", 
       "command_line": "powershell.exe -enc AAB...", 
       "risk_level": "High" 
    }
    ```

### 🛠️ 流向三：管理维护流 (Management Plane) - SSH/RDP
这是组员开发调试用的通道。
*   **发送方**: 组员的笔记本电脑 (外网)
*   **接收方**: 内网各主机 (PC-1, Web, DC)
*   **传输内容**:
    *   **SSH**: 加密的 Shell 指令（如 `ls`, `python run.py`）和文本回显。
    *   **RDP**: 屏幕差异画面（Bitmap）和鼠标键盘指令。
*   **数据格式**: SSHv2 加密流 / RDP 协议流。

---

## 3. 通信矩阵总结表 (Technical Summary)

请组员参考下表理解数据是如何“打包”和“解包”的：

| 通信类型 | 源节点 (Source) | 中转节点 (Proxy) | 目的节点 (Dest) | 核心协议 | 数据载荷格式 (Payload) | 备注 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **隧道维持** | Web Server | - | Cloud Server | TCP/FRP | 二进制 (Binary) | 维持连接不断开 |
| **日志上报** | PC-1 / DC | Web Server | Cloud (DB) | HTTP/TCP | **JSON** | 包含 event_id, src_ip 等字段 |
| **远程代码** | 组员电脑 | Cloud -> Web | PC-1 / DC | SSH | SSH Encrypted | 开发调试使用 |
| **远程桌面** | 组员电脑 | Cloud -> Web | PC-1 / DC | RDP | Bitmap/Input | 图形化操作使用 |

---

## 3. 对其他组员的影响 (Impact on Other Members)

由于我们引入了域控专用 Agent 和增强的内存扫描，其他负责数据处理和前端展示的同学需要关注以下变化：

### 3.1 对后端/分析组 (Backend/Analysis) 的影响
*   **新增威胁场景**: 需要针对 `event.category = "iam"` 编写检测规则。
    *   *规则示例*: 如果 `event.action == "login-failed"` 在 1 分钟内出现 > 5 次，且 `source.ip` 相同 -> 判定为 **暴力破解 (Brute Force)**。
*   **内存告警处理**: 需要处理嵌套的 JSON 数组 `memory.anomalies`。
    *   *注意*: 一个进程可能包含多个异常内存段，需要展开分析。

### 3.2 对前端/可视化组 (Frontend/Visualization) 的影响
*   **仪表盘更新**:
    *   **新增 "域控安全视图"**: 专门展示 `category="iam"` 的数据，统计登录失败 Top IP、新增账号列表。
    *   **新增 "内存威胁视图"**: 使用表格展示 `memory.anomalies` 中的 `address`, `risk_level`, `details`。
*   **字段映射**:
    *   需确保前端组件能正确渲染 `event.severity` (1=Info, 5=Medium, 8=High, 10=Critical) 的颜色区分。

### 3.3 对测试组 (QA) 的影响
*   **测试用例扩展**:
    *   不能只测普通 Agent，必须单独测试 `win_agent_dc.py`。
    *   需要模拟域控环境（或在测试机模拟生成 Event 4625 日志）来验证采集功能。
