# 组员4 Graph Analyzer 模块技术文档

> 版本: v6.0  
> 更新日期: 2026-01-14  
> 作者: 组员4

---

## 1. 模块概述

组员4负责 **攻击图构建、情报富化、APT归因**，是 TraceX 系统的核心分析引擎。

### 1.1 核心职责

| 组件 | 文件 | 职责 |
|------|------|------|
| **PIDCache** | `pid_cache.py` | 解决 Linux PID 复用问题 |
| **AtlasMapper** | `atlas_mapper.py` | 给图节点打语义标签（用于可视化） |
| **GraphBuilder** | `graph_builder.py` | 构建实体关系图（节点 + 边） |
| **MITRELoader** | `mitre_loader.py` | 加载真实 MITRE ATT&CK 数据（172个APT组织） |
| **IntelEnricher** | `enrichment.py` | IOC情报富化 + APT归因 |
| **ProvenanceSystem** | `provenance_system.py` | 主控制器，BFS溯源 |

### 1.2 目录结构

```
analyzer/graph_analyzer/
├── __init__.py
├── pid_cache.py          # PID 缓存
├── atlas_mapper.py       # 语义标签映射
├── graph_builder.py      # 图构建器
├── mitre_loader.py       # MITRE 数据加载器
├── enrichment.py         # 情报富化 + APT归因
└── provenance_system.py  # 溯源系统主控

attack-stix-data/         # MITRE ATT&CK 真实数据（需要克隆）
└── enterprise-attack/
    └── enterprise-attack.json
```

---

## 2. 整体数据流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          整体数据流程                                    │
└─────────────────────────────────────────────────────────────────────────┘

组员3 输出
    │
    ├── 种子事件（高危告警）
    │
    └── TTP ID 列表（Sigma检测结果，如 ["T1059", "T1105", "T1005"]）
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│  ProvenanceSystem.rebuild_attack_path(seed_event)                       │
│                                                                         │
│  1. BFS 遍历：从种子事件出发，调用组员3的 find_related_events          │
│                                                                         │
│  2. 图构建：GraphBuilder 生成节点ID、提取实体关系                       │
│                                                                         │
│  3. 语义标签：AtlasMapper 给节点打标签（用于可视化）                    │
│                                                                         │
│  4. IOC富化：IntelEnricher.enrich_entities() 查询IP/域名风险           │
│                                                                         │
│  5. APT归因：IntelEnricher.attribute_by_ttps() 匹配APT组织             │
└─────────────────────────────────────────────────────────────────────────┘
    │
    ▼
输出结果
    ├── 攻击图（nodes + edges）
    ├── IOC 情报（哪些IP是恶意的）
    └── APT 归因（疑似哪个黑客组织）
```

---

## 3. 各组件详细说明

### 3.1 PIDCache - PID上下文缓存

**解决什么问题？**

Linux 系统会复用 PID。进程 A (PID=1234) 退出后，新进程 B 可能获得同样的 PID=1234。如果只用 PID 标识进程，会导致混淆。

**解决方案：** 缓存 `(主机名, PID) → 启动时间` 的映射，用三元组唯一标识进程。

```python
from analyzer.graph_analyzer.pid_cache import PIDCache

cache = PIDCache()

# 记录进程启动时间
cache.set_start_time("web-server", 1234, "2026-01-14T10:00:00Z")

# 查询
start_time = cache.get_start_time("web-server", 1234)
# 返回: "2026-01-14T10:00:00Z"

# 强制刷盘
cache.flush()
```

**存储格式（pid_context_cache.json）：**
```json
{
  "web-server_1234": "2026-01-14T10:00:00.123456Z",
  "web-server_5678": "2026-01-14T10:05:00.000000Z"
}
```

---

### 3.2 AtlasMapper - 语义标签映射器

**用途：给图节点打人类可读的标签，方便可视化展示。**

> ⚠️ **注意：ATLAS 标签只用于可视化，不用于 APT 归因！**

```python
from analyzer.graph_analyzer.atlas_mapper import AtlasMapper

mapper = AtlasMapper()

# 示例事件
event = {
    "process": {"executable": "/usr/bin/curl", "name": "curl"},
    "event": {"category": "process"}
}

label = mapper.get_label(event)
# 返回: "SUSPICIOUS_DOWNLOADER"
```

**标签映射规则：**

| 原始事件特征 | ATLAS 标签 |
|-------------|-----------|
| `/usr/bin/curl` | SUSPICIOUS_DOWNLOADER |
| `/usr/bin/whoami` | RECON_COMMAND |
| `/tmp/shell.txt` | TEMP_FILE_ACCESS |
| `/var/www/html/a.php` 被创建 | PHP_SCRIPT |
| `/etc/passwd` | SENSITIVE_FILE |
| 网络出站 | NETWORK_Outbound |
| `bash -i` | REVERSE_SHELL |

---

### 3.3 GraphBuilder - 图构建器

**核心职责：**
1. 为每个实体生成唯一的节点 ID（MD5 哈希）
2. 从事件中提取实体（进程、文件、网络、用户）
3. 建立实体之间的关系（边）

```python
from analyzer.graph_analyzer.graph_builder import GraphBuilder

builder = GraphBuilder()

# 生成单个事件的节点ID
node_id = builder.generate_node_id(event)

# 批量构建图
events = [event1, event2, event3]
graph = builder.build_from_events(events)

print(graph["nodes"])  # 节点列表
print(graph["edges"])  # 边列表
```

**节点 ID 生成策略：**

| 事件类型 | 唯一性构成 |
|---------|-----------|
| process | `host + pid + executable + start_time` |
| file | `host + path + action + event_id` |
| network | `host + src_ip + dst_port + event_id` |
| authentication | `host + src_ip + user + session_id` |

**关系类型：**

| 关系 | 含义 |
|------|------|
| `spawned` | 进程创建子进程 |
| `accessed` | 进程访问文件 |
| `created` | 进程创建文件 |
| `initiated` | 发起网络连接 |
| `connected_to` | 连接到目标 |
| `attempted_login` | 尝试登录 |

---

### 3.4 MITRELoader - MITRE数据加载器

**用途：从本地 attack-stix-data 仓库加载真实的 MITRE ATT&CK 数据。**

```python
from analyzer.graph_analyzer.mitre_loader import MITRELoader

# 自动检测 TraceX/attack-stix-data 目录
loader = MITRELoader()
loader.load()

# 获取统计
stats = loader.get_statistics()
# {'total_groups': 172, 'total_techniques': 691, ...}

# 查询 APT 组织
apt28 = loader.get_group_by_name("APT28")
print(apt28.name)        # "APT28"
print(apt28.aliases)     # ["Fancy Bear", "Sofacy", ...]
print(apt28.techniques)  # ["T1566.001", "T1059.001", ...]

# 查询使用某技术的组织
groups = loader.get_groups_using_technique("T1059.001")
# 返回 83 个使用 PowerShell 的 APT 组织
```

**数据来源：**
```bash
# 克隆到 TraceX 目录下
cd TraceX
git clone https://github.com/mitre-attack/attack-stix-data.git
```

---

### 3.5 IntelEnricher - 情报富化器 ⭐重要

**两个核心功能：**

#### 功能1：IOC 情报富化

查询 IP/域名是否为恶意。

```python
from analyzer.graph_analyzer.enrichment import IntelEnricher

enricher = IntelEnricher()

# 图节点列表
nodes = [
    {"type": "ip", "properties": {"ip": "45.33.2.1"}},
    {"type": "ip", "properties": {"ip": "192.168.1.5"}}
]

result = enricher.enrich_entities(nodes)
# {
#     "45.33.2.1": {"risk_score": 90, "tags": ["C2", "Botnet"], "is_malicious": True},
#     "192.168.1.5": {"risk_score": 0, "tags": ["internal"], "is_malicious": False}
# }
```

**查询顺序：**
1. 本地自定义库（你的模拟数据）
2. AbuseIPDB API（真实情报）
3. VirusTotal API

---

#### 功能2：APT 归因 ⭐最重要

**输入：TTP ID 列表（来自组员3的Sigma检测结果）**

```python
# 组员3 检测出的 TTP 列表
detected_ttps = ["T1059.001", "T1105", "T1005", "T1566.001"]

# APT 归因
result = enricher.attribute_by_ttps(detected_ttps)

print(result["suspected_group"])  # "Gamaredon Group"
print(result["confidence"])       # 0.72 (72%)
print(result["matched_ttps"])     # ["T1059.001", "T1105", ...]
```

**返回结果：**
```python
{
    "suspected_group": "Gamaredon Group",   # 疑似 APT 组织
    "confidence": 0.72,                      # 置信度 (0-1)
    "matched_ttps": ["T1059.001", "T1105"], # 匹配上的 TTP
    "top_matches": [                         # Top N 匹配
        {"group": "Gamaredon Group", "score": 0.72},
        {"group": "Sandworm Team", "score": 0.71},
        {"group": "APT41", "score": 0.70}
    ]
}
```

**匹配算法：**
- 计算观测到的 TTP 与每个 APT 组织已知 TTP 的重叠率
- 使用加权公式：`score = 0.3 * Jaccard相似度 + 0.7 * 召回率`
- 召回率 = 观测TTP中有多少在该组织TTP库中

---

### 3.6 ProvenanceSystem - 溯源系统主控

**主入口，整合以上所有组件。**

```python
from analyzer.attack_analyzer.context_engine import ContextEngine
from analyzer.graph_analyzer.provenance_system import ProvenanceSystem

# 初始化
context_engine = ContextEngine(es_client)
system = ProvenanceSystem(context_engine)

# 从种子事件重建攻击路径
result = system.rebuild_attack_path(seed_event, time_window=60)

# 结果包含
print(result["nodes"])           # 攻击图节点
print(result["edges"])           # 攻击图边
print(result["path_signature"])  # 攻击链签名
print(result["intelligence"])    # 情报富化结果
```

---

## 4. 完整使用示例

### 4.1 标准使用流程

```python
from analyzer.attack_analyzer.context_engine import ContextEngine
from analyzer.graph_analyzer.provenance_system import ProvenanceSystem
from analyzer.graph_analyzer.enrichment import IntelEnricher
from collector.common.es_client import ESClient

# ====== 初始化 ======
es_client = ESClient()
context_engine = ContextEngine(es_client)
system = ProvenanceSystem(context_engine)
enricher = IntelEnricher()

# ====== 步骤1: 获取种子事件 ======
time_range = ("2026-01-14T00:00:00Z", "2026-01-14T23:59:59Z")
seeds = context_engine.get_seed_events(time_range, min_score=70)

# ====== 步骤2: 溯源重建 ======
for seed in seeds:
    result = system.rebuild_attack_path(seed)
    
    # ====== 步骤3: APT归因 ======
    # 假设组员3已经检测出 TTP
    detected_ttps = ["T1059.001", "T1105", "T1005"]
    attribution = enricher.attribute_by_ttps(detected_ttps)
    
    print(f"疑似APT: {attribution['suspected_group']}")
    print(f"置信度: {attribution['confidence']:.0%}")
    
    # ====== 步骤4: 输出报告 ======
    print(system.explain_path(result))
```

### 4.2 单独使用 APT 归因

```python
from analyzer.graph_analyzer.enrichment import IntelEnricher

enricher = IntelEnricher()

# 组员3 Sigma 检测出的 TTP
ttps = ["T1059.001", "T1105", "T1005", "T1566.001", "T1027"]

# 归因
result = enricher.attribute_by_ttps(ttps)

print(f"疑似组织: {result['suspected_group']}")
print(f"置信度: {result['confidence']:.0%}")
print(f"匹配TTP: {result['matched_ttps']}")
print(f"\nTop 3 候选:")
for m in result['top_matches'][:3]:
    print(f"  - {m['group']}: {m['score']:.0%}")
```

### 4.3 查询 MITRE 数据

```python
from analyzer.graph_analyzer.enrichment import IntelEnricher

enricher = IntelEnricher()

# 查询 APT 组织信息
apt28 = enricher.get_mitre_apt_info("APT28")
print(f"名称: {apt28['name']}")
print(f"别名: {apt28['aliases']}")
print(f"使用技术数: {apt28['technique_count']}")

# 搜索 APT 组织
groups = enricher.search_apt_groups("China")
print(f"找到 {len(groups)} 个相关组织")

# 查询使用某技术的组织
groups = enricher.get_groups_using_technique("T1059.001")
print(f"{len(groups)} 个组织使用 PowerShell")
```

---

## 5. 输出数据结构

### 5.1 溯源结果结构

```python
{
    # ========== 攻击图 ==========
    "nodes": [
        {
            "id": "a1b2c3d4...",        # MD5 节点ID
            "type": "process",           # 节点类型
            "label": "curl",             # 显示名称
            "atlas_label": "SUSPICIOUS_DOWNLOADER",  # 语义标签
            "properties": {...}
        }
    ],
    
    "edges": [
        {
            "source": "a1b2c3d4...",
            "target": "e5f6g7h8...",
            "relation": "spawned",
            "timestamp": "2026-01-14T14:30:15Z"
        }
    ],
    
    # ========== 攻击链签名 ==========
    "path_signature": "SHELL_EXECUTION -> SUSPICIOUS_DOWNLOADER -> TEMP_FILE_ACCESS",
    
    # ========== 情报富化 ==========
    "intelligence": {
        "chain_hash": "e3b0c44298fc1c...",  # 攻击链指纹
        
        "attribution": {                     # APT归因
            "suspected_group": "APT28",
            "similarity_score": 0.72,
            "source": "mitre_ttp"
        },
        
        "external_infrastructure": {         # IOC情报
            "45.33.2.1": {
                "risk_score": 90,
                "tags": ["C2", "Botnet"],
                "is_malicious": true
            }
        }
    },
    
    # ========== 统计 ==========
    "stats": {
        "events_processed": 23,
        "edges_created": 18,
        "nodes_visited": 23
    }
}
```

---

## 6. 常见问题

### Q1: APT 归因用什么输入？

**答：用 TTP ID（如 T1059.001），来自组员3的Sigma检测结果。**

```python
# 正确用法
enricher.attribute_by_ttps(["T1059.001", "T1105", "T1005"])
```

### Q2: ATLAS 标签还有用吗？

**答：有，但只用于可视化展示，不参与 APT 归因。**

### Q3: MITRE 数据放在哪里？

**答：放在 `TraceX/attack-stix-data/` 目录下，代码会自动检测。**

```bash
cd TraceX
git clone https://github.com/mitre-attack/attack-stix-data.git
```

### Q4: 情报查询顺序是什么？

**IOC富化：** 本地自定义 → AbuseIPDB → VirusTotal

**APT归因：** 本地剧本 → 真实MITRE数据

---

## 7. 附录：名词解释

| 术语 | 解释 |
|------|------|
| **IOC** | Indicator of Compromise，失陷指标（恶意IP、域名、哈希） |
| **TTP** | Tactics, Techniques, Procedures，战术技术程序 |
| **APT** | Advanced Persistent Threat，高级持续性威胁组织 |
| **MITRE ATT&CK** | 攻击知识库框架，收录了真实APT组织的攻击技术 |
| **ATLAS** | 本系统的语义标签体系，用于可视化 |
| **BFS** | Breadth-First Search，广度优先搜索算法 |

---

*文档结束*
