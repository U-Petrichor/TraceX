# 第 1 页：模块定位（过渡页，非常重要）

## 页标题
**网络侧日志采集与威胁情报增强**

## 本页目的
👉 把老师从「主机」视角，自然引导到「网络 + 外部攻击者」

## 核心功能定位
**核心目标：** 将网络行为直接转化为可关联、可溯源的攻击事件。

**子系统构成：**
*   **Zeek (NTA)**：
    *   负责全流量深度分析，监控 DNS, ICMP, SSL/TLS, HTTP 及文件传输。
    *   采用 JSON 结构化日志输出，便于下游处理。
*   **Cowrie (Honeypot)**：
    *   部署高交互 SSH 蜜罐，诱捕攻击者。
    *   核心价值在于捕获完整的攻击交互会话 (`session_id`)。

**数据流向：**
Zeek/Cowrie Logs -> Python Parser -> Elasticsearch -> Graph Builder

## 演讲提示词
“前面介绍的是主机内部发生了什么，
接下来这一部分，我们关注的是——
**攻击是如何从网络进入系统的，以及攻击者在网络侧做了什么。**
我们部署了 Zeek 进行全流量分析，并使用 Cowrie 蜜罐作为诱捕探针。”

---

# 第 2 页：Zeek —— 我们没有只做“日志搬运”

## 页标题
**Zeek 网络流量解析：检测逻辑前置**

## 核心技术亮点
**设计理念：采集即告警**
打破传统“先存储后分析”的模式，在采集端 (`flow_parser_zeek.py`) 直接集成威胁检测逻辑。

**内置实时检测逻辑 (`handle_dns` / `handle_conn`)：**
*   **DNS 隧道检测 (T1071.004)**：
    *   基于 **信息熵 (Shannon Entropy > 5.0)** 识别随机域名。
    *   基于 **域名层级 (Subdomain Depth > 7)** 和 **查询长度 (> 70 chars)** 辅助判断。
*   **ICMP 隧道检测 (T1071.004)**：
    *   监控 ICMP Payload 大小，超过 800 bytes 即视为异常（标准 Ping 包通常较小）。
*   **弱加密协商检测 (T1573)**：
    *   实时识别并告警不安全的 SSL/TLS 版本 (`SSLv2`, `SSLv3`, `TLSv1.0`)。
*   **ATT&CK 映射**：
    *   自动填充威胁标签 (`threat.technique.id`) 和检测等级 (`detection.severity`)。

## 演讲提示词
“我们这里一个比较明显的设计取向是：
**把检测逻辑前置到采集端。**

Zeek 不再只是日志生成器，而是直接产出‘高价值安全事件’。
比如我们在解析 DNS 日志时，代码里硬编码了检测阈值：一旦域名熵值大于 5.0 且子域名层级超过 7 层，解析器会直接打上 'DNS Tunneling' 的标签，而不是等数据进了数据库再分析。”

---

# 第 3 页：Zeek 的工程取舍（The Bad，但要讲得聪明）

## 页标题
**Zeek 集成的工程取舍与局限**

⚠️ *这一页是老师最爱听的，一定要讲*

## 工程取舍分析

### 优势 (The Good)
*   **节点关联增强**：
    *   代码强制注入 `host.name` (`socket.gethostname()`)。
    *   **价值**：确保网络事件能直接挂载到主机节点，避免在攻击图谱中出现“孤立网络节点”。
*   **高实时性**：
    *   配置极短的刷新间隔 (`flush_interval = 2s`)，保证攻击发生后秒级入库。

### 局限 (The Bad)
*   **方向判断简化**：
    *   HTTP 流量方向硬编码为 `outbound`，基于大部分为外连的假设。
*   **配置灵活性不足**：
    *   日志路径采用硬编码 (`/root/TraceX/data/zeek-logs`)，依赖 Docker 挂载卷的一致性，未实现动态配置加载。

## 演讲提示词
“这里我们是有意识地做了简化。
在课程项目时间限制下，我们优先保证 **‘事件能被正确关联’**，
即所有的网络流量都能通过 `hostname` 找到它的‘宿主’。

至于方向判断和路径配置的硬编码，这些本质上是**工程问题**，而不是**能力问题**。我们选择优先解决核心的数据流转问题。”

---

# 第 4 页：Cowrie —— 从“命令日志”到“攻击意图”

## 页标题
**蜜罐情报解析：攻击行为语义化**

## 解析逻辑对比
*   **传统蜜罐**：仅记录原始命令字符串（如 `ls`, `pwd`），依赖人工事后分析。
*   **TraceX 实现**：在 Parser 中集成语义分析引擎，将命令序列实时转化为攻击意图。

## 核心语义映射 (`_analyze_command`)
*   **工具下载 (Ingress Tool Transfer - T1105)**
    *   特征词：`curl`, `wget`
    *   威胁等级：**Severity 8**
*   **账户发现 (Account Discovery - T1087)**
    *   特征词：`/etc/passwd`, `/etc/shadow`, `whoami`
    *   威胁等级：**Severity 7**
*   **痕迹清除 (Indicator Removal - T1070)**
    *   特征词：`rm`, `mv`, `chmod`
    *   威胁等级：**Severity 6**

## 演讲提示词
“我们希望老师看到的不是
‘黑客敲了哪些命令’，
而是 **‘黑客在这个阶段想干什么’**。

我们的 Parser 内部维护了一个语义映射表，自动把 `wget` 识别为 T1105 工具下载，把 `rm` 识别为痕迹清除。这为后端的攻击图谱生成提供了直接的语义支撑。”

---

# 第 5 页：Cowrie 的取舍与系统态度（收束）

## 页标题
**蜜罐系统的设计取舍与整体评价**

## 系统评价

### 系统优势
*   **全链路溯源**：
    *   `session_id` 贯穿全流程，能够完整重建单一攻击者的所有操作序列。
*   **高信噪比**：
    *   通过语义分析进行降噪，只输出具有明确攻击意图的行为，利于图谱构建。

### 系统局限
*   **基于白名单的过滤**：
    *   代码逻辑仅放行核心事件 (`login`, `command.input`, `file_download`)。
    *   **代价**：可能丢失非典型探测行为（如 SFTP 尝试）。
*   **静态评分机制**：
    *   依赖规则匹配进行评分，缺乏跨事件的累积风险评估能力。

## 最终总结句（可直接念）
“总体而言，网络侧模块的设计目标不是‘全面’，
而是 **‘高价值、可关联、可解释’**。

在课程项目约束下，我们优先服务于 **攻击链重建和图谱分析** 的整体目标。”
