# æ¶æ„æ”»å‡»è¡Œä¸ºæº¯æºåˆ†æç³»ç»Ÿ - é¡¹ç›®å¼€å‘æŒ‡å¯¼ä¹¦

## ğŸ“š ç›®å½•

1. [é¢˜ç›®è¦æ±‚ä¸åŸé¡¹ç›®å¯¹æ¯”](#ã€‡é¢˜ç›®è¦æ±‚ä¸åŸé¡¹ç›®å¯¹æ¯”)
2. [é¡¹ç›®æ¶æ„è®¾è®¡](#ä¸€é¡¹ç›®æ¶æ„è®¾è®¡)
3. [ç¯å¢ƒæ–¹æ¡ˆ](#äºŒç¯å¢ƒæ–¹æ¡ˆæ¨è)
4. [5 äººåˆ†å·¥æ–¹æ¡ˆ](#ä¸‰5-äººåˆ†å·¥æ–¹æ¡ˆ)
5. [ç»Ÿä¸€æ¥å£è§„èŒƒï¼ˆæ ¸å¿ƒï¼‰](#å››ç»Ÿä¸€æ¥å£è§„èŒƒæ ¸å¿ƒ)
6. [å„ç»„å‘˜è¯¦ç»†ä»»åŠ¡](#äº”å„ç»„å‘˜è¯¦ç»†ä»»åŠ¡)
7. [é¡¹ç›®ç›®å½•ç»“æ„](#å…­é¡¹ç›®ç›®å½•ç»“æ„æœ€ç»ˆ)
8. [å…¬å…±æ¨¡å—ä»£ç ](#ä¸ƒå…¬å…±æ¨¡å—ä»£ç æ‰€æœ‰äººä½¿ç”¨)
9. [4 å¤©æ—¶é—´å®‰æ’](#å…«4-å¤©æ—¶é—´å®‰æ’)
10. [åä½œå¼€å‘å»ºè®®](#ä¹åä½œå¼€å‘å»ºè®®)
11. [å¿«é€Ÿå¼€å§‹å‘½ä»¤](#åå¿«é€Ÿå¼€å§‹å‘½ä»¤)

---

## ã€‡ã€é¢˜ç›®è¦æ±‚ä¸åŸé¡¹ç›®å¯¹æ¯”

### 0.1 é¢˜ç›®è¦æ±‚åˆ†æ

æ ¹æ®è€å¸ˆçš„é¢˜ç›®è¦æ±‚ï¼Œç³»ç»Ÿéœ€è¦å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼š

| åºå· | é¢˜ç›®è¦æ±‚ | å¯¹åº”åŠŸèƒ½ |
|------|----------|----------|
| 1 | ä¸»æœºæ—¥å¿—é‡‡é›†ä¸åˆ†æ | æ—¥å¿—æ—¶é—´åºåˆ—å¯¹é½ã€æ—¥å¿—èŒƒå¼è§£æã€å…³é”®ä¿¡æ¯æå–ã€ç™»å½•ä¼šè¯é‡å»º |
| 2 | ä¸»æœºè¡Œä¸ºç›‘æ§ | ç³»ç»Ÿè°ƒç”¨æ‹¦æˆªã€è¿›ç¨‹è¡Œä¸ºé“¾åˆ†æã€æ–‡ä»¶æ“ä½œç›‘æ§ã€å†…å­˜è¡Œä¸ºåˆ†æ |
| 3 | ç½‘ç»œæµé‡åˆ†æ | æµé‡æ•è·ä¸è§£æã€å¼‚å¸¸åè®®è¡Œä¸ºå»ºæ¨¡ã€ç½‘ç»œä¼šè¯é‡å»ºã€éšè”½ä¿¡é“æ£€æµ‹ |
| 4 | ATT&CK æ”»å‡»é“¾è¯†åˆ« | äº‹ä»¶æ˜ å°„åˆ° ATT&CK é˜¶æ®µã€æ”»å‡»æŠ€æœ¯å…³è”ã€APT ç»„ç»‡åŒ¹é… |
| 5 | æ—¶é—´çº¿å…³è”åˆ†æ | æ—¶é—´çª—å£èšåˆã€äº‹ä»¶å› æœå…³ç³»æ¨æ–­ã€æ”»å‡»é˜¶æ®µæ¨¡å¼è¯†åˆ« |
| 6 | å®ä½“å…³ç³»å›¾æ„å»º | å®ä½“æŠ½å–ã€å®ä½“é“¾æ¥å…³ç³»å»ºç«‹ |
| 7 | æ”»å‡»è·¯å¾„é‡å»º | åˆå§‹å…¥ä¾µç‚¹è¯†åˆ«ã€æ¨ªå‘ç§»åŠ¨è¿½è¸ªã€æƒé™æå‡åˆ†æã€æ•°æ®å¤–ä¼ è·¯å¾„ |
| 8 | æ”»å‡»è€…èº«ä»½æº¯æº | æ”»å‡»è€…æŒ‡çº¹æå–ã€C2 åŸºç¡€è®¾æ–½åˆ†æã€è¡Œä¸ºæ¨¡å¼åŒ¹é… |
| 9 | é¶åœºç¯å¢ƒ | ä¸å°‘äº 5 ä¸ªèŠ‚ç‚¹çš„æµ‹è¯•ç¯å¢ƒ |

### 0.2 åŸ GitHub é¡¹ç›®å·²æœ‰åŠŸèƒ½

åŸé¡¹ç›®ï¼ˆinteractive-honeynet-platformï¼‰å·²ç»å…·å¤‡ï¼š

| å·²æœ‰åŠŸèƒ½ | è¯´æ˜ | å¯¹åº”æ–‡ä»¶ |
|----------|------|----------|
| âœ… ELK Stack | Elasticsearch + Kibana æ•°æ®å­˜å‚¨å’Œå¯è§†åŒ– | `docker-compose.yml` |
| âœ… èœœç½éƒ¨ç½² | Cowrie, Wordpot, Glastopf ä¸‰ä¸ªèœœç½ | `docker-compose.yml` |
| âœ… æ—¥å¿—é‡‡é›† | Filebeat é‡‡é›†èœœç½æ—¥å¿— | `filebeat-*-config/` |
| âœ… æ•°æ®æ ‡å‡†åŒ– | Ingest Pipeline è½¬æ¢ä¸º ECS æ ¼å¼ | `elk_configurations/` |
| âœ… GeoIP å¯ŒåŒ– | è‡ªåŠ¨æ·»åŠ åœ°ç†ä½ç½®ä¿¡æ¯ | `elk_configurations/ingest_pipelines/` |
| âœ… è‡ªåŠ¨å°ç¦ | Python è„šæœ¬è‡ªåŠ¨å°ç¦æ¶æ„ IP | `scripts/auto_blocker.py` |
| âœ… å¨èƒæƒ…æŠ¥ | AbuseIPDB API ä¿¡èª‰æŸ¥è¯¢ | `scripts/auto_blocker.py` |

### 0.3 åŸé¡¹ç›®ç¼ºä¹çš„åŠŸèƒ½ï¼ˆéœ€è¦æ–°å¢ï¼‰

**å¯¹æ¯”é¢˜ç›®è¦æ±‚ï¼ŒåŸé¡¹ç›®ç¼ºä¹ä»¥ä¸‹åŠŸèƒ½ï¼š**

| ç¼ºä¹åŠŸèƒ½ | é¢˜ç›®è¦æ±‚ | æ–°å¢æ–¹æ¡ˆ | è´Ÿè´£ç»„å‘˜ |
|----------|----------|----------|----------|
| âŒ ä¸»æœºæ—¥å¿—é‡‡é›† | ç³»ç»Ÿæ—¥å¿—ã€è®¤è¯æ—¥å¿— | é…ç½® Auditd + Filebeat | ç»„å‘˜ 1 |
| âŒ ä¸»æœºè¡Œä¸ºç›‘æ§ | ç³»ç»Ÿè°ƒç”¨ã€è¿›ç¨‹ç›‘æ§ | é…ç½® Auditd è§„åˆ™ | ç»„å‘˜ 1 |
| âŒ ç½‘ç»œæµé‡åˆ†æ | æµé‡æ•è·ã€åè®®è§£æ | éƒ¨ç½² Zeek | ç»„å‘˜ 2 |
| âŒ éšè”½ä¿¡é“æ£€æµ‹ | DNS/HTTP/ICMP éš§é“ | å¼€å‘æ£€æµ‹æ¨¡å— | ç»„å‘˜ 2 |
| âŒ ATT&CK æ˜ å°„ | æ”»å‡»æŠ€æœ¯è¯†åˆ« | å¼€å‘æ˜ å°„è§„åˆ™å¼•æ“ | ç»„å‘˜ 3 |
| âŒ æ—¶é—´çº¿å…³è” | äº‹ä»¶å› æœå…³ç³» | å¼€å‘å…³è”åˆ†ææ¨¡å— | ç»„å‘˜ 3 |
| âŒ å®ä½“å…³ç³»å›¾ | å®ä½“æŠ½å–å’Œå…³è” | å¼€å‘å›¾æ„å»ºæ¨¡å— | ç»„å‘˜ 4 |
| âŒ æ”»å‡»è·¯å¾„é‡å»º | æ”»å‡»é˜¶æ®µè¿½è¸ª | å¼€å‘è·¯å¾„é‡å»ºæ¨¡å— | ç»„å‘˜ 4 |
| âŒ 5 èŠ‚ç‚¹é¶åœº | æ¨¡æ‹ŸçœŸå®ç¯å¢ƒ | Docker å¤šèŠ‚ç‚¹éƒ¨ç½² | ç»„å‘˜ 5 |
| âŒ æ”»å‡»æ¨¡æ‹Ÿ | æµ‹è¯•æ•°æ®ç”Ÿæˆ | ç¼–å†™æ”»å‡»è„šæœ¬ | ç»„å‘˜ 5 |

### 0.4 ä¸ºä»€ä¹ˆä¿ç•™èœœç½ï¼Ÿ

**é¢˜ç›®åŸæ–‡å¹¶æœªæ˜ç¡®è¦æ±‚èœœç½**ï¼Œä½†æˆ‘ä»¬é€‰æ‹©ä¿ç•™èœœç½çš„åŸå› ï¼š

| åŸå›  | è¯´æ˜ |
|------|------|
| **1. å¤šæºæ•°æ®** | é¢˜ç›®è¦æ±‚"å¤šæºæ•°æ®é‡‡é›†ä¸èåˆ"ï¼Œèœœç½æ˜¯ä¸€ç§é‡è¦çš„æ•°æ®æ¥æº |
| **2. æ¨¡æ‹Ÿæ”»å‡»** | èœœç½å¯ä»¥è®°å½•æ”»å‡»è€…çš„è¯¦ç»†è¡Œä¸ºï¼ˆå‘½ä»¤ã€å¯†ç ç­‰ï¼‰ï¼Œä¸°å¯Œæµ‹è¯•æ•°æ® |
| **3. å¤ç”¨åŸºç¡€** | åŸé¡¹ç›®çš„ ELK Stack å’Œæ•°æ®æ ‡å‡†åŒ–å·²ç»åšå¥½ï¼Œå¯ä»¥ç›´æ¥å¤ç”¨ |
| **4. æ¼”ç¤ºæ•ˆæœ** | èœœç½æ•°æ®å¯è§†åŒ–æ•ˆæœå¥½ï¼Œé€‚åˆç­”è¾©æ¼”ç¤º |

**å¦‚æœæ—¶é—´ç´§å¼ ï¼Œå¯ä»¥ç®€åŒ–èœœç½éƒ¨åˆ†ï¼š**
- åªä¿ç•™ Cowrieï¼ˆSSH èœœç½ï¼‰ï¼Œç§»é™¤ Wordpot å’Œ Glastopf
- èœœç½æ—¥å¿—ä½œä¸º"ç½‘ç»œå…¥ä¾µæ—¥å¿—"çš„ä¸€ç§ï¼Œèå…¥ç»Ÿä¸€åˆ†æ

### 0.5 æ–°æ—§é¡¹ç›®æ¶æ„å¯¹æ¯”

```
åŸé¡¹ç›®æ¶æ„ï¼š                          æ–°é¡¹ç›®æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èœœç½    â”‚                         â”‚  é¶åœºï¼ˆ5èŠ‚ç‚¹ï¼‰                â”‚
â”‚ Cowrie   â”‚                         â”‚  æ”»å‡»æœº/Web/DB/å†…ç½‘/åŸŸæ§      â”‚
â”‚ Wordpot  â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ Glastopf â”‚                                        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                               â”‚  å¤šæºæ•°æ®é‡‡é›†                 â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                         â”‚  ä¸»æœºæ—¥å¿— + ä¸»æœºè¡Œä¸º +        â”‚
â”‚ Filebeat â”‚                         â”‚  ç½‘ç»œæµé‡ + èœœç½æ—¥å¿—          â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                              â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ELK    â”‚                         â”‚  Elasticsearch               â”‚
â”‚ Stack    â”‚                         â”‚  (ç»Ÿä¸€å­˜å‚¨)                   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                              â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Kibana   â”‚                         â”‚  åˆ†æå¼•æ“ï¼ˆæ–°å¢ï¼‰             â”‚
â”‚ ä»ªè¡¨ç›˜   â”‚                         â”‚  ATT&CK + æ—¶é—´çº¿ + å®ä½“å›¾ +  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                         â”‚  æ”»å‡»è·¯å¾„é‡å»º                 â”‚
     â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”                                        â”‚
â”‚ è‡ªåŠ¨å°ç¦ â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Python   â”‚                         â”‚  å±•ç¤ºå±‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚  Kibana + æ”»å‡»é“¾å¯è§†åŒ–        â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸€ã€é¡¹ç›®æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¶æ„æ”»å‡»è¡Œä¸ºæº¯æºåˆ†æç³»ç»Ÿ                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    å±•ç¤ºå±‚ (Kibana + è‡ªå®šä¹‰å‰ç«¯)                    â”‚    â”‚
â”‚  â”‚  - æ”»å‡»æ—¶é—´çº¿å¯è§†åŒ–                                               â”‚    â”‚
â”‚  â”‚  - å®ä½“å…³ç³»å›¾å±•ç¤º                                                 â”‚    â”‚
â”‚  â”‚  - ATT&CK æ”»å‡»é“¾è§†å›¾                                             â”‚    â”‚
â”‚  â”‚  - æ”»å‡»è·¯å¾„é‡å»ºå±•ç¤º                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                  â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    åˆ†æå±‚ (Python åˆ†æå¼•æ“)                       â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚    â”‚
â”‚  â”‚  â”‚ ATT&CK   â”‚ â”‚ æ—¶é—´çº¿   â”‚ â”‚ å®ä½“å…³ç³» â”‚ â”‚ æ”»å‡»è·¯å¾„ â”‚           â”‚    â”‚
â”‚  â”‚  â”‚ æ˜ å°„æ¨¡å— â”‚ â”‚ å…³è”æ¨¡å— â”‚ â”‚ æ„å»ºæ¨¡å— â”‚ â”‚ é‡å»ºæ¨¡å— â”‚           â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                  â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    å­˜å‚¨å±‚ (Elasticsearch)                         â”‚    â”‚
â”‚  â”‚  - ç»Ÿä¸€æ—¥å¿—ç´¢å¼• (unified-logs-*)                                 â”‚    â”‚
â”‚  â”‚  - ç½‘ç»œæµé‡ç´¢å¼• (network-flows-*)                                â”‚    â”‚
â”‚  â”‚  - æ”»å‡»äº‹ä»¶ç´¢å¼• (attack-events-*)                                â”‚    â”‚
â”‚  â”‚  - å®ä½“å…³ç³»ç´¢å¼• (entity-relations-*)                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                  â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    é‡‡é›†å±‚ (å¤šæºæ•°æ®é‡‡é›†)                          â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚    â”‚
â”‚  â”‚  â”‚ ä¸»æœºæ—¥å¿— â”‚ â”‚ ä¸»æœºè¡Œä¸º â”‚ â”‚ ç½‘ç»œæµé‡ â”‚ â”‚ èœœç½æ—¥å¿— â”‚           â”‚    â”‚
â”‚  â”‚  â”‚ Filebeat â”‚ â”‚ Auditd   â”‚ â”‚ Zeek     â”‚ â”‚ Filebeat â”‚           â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    é¶åœºå±‚ (5 èŠ‚ç‚¹æ¨¡æ‹Ÿç¯å¢ƒ)                        â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚    â”‚
â”‚  â”‚  â”‚ æ”»å‡»æœº â”‚ â”‚ Web    â”‚ â”‚ æ•°æ®åº“ â”‚ â”‚ å†…ç½‘   â”‚ â”‚ åŸŸæ§   â”‚       â”‚    â”‚
â”‚  â”‚  â”‚ Kali   â”‚ â”‚ æœåŠ¡å™¨ â”‚ â”‚ æœåŠ¡å™¨ â”‚ â”‚ ä¸»æœº   â”‚ â”‚ æœåŠ¡å™¨ â”‚       â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€ç¯å¢ƒæ–¹æ¡ˆï¼ˆæ¨èï¼‰

### æ–¹æ¡ˆ Aï¼šç§Ÿç”¨äº‘æœåŠ¡å™¨ï¼ˆæ¨èï¼‰

**é…ç½®è¦æ±‚ï¼š**
- CPUï¼š8æ ¸+
- å†…å­˜ï¼š16GB+
- ç¡¬ç›˜ï¼š100GB SSD
- ç³»ç»Ÿï¼šUbuntu 22.04
- å…¬ç½‘ IPï¼šéœ€è¦

**æ¨èäº‘æœåŠ¡å•†ï¼š**
- é˜¿é‡Œäº‘/è…¾è®¯äº‘ï¼šæŒ‰é‡ä»˜è´¹ï¼Œ4å¤©çº¦ 50-100 å…ƒ
- AWS/Azureï¼šæœ‰å…è´¹è¯•ç”¨

**åä½œæ–¹å¼ï¼š**
```
æ‰€æœ‰äºº â†’ SSH è¿æ¥åŒä¸€å°æœåŠ¡å™¨ â†’ Git åä½œ
```

### æ–¹æ¡ˆ Bï¼šæœ¬åœ° WSL2 + è™šæ‹Ÿæœº

- æ¯äººæœ¬åœ°å¼€å‘æµ‹è¯•
- æœ€ååœ¨ä¸€å°æœºå™¨ä¸Šæ•´åˆ
- æˆæœ¬ä½ä½†åä½œå¤æ‚

**æ¨èæ–¹æ¡ˆ A**ï¼Œæˆæœ¬ä½ã€åä½œæ–¹ä¾¿ã€‚

---

## ä¸‰ã€5 äººåˆ†å·¥æ–¹æ¡ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        5 äººåˆ†å·¥                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ã€ç»„å‘˜ 1ã€‘æ•°æ®é‡‡é›†å±‚ - ä¸»æœºæ—¥å¿— + ä¸»æœºè¡Œä¸º                       â”‚
â”‚  ã€ç»„å‘˜ 2ã€‘æ•°æ®é‡‡é›†å±‚ - ç½‘ç»œæµé‡ + èœœç½æ—¥å¿—                       â”‚
â”‚  ã€ç»„å‘˜ 3ã€‘åˆ†æå¼•æ“ - ATT&CK æ˜ å°„ + æ—¶é—´çº¿å…³è”                   â”‚
â”‚  ã€ç»„å‘˜ 4ã€‘åˆ†æå¼•æ“ - å®ä½“å…³ç³»å›¾ + æ”»å‡»è·¯å¾„é‡å»º                   â”‚
â”‚  ã€ç»„å‘˜ 5ã€‘é¶åœºæ­å»º + æ”»å‡»æ¨¡æ‹Ÿ + å‰ç«¯å±•ç¤º                        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€ç»Ÿä¸€æ¥å£è§„èŒƒï¼ˆæ ¸å¿ƒï¼‰

è¿™æ˜¯æœ€é‡è¦çš„éƒ¨åˆ†ï¼Œç¡®ä¿å„æ¨¡å—å¯ä»¥ç‹¬ç«‹å¼€å‘ã€æœ€åæ— ç¼é›†æˆã€‚

### 4.0 ä»€ä¹ˆæ˜¯ API æ¥å£è§„èŒƒï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

#### 4.0.1 é€šä¿—è§£é‡Š

**API æ¥å£è§„èŒƒ** å°±åƒæ˜¯"æ¨¡å—ä¹‹é—´çš„é€šä¿¡åè®®"æˆ–"åˆåŒ"ã€‚

**ç±»æ¯”ç†è§£ï¼š**
```
æƒ³è±¡ 5 ä¸ªäººåˆä½œç›–æˆ¿å­ï¼š
- ç»„å‘˜1 è´Ÿè´£åšé—¨
- ç»„å‘˜2 è´Ÿè´£åšçª—æˆ·
- ç»„å‘˜3 è´Ÿè´£åšå¢™
- ...

å¦‚æœæ²¡æœ‰ç»Ÿä¸€è§„èŒƒï¼š
- ç»„å‘˜1 åšçš„é—¨æ˜¯ 2 ç±³é«˜
- ç»„å‘˜3 åšçš„é—¨æ´æ˜¯ 1.8 ç±³é«˜
- ç»“æœï¼šé—¨è£…ä¸è¿›å»ï¼

æœ‰äº†ç»Ÿä¸€è§„èŒƒï¼š
- è§„å®šé—¨æ´å°ºå¯¸ï¼š2 ç±³ Ã— 0.9 ç±³
- æ‰€æœ‰äººæŒ‰è§„èŒƒåš
- ç»“æœï¼šå®Œç¾å¯¹æ¥ï¼
```

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­ï¼š**
```
ç»„å‘˜1ï¼ˆé‡‡é›†å±‚ï¼‰äº§å‡ºæ•°æ® â†’ å­˜å…¥ Elasticsearch â†’ ç»„å‘˜3ï¼ˆåˆ†æå±‚ï¼‰è¯»å–æ•°æ®

å¦‚æœæ²¡æœ‰è§„èŒƒï¼š
- ç»„å‘˜1 å­˜çš„å­—æ®µå« "src_ip"
- ç»„å‘˜3 æŸ¥çš„å­—æ®µå« "source.ip"
- ç»“æœï¼šæŸ¥ä¸åˆ°æ•°æ®ï¼

æœ‰äº†è§„èŒƒï¼š
- ç»Ÿä¸€ä½¿ç”¨ "source.ip"
- ç»Ÿä¸€ä½¿ç”¨ç›¸åŒçš„æ•°æ®æ ¼å¼
- ç»“æœï¼šæ•°æ®æ— ç¼å¯¹æ¥ï¼
```

#### 4.0.2 æ¥å£è§„èŒƒçš„ä½œç”¨

| ä½œç”¨ | è¯´æ˜ |
|------|------|
| **1. è§£è€¦å¼€å‘** | æ¯ä¸ªç»„å‘˜å¯ä»¥ç‹¬ç«‹å¼€å‘ï¼Œä¸éœ€è¦ç­‰åˆ«äººå®Œæˆ |
| **2. å‡å°‘é›†æˆé—®é¢˜** | æœ€ååˆå¹¶ä»£ç æ—¶ï¼Œä¸ä¼šå‡ºç°æ•°æ®å¯¹ä¸ä¸Šçš„é—®é¢˜ |
| **3. ä¾¿äºæµ‹è¯•** | æ¯ä¸ªæ¨¡å—å¯ä»¥ç”¨æ¨¡æ‹Ÿæ•°æ®å•ç‹¬æµ‹è¯• |
| **4. ä¾¿äº AI å†™ä»£ç ** | å‘Šè¯‰ AI æ¥å£è§„èŒƒï¼Œå®ƒå°±èƒ½å†™å‡ºç¬¦åˆè§„èŒƒçš„ä»£ç  |

#### 4.0.3 æ¨¡å—é—´è°ƒç”¨å…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ¨¡å—é—´è°ƒç”¨å…³ç³»                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ã€ç»„å‘˜1ã€‘ä¸»æœºæ—¥å¿—é‡‡é›†                ã€ç»„å‘˜2ã€‘ç½‘ç»œæµé‡é‡‡é›†               â”‚
â”‚      â”‚                                    â”‚                              â”‚
â”‚      â”‚ write_event()                      â”‚ write_event()                â”‚
â”‚      â”‚ å†™å…¥æ•°æ®                           â”‚ å†™å…¥æ•°æ®                      â”‚
â”‚      â–¼                                    â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                    Elasticsearchï¼ˆå…¬å…±å­˜å‚¨ï¼‰                  â”‚       â”‚
â”‚  â”‚                    æ‰€æœ‰äººéƒ½å¾€è¿™é‡Œå­˜æ•°æ®                        â”‚       â”‚
â”‚  â”‚                    æ‰€æœ‰äººéƒ½ä»è¿™é‡Œè¯»æ•°æ®                        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚      â”‚                                    â”‚                              â”‚
â”‚      â”‚ query_events()                     â”‚ query_events()               â”‚
â”‚      â”‚ è¯»å–æ•°æ®                           â”‚ è¯»å–æ•°æ®                      â”‚
â”‚      â–¼                                    â–¼                              â”‚
â”‚  ã€ç»„å‘˜3ã€‘ATT&CK æ˜ å°„                 ã€ç»„å‘˜4ã€‘å®ä½“å…³ç³»å›¾                 â”‚
â”‚      â”‚                                    â”‚                              â”‚
â”‚      â”‚ map_to_attack()                    â”‚ build_entity_graph()         â”‚
â”‚      â”‚ æ˜ å°„æ”»å‡»                           â”‚ æ„å»ºå…³ç³»å›¾                    â”‚
â”‚      â”‚                                    â”‚                              â”‚
â”‚      â”‚ correlate_timeline()               â”‚ rebuild_attack_path()        â”‚
â”‚      â”‚ æ—¶é—´çº¿å…³è”                         â”‚ é‡å»ºæ”»å‡»è·¯å¾„                  â”‚
â”‚      â–¼                                    â–¼                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                    ã€ç»„å‘˜5ã€‘å‰ç«¯å±•ç¤º                           â”‚       â”‚
â”‚  â”‚                    è°ƒç”¨ä¸Šé¢çš„æ¥å£è·å–æ•°æ®                      â”‚       â”‚
â”‚  â”‚                    ç„¶åå±•ç¤ºåœ¨ Kibana æˆ–è‡ªå®šä¹‰ç•Œé¢              â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.0.4 æ¯ä¸ªæ¥å£çš„å«ä¹‰ï¼ˆè¯¦ç»†è¯´æ˜ï¼‰

| æ¥å£åç§° | è°å®ç° | è°è°ƒç”¨ | ä½œç”¨ |
|----------|--------|--------|------|
| `write_event()` | å…¬å…±æ¨¡å— | ç»„å‘˜1ã€ç»„å‘˜2 | æŠŠé‡‡é›†åˆ°çš„æ•°æ®å†™å…¥ Elasticsearch |
| `write_events_bulk()` | å…¬å…±æ¨¡å— | ç»„å‘˜1ã€ç»„å‘˜2 | æ‰¹é‡å†™å…¥æ•°æ®ï¼ˆæ•ˆç‡æ›´é«˜ï¼‰ |
| `query_events()` | å…¬å…±æ¨¡å— | ç»„å‘˜3ã€ç»„å‘˜4ã€ç»„å‘˜5 | ä» Elasticsearch è¯»å–æ•°æ® |
| `map_to_attack()` | ç»„å‘˜3 | ç»„å‘˜3ã€ç»„å‘˜5 | æŠŠä¸€ä¸ªäº‹ä»¶æ˜ å°„åˆ° ATT&CK æ¡†æ¶ |
| `correlate_timeline()` | ç»„å‘˜3 | ç»„å‘˜3ã€ç»„å‘˜5 | åˆ†æäº‹ä»¶ä¹‹é—´çš„æ—¶é—´å…³è” |
| `build_entity_graph()` | ç»„å‘˜4 | ç»„å‘˜4ã€ç»„å‘˜5 | æ„å»ºå®ä½“å…³ç³»å›¾ï¼ˆIPã€è¿›ç¨‹ã€æ–‡ä»¶çš„å…³ç³»ï¼‰ |
| `rebuild_attack_path()` | ç»„å‘˜4 | ç»„å‘˜4ã€ç»„å‘˜5 | é‡å»ºæ”»å‡»çš„å®Œæ•´è·¯å¾„ |

#### 4.0.5 æ¥å£è°ƒç”¨ç¤ºä¾‹

**åœºæ™¯ï¼šç»„å‘˜5 è¦åœ¨å‰ç«¯å±•ç¤ºæ”»å‡»è·¯å¾„**

```python
# ç»„å‘˜5 çš„ä»£ç 

from collector.common.es_client import ESClient  # å…¬å…±æ¨¡å—
from analyzer.attack_analyzer import TimelineCorrelator  # ç»„å‘˜3 çš„æ¨¡å—
from analyzer.graph_analyzer import AttackPathRebuilder  # ç»„å‘˜4 çš„æ¨¡å—

# 1. åˆ›å»º ES å®¢æˆ·ç«¯ï¼ˆå…¬å…±æ¨¡å—ï¼‰
es_client = ESClient()

# 2. æŸ¥è¯¢äº‹ä»¶ï¼ˆå…¬å…±æ¨¡å—ï¼‰
events = es_client.query_events(
    start_time="2024-01-01T00:00:00Z",
    end_time="2024-01-01T23:59:59Z"
)

# 3. æ—¶é—´çº¿å…³è”ï¼ˆç»„å‘˜3 çš„æ¥å£ï¼‰
correlator = TimelineCorrelator(es_client)
correlated = correlator.correlate(
    start_time="2024-01-01T00:00:00Z",
    end_time="2024-01-01T23:59:59Z"
)

# 4. é‡å»ºæ”»å‡»è·¯å¾„ï¼ˆç»„å‘˜4 çš„æ¥å£ï¼‰
rebuilder = AttackPathRebuilder()
attack_path = rebuilder.rebuild(correlated)

# 5. å±•ç¤ºç»“æœ
print(attack_path)
```

**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆéœ€è¦æ¥å£è§„èŒƒï¼šç»„å‘˜5 è°ƒç”¨äº†ç»„å‘˜3 å’Œç»„å‘˜4 çš„ä»£ç ï¼Œä½†ä»–ä»¬å¯ä»¥ç‹¬ç«‹å¼€å‘ï¼Œåªè¦éµå¾ªæ¥å£è§„èŒƒï¼**

### 4.1 æ•°æ®æ ¼å¼è§„èŒƒï¼ˆECS æ ‡å‡†ï¼‰

**æ‰€æœ‰æ•°æ®å¿…é¡»è½¬æ¢æˆä»¥ä¸‹ç»Ÿä¸€æ ¼å¼å­˜å…¥ Elasticsearchï¼š**

```python
# ç»Ÿä¸€äº‹ä»¶æ ¼å¼ï¼ˆæ‰€æœ‰æ¨¡å—å¿…é¡»éµå¾ªï¼‰
UNIFIED_EVENT_SCHEMA = {
    # === å¿…å¡«å­—æ®µ ===
    "@timestamp": "2024-01-01T10:00:00.000Z",  # ISO 8601 æ ¼å¼
    "event": {
        "id": "uuid-xxxx-xxxx",                 # äº‹ä»¶å”¯ä¸€ID
        "category": "process|network|file|authentication|...",  # äº‹ä»¶ç±»åˆ«
        "type": "start|end|info|...",          # äº‹ä»¶ç±»å‹
        "action": "process_started|file_created|...",  # å…·ä½“åŠ¨ä½œ
        "outcome": "success|failure|unknown",  # ç»“æœ
        "severity": 1-10,                       # ä¸¥é‡ç¨‹åº¦ (1-10)
        "dataset": "auditd|zeek|cowrie|...",   # æ•°æ®æ¥æº
    },
    
    # === æºä¿¡æ¯ï¼ˆæ”»å‡»è€…ï¼‰===
    "source": {
        "ip": "1.2.3.4",
        "port": 12345,
        "mac": "00:11:22:33:44:55",
        "geo": {
            "country_name": "China",
            "city_name": "Beijing",
            "location": {"lat": 39.9, "lon": 116.4}
        }
    },
    
    # === ç›®æ ‡ä¿¡æ¯ï¼ˆå—å®³è€…ï¼‰===
    "destination": {
        "ip": "5.6.7.8",
        "port": 22,
        "mac": "66:77:88:99:AA:BB"
    },
    
    # === ä¸»æœºä¿¡æ¯ ===
    "host": {
        "name": "web-server-01",
        "hostname": "web-server-01.local",
        "ip": ["192.168.1.10"],
        "os": {
            "family": "linux",
            "name": "Ubuntu",
            "version": "22.04"
        }
    },
    
    # === è¿›ç¨‹ä¿¡æ¯ ===
    "process": {
        "pid": 1234,
        "name": "bash",
        "executable": "/bin/bash",
        "command_line": "bash -c 'whoami'",
        "parent": {
            "pid": 1000,
            "name": "sshd",
            "executable": "/usr/sbin/sshd"
        },
        "user": {
            "name": "root",
            "id": "0"
        }
    },
    
    # === æ–‡ä»¶ä¿¡æ¯ ===
    "file": {
        "path": "/etc/passwd",
        "name": "passwd",
        "extension": "",
        "size": 1234,
        "hash": {
            "md5": "xxxxx",
            "sha256": "xxxxx"
        }
    },
    
    # === ç½‘ç»œä¿¡æ¯ ===
    "network": {
        "protocol": "tcp",
        "transport": "tcp",
        "application": "ssh",
        "bytes": 1234,
        "packets": 10,
        "direction": "inbound|outbound"
    },
    
    # === ç”¨æˆ·ä¿¡æ¯ ===
    "user": {
        "name": "admin",
        "id": "1000",
        "domain": "local"
    },
    
    # === ATT&CK æ˜ å°„ï¼ˆåˆ†æåå¡«å……ï¼‰===
    "threat": {
        "framework": "MITRE ATT&CK",
        "tactic": {
            "id": "TA0001",
            "name": "Initial Access"
        },
        "technique": {
            "id": "T1190",
            "name": "Exploit Public-Facing Application"
        }
    },
    
    # === åŸå§‹æ—¥å¿—ï¼ˆä¿ç•™ï¼‰===
    "message": "åŸå§‹æ—¥å¿—å†…å®¹",
    "raw": {}  # åŸå§‹ç»“æ„åŒ–æ•°æ®
}
```

### 4.2 Elasticsearch ç´¢å¼•è§„èŒƒ

```python
# ç´¢å¼•å‘½åè§„èŒƒ
INDEX_NAMES = {
    "host_logs": "unified-logs-{YYYY.MM.DD}",      # ä¸»æœºæ—¥å¿—
    "network_flows": "network-flows-{YYYY.MM.DD}", # ç½‘ç»œæµé‡
    "attack_events": "attack-events-{YYYY.MM.DD}", # æ”»å‡»äº‹ä»¶ï¼ˆåˆ†æç»“æœï¼‰
    "entity_relations": "entity-relations",         # å®ä½“å…³ç³»ï¼ˆä¸æŒ‰æ—¥æœŸåˆ†ï¼‰
    "attack_chains": "attack-chains"                # æ”»å‡»é“¾ï¼ˆä¸æŒ‰æ—¥æœŸåˆ†ï¼‰
}
```

### 4.3 API æ¥å£è§„èŒƒ

```python
# === åˆ†æå¼•æ“ API è§„èŒƒ ===

# åŸºç¡€é…ç½®
ES_HOST = "http://localhost:9200"
API_BASE_URL = "http://localhost:5000/api/v1"

# === 1. æ•°æ®å†™å…¥æ¥å£ï¼ˆé‡‡é›†å±‚è°ƒç”¨ï¼‰===

def write_event(event: dict) -> str:
    """
    å†™å…¥å•æ¡äº‹ä»¶åˆ° Elasticsearch
    
    Args:
        event: ç¬¦åˆ UNIFIED_EVENT_SCHEMA çš„äº‹ä»¶å­—å…¸
        
    Returns:
        event_id: äº‹ä»¶ID
        
    Example:
        event_id = write_event({
            "@timestamp": "2024-01-01T10:00:00.000Z",
            "event": {"category": "process", ...},
            ...
        })
    """
    pass

def write_events_bulk(events: list) -> dict:
    """
    æ‰¹é‡å†™å…¥äº‹ä»¶
    
    Args:
        events: äº‹ä»¶åˆ—è¡¨
        
    Returns:
        {"success": 100, "failed": 0}
    """
    pass

# === 2. æ•°æ®æŸ¥è¯¢æ¥å£ï¼ˆåˆ†æå±‚è°ƒç”¨ï¼‰===

def query_events(
    start_time: str,           # ISO 8601 æ ¼å¼
    end_time: str,
    category: str = None,       # äº‹ä»¶ç±»åˆ«è¿‡æ»¤
    source_ip: str = None,      # æºIPè¿‡æ»¤
    host_name: str = None,      # ä¸»æœºåè¿‡æ»¤
    size: int = 1000
) -> list:
    """
    æŸ¥è¯¢äº‹ä»¶
    
    Returns:
        äº‹ä»¶åˆ—è¡¨
    """
    pass

# === 3. ATT&CK æ˜ å°„æ¥å£ï¼ˆç»„å‘˜3å®ç°ï¼‰===

def map_to_attack(event: dict) -> dict:
    """
    å°†äº‹ä»¶æ˜ å°„åˆ° ATT&CK æ¡†æ¶
    
    Args:
        event: ç»Ÿä¸€æ ¼å¼äº‹ä»¶
        
    Returns:
        {
            "tactic": {"id": "TA0001", "name": "Initial Access"},
            "technique": {"id": "T1190", "name": "..."},
            "confidence": 0.85
        }
    """
    pass

# === 4. æ—¶é—´çº¿å…³è”æ¥å£ï¼ˆç»„å‘˜3å®ç°ï¼‰===

def correlate_timeline(
    start_time: str,
    end_time: str,
    time_window: int = 300      # æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
) -> list:
    """
    æ—¶é—´çº¿å…³è”åˆ†æ
    
    Returns:
        [
            {
                "timestamp": "...",
                "events": [...],
                "correlation_score": 0.9
            }
        ]
    """
    pass

# === 5. å®ä½“å…³ç³»å›¾æ¥å£ï¼ˆç»„å‘˜4å®ç°ï¼‰===

def build_entity_graph(
    start_time: str,
    end_time: str
) -> dict:
    """
    æ„å»ºå®ä½“å…³ç³»å›¾
    
    Returns:
        {
            "nodes": [
                {"id": "ip:1.2.3.4", "type": "ip", "label": "1.2.3.4"},
                {"id": "process:bash", "type": "process", "label": "bash"},
                ...
            ],
            "edges": [
                {"source": "ip:1.2.3.4", "target": "process:bash", "relation": "created"},
                ...
            ]
        }
    """
    pass

# === 6. æ”»å‡»è·¯å¾„é‡å»ºæ¥å£ï¼ˆç»„å‘˜4å®ç°ï¼‰===

def rebuild_attack_path(
    start_time: str,
    end_time: str,
    source_ip: str = None
) -> dict:
    """
    é‡å»ºæ”»å‡»è·¯å¾„
    
    Returns:
        {
            "attack_id": "uuid-xxx",
            "stages": [
                {
                    "stage": "initial_access",
                    "timestamp": "...",
                    "events": [...],
                    "description": "æ”»å‡»è€…é€šè¿‡ SSH æš´åŠ›ç ´è§£è·å¾—åˆå§‹è®¿é—®"
                },
                {
                    "stage": "lateral_movement",
                    ...
                }
            ],
            "attacker_profile": {
                "source_ips": ["1.2.3.4"],
                "tools_used": ["hydra", "mimikatz"],
                "ttps": [...]
            }
        }
    """
    pass
```

### 4.4 æ¨¡å—é—´è°ƒç”¨æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ¨¡å—é—´è°ƒç”¨æµç¨‹                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚  é‡‡é›†å±‚æ¨¡å—   â”‚                                                        â”‚
â”‚  â”‚ (ç»„å‘˜1, 2)   â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚         â”‚ write_event() / write_events_bulk()                           â”‚
â”‚         â–¼                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                    Elasticsearch                              â”‚       â”‚
â”‚  â”‚                 (ç»Ÿä¸€æ•°æ®å­˜å‚¨)                                 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚ query_events()                                                â”‚
â”‚         â–¼                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚  â”‚  ATT&CKæ˜ å°„   â”‚â”€â”€â”€â”€â–¶â”‚  æ—¶é—´çº¿å…³è”   â”‚                                  â”‚
â”‚  â”‚  (ç»„å‘˜3)      â”‚     â”‚  (ç»„å‘˜3)      â”‚                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚                              â”‚                                           â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚         â–¼                    â–¼                    â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚  å®ä½“å…³ç³»å›¾   â”‚     â”‚  æ”»å‡»è·¯å¾„     â”‚     â”‚  æ”»å‡»é“¾       â”‚            â”‚
â”‚  â”‚  (ç»„å‘˜4)      â”‚     â”‚  é‡å»º(ç»„å‘˜4)  â”‚     â”‚  å±•ç¤º(ç»„å‘˜5)  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äº”ã€å„ç»„å‘˜è¯¦ç»†ä»»åŠ¡

### ç»„å‘˜ 1ï¼šä¸»æœºæ—¥å¿— + ä¸»æœºè¡Œä¸ºé‡‡é›†

**ä»»åŠ¡ï¼š**
1. é…ç½® Auditd é‡‡é›† Linux ç³»ç»Ÿè°ƒç”¨
2. é…ç½® Filebeat é‡‡é›†ç³»ç»Ÿæ—¥å¿—
3. å¼€å‘æ—¥å¿—è§£æ Pipelineï¼ˆè½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼ï¼‰
4. å®ç° `write_event()` æ¥å£

**äº¤ä»˜ç‰©ï¼š**
```
collector/
â”œâ”€â”€ host_collector/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ auditd_config.py      # Auditd é…ç½®
â”‚   â”œâ”€â”€ filebeat_config.py    # Filebeat é…ç½®
â”‚   â”œâ”€â”€ log_parser.py         # æ—¥å¿—è§£æå™¨
â”‚   â””â”€â”€ pipeline/
â”‚       â”œâ”€â”€ auditd_pipeline.json    # Auditd Pipeline
â”‚       â””â”€â”€ syslog_pipeline.json    # Syslog Pipeline
â””â”€â”€ tests/
    â””â”€â”€ test_host_collector.py
```

**å…³é”®ä»£ç æ¨¡æ¿ï¼š**

```python
# collector/host_collector/log_parser.py

from datetime import datetime
import uuid

class HostLogParser:
    """ä¸»æœºæ—¥å¿—è§£æå™¨"""
    
    def parse_auditd_log(self, raw_log: dict) -> dict:
        """
        å°† Auditd æ—¥å¿—è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼
        
        Args:
            raw_log: Auditd åŸå§‹æ—¥å¿—
            
        Returns:
            ç¬¦åˆ UNIFIED_EVENT_SCHEMA çš„å­—å…¸
        """
        return {
            "@timestamp": datetime.utcnow().isoformat() + "Z",
            "event": {
                "id": str(uuid.uuid4()),
                "category": self._map_category(raw_log.get("type")),
                "type": "info",
                "action": raw_log.get("type", "unknown"),
                "outcome": "success" if raw_log.get("success") == "yes" else "failure",
                "severity": 5,
                "dataset": "auditd"
            },
            "source": {
                "ip": raw_log.get("addr", ""),
            },
            "host": {
                "name": raw_log.get("hostname", ""),
            },
            "process": {
                "pid": int(raw_log.get("pid", 0)),
                "name": raw_log.get("comm", ""),
                "executable": raw_log.get("exe", ""),
                "command_line": raw_log.get("proctitle", ""),
                "user": {
                    "name": raw_log.get("auid_user", ""),
                    "id": raw_log.get("auid", "")
                }
            },
            "file": {
                "path": raw_log.get("name", ""),
            },
            "user": {
                "name": raw_log.get("auid_user", ""),
                "id": raw_log.get("auid", "")
            },
            "message": str(raw_log),
            "raw": raw_log
        }
    
    def _map_category(self, audit_type: str) -> str:
        """æ˜ å°„ Auditd ç±»å‹åˆ° ECS ç±»åˆ«"""
        mapping = {
            "SYSCALL": "process",
            "EXECVE": "process",
            "PATH": "file",
            "USER_LOGIN": "authentication",
            "USER_AUTH": "authentication",
            "SOCKADDR": "network",
        }
        return mapping.get(audit_type, "host")
```

---

### ç»„å‘˜ 2ï¼šç½‘ç»œæµé‡ + èœœç½æ—¥å¿—é‡‡é›†

**ä»»åŠ¡ï¼š**
1. é…ç½® Zeek æ•è·ç½‘ç»œæµé‡
2. é…ç½®ç°æœ‰èœœç½ï¼ˆCowrie, Wordpot, Glastopfï¼‰
3. å¼€å‘æµé‡è§£æ Pipeline
4. å®ç°éšè”½ä¿¡é“æ£€æµ‹ï¼ˆç®€åŒ–ç‰ˆï¼šDNS å¼‚å¸¸æ£€æµ‹ï¼‰

**äº¤ä»˜ç‰©ï¼š**
```
collector/
â”œâ”€â”€ network_collector/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ zeek_config.py        # Zeek é…ç½®
â”‚   â”œâ”€â”€ flow_parser.py        # æµé‡è§£æå™¨
â”‚   â”œâ”€â”€ dns_tunnel_detector.py # DNS éš§é“æ£€æµ‹
â”‚   â””â”€â”€ pipeline/
â”‚       â”œâ”€â”€ zeek_pipeline.json
â”‚       â””â”€â”€ cowrie_pipeline.json
â””â”€â”€ tests/
    â””â”€â”€ test_network_collector.py
```

**å…³é”®ä»£ç æ¨¡æ¿ï¼š**

```python
# collector/network_collector/flow_parser.py

class NetworkFlowParser:
    """ç½‘ç»œæµé‡è§£æå™¨"""
    
    def parse_zeek_conn(self, raw_log: dict) -> dict:
        """å°† Zeek conn.log è½¬æ¢ä¸ºç»Ÿä¸€æ ¼å¼"""
        return {
            "@timestamp": raw_log.get("ts", datetime.utcnow().isoformat() + "Z"),
            "event": {
                "id": str(uuid.uuid4()),
                "category": "network",
                "type": "connection",
                "action": "network_flow",
                "outcome": "success",
                "severity": 3,
                "dataset": "zeek.conn"
            },
            "source": {
                "ip": raw_log.get("id.orig_h", ""),
                "port": raw_log.get("id.orig_p", 0),
            },
            "destination": {
                "ip": raw_log.get("id.resp_h", ""),
                "port": raw_log.get("id.resp_p", 0),
            },
            "network": {
                "protocol": raw_log.get("proto", ""),
                "transport": raw_log.get("proto", ""),
                "application": raw_log.get("service", ""),
                "bytes": raw_log.get("orig_bytes", 0) + raw_log.get("resp_bytes", 0),
                "packets": raw_log.get("orig_pkts", 0) + raw_log.get("resp_pkts", 0),
                "direction": "inbound"
            },
            "message": str(raw_log),
            "raw": raw_log
        }

# collector/network_collector/dns_tunnel_detector.py

class DNSTunnelDetector:
    """DNS éš§é“æ£€æµ‹å™¨"""
    
    def detect(self, dns_log: dict) -> dict:
        """
        æ£€æµ‹ DNS éš§é“
        
        æ£€æµ‹è§„åˆ™ï¼š
        1. æŸ¥è¯¢åŸŸåé•¿åº¦å¼‚å¸¸ï¼ˆ>50å­—ç¬¦ï¼‰
        2. å­åŸŸåå±‚çº§å¼‚å¸¸ï¼ˆ>5çº§ï¼‰
        3. é«˜ç†µå€¼åŸŸåï¼ˆéšæœºå­—ç¬¦ä¸²ï¼‰
        """
        query = dns_log.get("query", "")
        
        is_suspicious = False
        reasons = []
        
        # è§„åˆ™1ï¼šé•¿åº¦æ£€æµ‹
        if len(query) > 50:
            is_suspicious = True
            reasons.append(f"åŸŸåé•¿åº¦å¼‚å¸¸: {len(query)}")
        
        # è§„åˆ™2ï¼šå­åŸŸåå±‚çº§
        parts = query.split(".")
        if len(parts) > 5:
            is_suspicious = True
            reasons.append(f"å­åŸŸåå±‚çº§è¿‡æ·±: {len(parts)}")
        
        # è§„åˆ™3ï¼šç†µå€¼æ£€æµ‹
        entropy = self._calculate_entropy(query)
        if entropy > 4.0:
            is_suspicious = True
            reasons.append(f"é«˜ç†µå€¼åŸŸå: {entropy:.2f}")
        
        return {
            "is_suspicious": is_suspicious,
            "reasons": reasons,
            "query": query,
            "entropy": entropy
        }
    
    def _calculate_entropy(self, s: str) -> float:
        """è®¡ç®—å­—ç¬¦ä¸²ç†µå€¼"""
        from collections import Counter
        import math
        
        if not s:
            return 0
        
        counter = Counter(s)
        length = len(s)
        entropy = -sum((count/length) * math.log2(count/length) 
                       for count in counter.values())
        return entropy
```

---

### ç»„å‘˜ 3ï¼šATT&CK æ˜ å°„ + æ—¶é—´çº¿å…³è”

**ä»»åŠ¡ï¼š**
1. å®ç° ATT&CK æ¡†æ¶æ˜ å°„è§„åˆ™
2. å®ç°æ—¶é—´çº¿å…³è”åˆ†æ
3. å®ç°äº‹ä»¶å› æœå…³ç³»æ¨æ–­

**äº¤ä»˜ç‰©ï¼š**
```
analyzer/
â”œâ”€â”€ attack_analyzer/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ attack_mapper.py      # ATT&CK æ˜ å°„
â”‚   â”œâ”€â”€ attack_rules.py       # æ˜ å°„è§„åˆ™åº“
â”‚   â”œâ”€â”€ timeline_correlator.py # æ—¶é—´çº¿å…³è”
â”‚   â””â”€â”€ causality_analyzer.py  # å› æœå…³ç³»åˆ†æ
â””â”€â”€ tests/
    â””â”€â”€ test_attack_analyzer.py
```

**å…³é”®ä»£ç æ¨¡æ¿ï¼š**

```python
# analyzer/attack_analyzer/attack_rules.py

# ATT&CK æ˜ å°„è§„åˆ™åº“
ATTACK_RULES = [
    # === åˆå§‹è®¿é—® (TA0001) ===
    {
        "id": "rule_001",
        "name": "SSH æš´åŠ›ç ´è§£",
        "tactic": {"id": "TA0001", "name": "Initial Access"},
        "technique": {"id": "T1110", "name": "Brute Force"},
        "conditions": {
            "event.category": "authentication",
            "event.outcome": "failure",
            "network.application": "ssh"
        },
        "threshold": {
            "count": 5,           # 5æ¬¡ä»¥ä¸Š
            "time_window": 60     # 60ç§’å†…
        }
    },
    {
        "id": "rule_002",
        "name": "Web åº”ç”¨æ¼æ´åˆ©ç”¨",
        "tactic": {"id": "TA0001", "name": "Initial Access"},
        "technique": {"id": "T1190", "name": "Exploit Public-Facing Application"},
        "conditions": {
            "event.category": "network",
            "network.application": ["http", "https"],
            "url.path": ["*eval*", "*exec*", "*cmd*", "*shell*"]
        }
    },
    
    # === æ‰§è¡Œ (TA0002) ===
    {
        "id": "rule_003",
        "name": "å‘½ä»¤è¡Œæ‰§è¡Œ",
        "tactic": {"id": "TA0002", "name": "Execution"},
        "technique": {"id": "T1059", "name": "Command and Scripting Interpreter"},
        "conditions": {
            "event.category": "process",
            "process.name": ["bash", "sh", "python", "perl", "powershell"]
        }
    },
    
    # === æŒä¹…åŒ– (TA0003) ===
    {
        "id": "rule_004",
        "name": "Cron åé—¨",
        "tactic": {"id": "TA0003", "name": "Persistence"},
        "technique": {"id": "T1053", "name": "Scheduled Task/Job"},
        "conditions": {
            "event.category": "file",
            "file.path": ["/etc/cron*", "/var/spool/cron/*"]
        }
    },
    
    # === æƒé™æå‡ (TA0004) ===
    {
        "id": "rule_005",
        "name": "Sudo ææƒ",
        "tactic": {"id": "TA0004", "name": "Privilege Escalation"},
        "technique": {"id": "T1548", "name": "Abuse Elevation Control Mechanism"},
        "conditions": {
            "event.category": "process",
            "process.name": "sudo"
        }
    },
    
    # === æ¨ªå‘ç§»åŠ¨ (TA0008) ===
    {
        "id": "rule_006",
        "name": "SSH æ¨ªå‘ç§»åŠ¨",
        "tactic": {"id": "TA0008", "name": "Lateral Movement"},
        "technique": {"id": "T1021", "name": "Remote Services"},
        "conditions": {
            "event.category": "network",
            "network.application": "ssh",
            "source.ip": "internal"  # å†…ç½‘IP
        }
    },
    
    # === æ•°æ®çªƒå– (TA0010) ===
    {
        "id": "rule_007",
        "name": "æ•æ„Ÿæ–‡ä»¶è®¿é—®",
        "tactic": {"id": "TA0010", "name": "Exfiltration"},
        "technique": {"id": "T1005", "name": "Data from Local System"},
        "conditions": {
            "event.category": "file",
            "event.action": "read",
            "file.path": ["/etc/passwd", "/etc/shadow", "*.pem", "*.key"]
        }
    }
]

# analyzer/attack_analyzer/attack_mapper.py

class ATTACKMapper:
    """ATT&CK æ¡†æ¶æ˜ å°„å™¨"""
    
    def __init__(self):
        self.rules = ATTACK_RULES
    
    def map_event(self, event: dict) -> dict:
        """
        å°†å•ä¸ªäº‹ä»¶æ˜ å°„åˆ° ATT&CK æ¡†æ¶
        
        Returns:
            {
                "matched": True/False,
                "tactic": {...},
                "technique": {...},
                "rule_id": "...",
                "confidence": 0.0-1.0
            }
        """
        for rule in self.rules:
            if self._match_conditions(event, rule["conditions"]):
                return {
                    "matched": True,
                    "tactic": rule["tactic"],
                    "technique": rule["technique"],
                    "rule_id": rule["id"],
                    "rule_name": rule["name"],
                    "confidence": 0.8
                }
        
        return {"matched": False}
    
    def _match_conditions(self, event: dict, conditions: dict) -> bool:
        """æ£€æŸ¥äº‹ä»¶æ˜¯å¦åŒ¹é…è§„åˆ™æ¡ä»¶"""
        for field, expected in conditions.items():
            actual = self._get_nested_field(event, field)
            
            if isinstance(expected, list):
                # åˆ—è¡¨åŒ¹é…ï¼ˆä»»æ„ä¸€ä¸ªåŒ¹é…å³å¯ï¼‰
                if not any(self._match_value(actual, e) for e in expected):
                    return False
            else:
                if not self._match_value(actual, expected):
                    return False
        
        return True
    
    def _get_nested_field(self, obj: dict, field: str):
        """è·å–åµŒå¥—å­—æ®µå€¼"""
        keys = field.split(".")
        value = obj
        for key in keys:
            if isinstance(value, dict):
                value = value.get(key)
            else:
                return None
        return value
    
    def _match_value(self, actual, expected) -> bool:
        """å€¼åŒ¹é…ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰"""
        if actual is None:
            return False
        if "*" in str(expected):
            import fnmatch
            return fnmatch.fnmatch(str(actual), expected)
        return str(actual) == str(expected)

# analyzer/attack_analyzer/timeline_correlator.py

class TimelineCorrelator:
    """æ—¶é—´çº¿å…³è”åˆ†æå™¨"""
    
    def __init__(self, es_client):
        self.es = es_client
        self.mapper = ATTACKMapper()
    
    def correlate(self, start_time: str, end_time: str, 
                  time_window: int = 300) -> list:
        """
        æ—¶é—´çº¿å…³è”åˆ†æ
        
        Args:
            start_time: å¼€å§‹æ—¶é—´
            end_time: ç»“æŸæ—¶é—´
            time_window: æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
            
        Returns:
            å…³è”äº‹ä»¶ç»„åˆ—è¡¨
        """
        # 1. æŸ¥è¯¢æ‰€æœ‰äº‹ä»¶
        events = self._query_events(start_time, end_time)
        
        # 2. æŒ‰æ—¶é—´çª—å£åˆ†ç»„
        groups = self._group_by_time_window(events, time_window)
        
        # 3. å¯¹æ¯ç»„è¿›è¡Œ ATT&CK æ˜ å°„
        correlated_groups = []
        for group in groups:
            mapped_events = []
            for event in group["events"]:
                mapping = self.mapper.map_event(event)
                if mapping["matched"]:
                    event["threat"] = mapping
                    mapped_events.append(event)
            
            if mapped_events:
                correlated_groups.append({
                    "timestamp": group["timestamp"],
                    "events": mapped_events,
                    "tactics": list(set(e["threat"]["tactic"]["name"] 
                                       for e in mapped_events)),
                    "correlation_score": len(mapped_events) / len(group["events"])
                })
        
        return correlated_groups
    
    def _group_by_time_window(self, events: list, window: int) -> list:
        """æŒ‰æ—¶é—´çª—å£åˆ†ç»„"""
        if not events:
            return []
        
        from datetime import datetime, timedelta
        
        groups = []
        current_group = {"timestamp": events[0]["@timestamp"], "events": []}
        window_start = datetime.fromisoformat(events[0]["@timestamp"].replace("Z", ""))
        
        for event in events:
            event_time = datetime.fromisoformat(event["@timestamp"].replace("Z", ""))
            
            if (event_time - window_start).total_seconds() <= window:
                current_group["events"].append(event)
            else:
                groups.append(current_group)
                current_group = {"timestamp": event["@timestamp"], "events": [event]}
                window_start = event_time
        
        if current_group["events"]:
            groups.append(current_group)
        
        return groups
```

---

### ç»„å‘˜ 4ï¼šå®ä½“å…³ç³»å›¾ + æ”»å‡»è·¯å¾„é‡å»º

**ä»»åŠ¡ï¼š**
1. å®ç°å®ä½“æŠ½å–ï¼ˆIPã€è¿›ç¨‹ã€æ–‡ä»¶ã€ç”¨æˆ·ï¼‰
2. å®ç°å®ä½“å…³ç³»å›¾æ„å»º
3. å®ç°æ”»å‡»è·¯å¾„é‡å»º
4. å®ç°æ”»å‡»è€…ç”»åƒ

**äº¤ä»˜ç‰©ï¼š**
```
analyzer/
â”œâ”€â”€ graph_analyzer/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ entity_extractor.py   # å®ä½“æŠ½å–
â”‚   â”œâ”€â”€ graph_builder.py      # å…³ç³»å›¾æ„å»º
â”‚   â”œâ”€â”€ path_rebuilder.py     # æ”»å‡»è·¯å¾„é‡å»º
â”‚   â””â”€â”€ attacker_profiler.py  # æ”»å‡»è€…ç”»åƒ
â””â”€â”€ tests/
    â””â”€â”€ test_graph_analyzer.py
```

**å…³é”®ä»£ç æ¨¡æ¿ï¼š**

```python
# analyzer/graph_analyzer/entity_extractor.py

class EntityExtractor:
    """å®ä½“æŠ½å–å™¨"""
    
    ENTITY_TYPES = ["ip", "process", "file", "user", "host"]
    
    def extract(self, event: dict) -> list:
        """
        ä»äº‹ä»¶ä¸­æŠ½å–å®ä½“
        
        Returns:
            [
                {"id": "ip:1.2.3.4", "type": "ip", "value": "1.2.3.4", "role": "source"},
                {"id": "process:bash:1234", "type": "process", "value": "bash", "pid": 1234},
                ...
            ]
        """
        entities = []
        
        # æŠ½å– IP å®ä½“
        if event.get("source", {}).get("ip"):
            entities.append({
                "id": f"ip:{event['source']['ip']}",
                "type": "ip",
                "value": event["source"]["ip"],
                "role": "source"
            })
        
        if event.get("destination", {}).get("ip"):
            entities.append({
                "id": f"ip:{event['destination']['ip']}",
                "type": "ip",
                "value": event["destination"]["ip"],
                "role": "destination"
            })
        
        # æŠ½å–è¿›ç¨‹å®ä½“
        if event.get("process", {}).get("name"):
            proc = event["process"]
            entities.append({
                "id": f"process:{proc['name']}:{proc.get('pid', 0)}",
                "type": "process",
                "value": proc["name"],
                "pid": proc.get("pid", 0),
                "executable": proc.get("executable", "")
            })
            
            # çˆ¶è¿›ç¨‹
            if proc.get("parent", {}).get("name"):
                parent = proc["parent"]
                entities.append({
                    "id": f"process:{parent['name']}:{parent.get('pid', 0)}",
                    "type": "process",
                    "value": parent["name"],
                    "pid": parent.get("pid", 0),
                    "role": "parent"
                })
        
        # æŠ½å–æ–‡ä»¶å®ä½“
        if event.get("file", {}).get("path"):
            entities.append({
                "id": f"file:{event['file']['path']}",
                "type": "file",
                "value": event["file"]["path"]
            })
        
        # æŠ½å–ç”¨æˆ·å®ä½“
        if event.get("user", {}).get("name"):
            entities.append({
                "id": f"user:{event['user']['name']}",
                "type": "user",
                "value": event["user"]["name"]
            })
        
        # æŠ½å–ä¸»æœºå®ä½“
        if event.get("host", {}).get("name"):
            entities.append({
                "id": f"host:{event['host']['name']}",
                "type": "host",
                "value": event["host"]["name"]
            })
        
        return entities

# analyzer/graph_analyzer/graph_builder.py

class EntityGraphBuilder:
    """å®ä½“å…³ç³»å›¾æ„å»ºå™¨"""
    
    def __init__(self):
        self.extractor = EntityExtractor()
        self.nodes = {}
        self.edges = []
    
    def build(self, events: list) -> dict:
        """
        æ„å»ºå®ä½“å…³ç³»å›¾
        
        Returns:
            {
                "nodes": [...],
                "edges": [...]
            }
        """
        for event in events:
            entities = self.extractor.extract(event)
            
            # æ·»åŠ èŠ‚ç‚¹
            for entity in entities:
                self.nodes[entity["id"]] = {
                    "id": entity["id"],
                    "type": entity["type"],
                    "label": entity["value"],
                    "properties": entity
                }
            
            # æ·»åŠ è¾¹ï¼ˆåŸºäºäº‹ä»¶ç±»å‹æ¨æ–­å…³ç³»ï¼‰
            self._add_edges(event, entities)
        
        return {
            "nodes": list(self.nodes.values()),
            "edges": self.edges
        }
    
    def _add_edges(self, event: dict, entities: list):
        """æ·»åŠ å®ä½“é—´çš„è¾¹"""
        entity_map = {e["type"]: e for e in entities}
        
        # IP -> è¿›ç¨‹ï¼ˆè¿æ¥åˆ›å»ºï¼‰
        if "ip" in [e.get("role") for e in entities if e["type"] == "ip"]:
            source_ip = entity_map.get("ip")
            process = entity_map.get("process")
            if source_ip and process and source_ip.get("role") == "source":
                self.edges.append({
                    "source": source_ip["id"],
                    "target": process["id"],
                    "relation": "connected_to",
                    "timestamp": event.get("@timestamp")
                })
        
        # è¿›ç¨‹ -> æ–‡ä»¶ï¼ˆè®¿é—®ï¼‰
        process = entity_map.get("process")
        file = entity_map.get("file")
        if process and file:
            self.edges.append({
                "source": process["id"],
                "target": file["id"],
                "relation": event.get("event", {}).get("action", "accessed"),
                "timestamp": event.get("@timestamp")
            })
        
        # ç”¨æˆ· -> è¿›ç¨‹ï¼ˆæ‰§è¡Œï¼‰
        user = entity_map.get("user")
        if user and process:
            self.edges.append({
                "source": user["id"],
                "target": process["id"],
                "relation": "executed",
                "timestamp": event.get("@timestamp")
            })
        
        # çˆ¶è¿›ç¨‹ -> å­è¿›ç¨‹
        for entity in entities:
            if entity.get("role") == "parent" and entity["type"] == "process":
                child = entity_map.get("process")
                if child and child["id"] != entity["id"]:
                    self.edges.append({
                        "source": entity["id"],
                        "target": child["id"],
                        "relation": "spawned",
                        "timestamp": event.get("@timestamp")
                    })

# analyzer/graph_analyzer/path_rebuilder.py

class AttackPathRebuilder:
    """æ”»å‡»è·¯å¾„é‡å»ºå™¨"""
    
    ATTACK_STAGES = [
        "initial_access",
        "execution",
        "persistence",
        "privilege_escalation",
        "defense_evasion",
        "credential_access",
        "discovery",
        "lateral_movement",
        "collection",
        "exfiltration",
        "impact"
    ]
    
    TACTIC_TO_STAGE = {
        "TA0001": "initial_access",
        "TA0002": "execution",
        "TA0003": "persistence",
        "TA0004": "privilege_escalation",
        "TA0005": "defense_evasion",
        "TA0006": "credential_access",
        "TA0007": "discovery",
        "TA0008": "lateral_movement",
        "TA0009": "collection",
        "TA0010": "exfiltration",
        "TA0040": "impact"
    }
    
    def rebuild(self, correlated_events: list, source_ip: str = None) -> dict:
        """
        é‡å»ºæ”»å‡»è·¯å¾„
        
        Args:
            correlated_events: æ—¶é—´çº¿å…³è”åçš„äº‹ä»¶
            source_ip: å¯é€‰ï¼ŒæŒ‡å®šæ”»å‡»æº IP
            
        Returns:
            æ”»å‡»è·¯å¾„ç»“æ„
        """
        # 1. è¿‡æ»¤æŒ‡å®šæº IP çš„äº‹ä»¶
        if source_ip:
            correlated_events = [
                group for group in correlated_events
                if any(e.get("source", {}).get("ip") == source_ip 
                       for e in group.get("events", []))
            ]
        
        # 2. æŒ‰æ”»å‡»é˜¶æ®µåˆ†ç»„
        stages = {}
        for group in correlated_events:
            for event in group.get("events", []):
                threat = event.get("threat", {})
                if threat.get("matched"):
                    tactic_id = threat.get("tactic", {}).get("id")
                    stage = self.TACTIC_TO_STAGE.get(tactic_id, "unknown")
                    
                    if stage not in stages:
                        stages[stage] = {
                            "stage": stage,
                            "events": [],
                            "first_seen": event["@timestamp"],
                            "last_seen": event["@timestamp"]
                        }
                    
                    stages[stage]["events"].append(event)
                    stages[stage]["last_seen"] = event["@timestamp"]
        
        # 3. æ’åºé˜¶æ®µ
        ordered_stages = []
        for stage_name in self.ATTACK_STAGES:
            if stage_name in stages:
                stage_data = stages[stage_name]
                stage_data["description"] = self._generate_stage_description(stage_data)
                ordered_stages.append(stage_data)
        
        # 4. ç”Ÿæˆæ”»å‡»è€…ç”»åƒ
        attacker_profile = self._build_attacker_profile(correlated_events)
        
        return {
            "attack_id": str(uuid.uuid4()),
            "stages": ordered_stages,
            "attacker_profile": attacker_profile,
            "total_events": sum(len(s["events"]) for s in ordered_stages),
            "duration": self._calculate_duration(ordered_stages)
        }
    
    def _generate_stage_description(self, stage: dict) -> str:
        """ç”Ÿæˆé˜¶æ®µæè¿°"""
        stage_descriptions = {
            "initial_access": "æ”»å‡»è€…è·å¾—åˆå§‹è®¿é—®æƒé™",
            "execution": "æ”»å‡»è€…æ‰§è¡Œæ¶æ„ä»£ç ",
            "persistence": "æ”»å‡»è€…å»ºç«‹æŒä¹…åŒ–æœºåˆ¶",
            "privilege_escalation": "æ”»å‡»è€…æå‡æƒé™",
            "lateral_movement": "æ”»å‡»è€…åœ¨å†…ç½‘æ¨ªå‘ç§»åŠ¨",
            "exfiltration": "æ”»å‡»è€…çªƒå–æ•°æ®"
        }
        
        base_desc = stage_descriptions.get(stage["stage"], "æœªçŸ¥é˜¶æ®µ")
        event_count = len(stage["events"])
        
        return f"{base_desc}ï¼ˆæ£€æµ‹åˆ° {event_count} ä¸ªç›¸å…³äº‹ä»¶ï¼‰"
    
    def _build_attacker_profile(self, correlated_events: list) -> dict:
        """æ„å»ºæ”»å‡»è€…ç”»åƒ"""
        source_ips = set()
        techniques = set()
        tools = set()
        
        for group in correlated_events:
            for event in group.get("events", []):
                # æ”¶é›†æº IP
                if event.get("source", {}).get("ip"):
                    source_ips.add(event["source"]["ip"])
                
                # æ”¶é›†æŠ€æœ¯
                threat = event.get("threat", {})
                if threat.get("matched"):
                    techniques.add(threat.get("technique", {}).get("name", ""))
                
                # è¯†åˆ«å·¥å…·
                process_name = event.get("process", {}).get("name", "")
                if process_name in ["nmap", "hydra", "sqlmap", "metasploit", "mimikatz"]:
                    tools.add(process_name)
        
        return {
            "source_ips": list(source_ips),
            "techniques_used": list(techniques),
            "tools_identified": list(tools)
        }
    
    def _calculate_duration(self, stages: list) -> str:
        """è®¡ç®—æ”»å‡»æŒç»­æ—¶é—´"""
        if not stages:
            return "0s"
        
        from datetime import datetime
        
        first = datetime.fromisoformat(stages[0]["first_seen"].replace("Z", ""))
        last = datetime.fromisoformat(stages[-1]["last_seen"].replace("Z", ""))
        
        duration = (last - first).total_seconds()
        
        if duration < 60:
            return f"{int(duration)}s"
        elif duration < 3600:
            return f"{int(duration/60)}m"
        else:
            return f"{int(duration/3600)}h"
```

---

### ç»„å‘˜ 5ï¼šé¶åœºæ­å»º + æ”»å‡»æ¨¡æ‹Ÿ + å‰ç«¯å±•ç¤º

**ä»»åŠ¡ï¼š**
1. æ­å»º 5 èŠ‚ç‚¹é¶åœºç¯å¢ƒ
2. ç¼–å†™æ”»å‡»æ¨¡æ‹Ÿè„šæœ¬
3. å¼€å‘å‰ç«¯å±•ç¤ºç•Œé¢ï¼ˆæˆ–é…ç½® Kibanaï¼‰
4. æ•´åˆæ‰€æœ‰æ¨¡å—

**äº¤ä»˜ç‰©ï¼š**
```
infrastructure/
â”œâ”€â”€ docker-compose.yml        # å®Œæ•´çš„ Docker Compose
â”œâ”€â”€ range/                    # é¶åœºé…ç½®
â”‚   â”œâ”€â”€ attacker/             # æ”»å‡»æœºé…ç½®
â”‚   â”œâ”€â”€ web-server/           # Web æœåŠ¡å™¨é…ç½®
â”‚   â”œâ”€â”€ db-server/            # æ•°æ®åº“æœåŠ¡å™¨é…ç½®
â”‚   â”œâ”€â”€ internal-host/        # å†…ç½‘ä¸»æœºé…ç½®
â”‚   â””â”€â”€ dc-server/            # åŸŸæ§æœåŠ¡å™¨é…ç½®
â”œâ”€â”€ attack_simulator/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ scenarios/            # æ”»å‡»åœºæ™¯
â”‚   â”‚   â”œâ”€â”€ ssh_bruteforce.py
â”‚   â”‚   â”œâ”€â”€ web_exploit.py
â”‚   â”‚   â”œâ”€â”€ lateral_movement.py
â”‚   â”‚   â””â”€â”€ data_exfil.py
â”‚   â””â”€â”€ run_scenario.py       # è¿è¡Œæ”»å‡»æ¨¡æ‹Ÿ
â””â”€â”€ frontend/
    â”œâ”€â”€ dashboard/            # Kibana ä»ªè¡¨ç›˜é…ç½®
    â””â”€â”€ visualizations/       # å¯è§†åŒ–é…ç½®
```

**å…³é”®ä»£ç æ¨¡æ¿ï¼š**

```yaml
# infrastructure/docker-compose.yml

version: '3.8'

services:
  # === ELK Stack ===
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.17.9
    container_name: es-container
    environment:
      - discovery.type=single-node
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    volumes:
      - es-data:/usr/share/elasticsearch/data
    ports:
      - "9200:9200"
    networks:
      - attack-range

  kibana:
    image: docker.elastic.co/kibana/kibana:7.17.9
    container_name: kibana-container
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch
    networks:
      - attack-range

  # === é¶åœºèŠ‚ç‚¹ ===
  
  # èŠ‚ç‚¹ 1ï¼šæ”»å‡»æœº (Kali-like)
  attacker:
    build: ./range/attacker
    container_name: attacker-node
    networks:
      attack-range:
        ipv4_address: 172.20.0.10
    cap_add:
      - NET_ADMIN
    volumes:
      - ./attack_simulator:/attack_simulator

  # èŠ‚ç‚¹ 2ï¼šWeb æœåŠ¡å™¨ (æœ‰æ¼æ´çš„ Web åº”ç”¨)
  web-server:
    build: ./range/web-server
    container_name: web-server-node
    ports:
      - "8080:80"
    networks:
      attack-range:
        ipv4_address: 172.20.0.20
    volumes:
      - web-logs:/var/log/apache2
      - ./collector:/collector

  # èŠ‚ç‚¹ 3ï¼šæ•°æ®åº“æœåŠ¡å™¨
  db-server:
    image: mysql:5.7
    container_name: db-server-node
    environment:
      - MYSQL_ROOT_PASSWORD=weak_password
      - MYSQL_DATABASE=sensitive_data
    networks:
      attack-range:
        ipv4_address: 172.20.0.30
    volumes:
      - db-logs:/var/log/mysql

  # èŠ‚ç‚¹ 4ï¼šå†…ç½‘ä¸»æœº
  internal-host:
    build: ./range/internal-host
    container_name: internal-host-node
    networks:
      attack-range:
        ipv4_address: 172.20.0.40
    volumes:
      - internal-logs:/var/log

  # èŠ‚ç‚¹ 5ï¼šåŸŸæ§æœåŠ¡å™¨ (ç®€åŒ–æ¨¡æ‹Ÿ)
  dc-server:
    build: ./range/dc-server
    container_name: dc-server-node
    networks:
      attack-range:
        ipv4_address: 172.20.0.50
    volumes:
      - dc-logs:/var/log

  # === æ•°æ®é‡‡é›† ===
  
  # Zeek ç½‘ç»œæµé‡åˆ†æ
  zeek:
    image: zeek/zeek:latest
    container_name: zeek-collector
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - zeek-logs:/opt/zeek/logs
      - ./collector/network_collector/zeek_config:/opt/zeek/etc

  # Filebeat (æ—¥å¿—é‡‡é›†)
  filebeat:
    image: docker.elastic.co/beats/filebeat:7.17.9
    container_name: filebeat-collector
    user: root
    volumes:
      - ./collector/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - web-logs:/var/log/web:ro
      - db-logs:/var/log/db:ro
      - internal-logs:/var/log/internal:ro
      - dc-logs:/var/log/dc:ro
      - zeek-logs:/var/log/zeek:ro
    depends_on:
      - elasticsearch
    networks:
      - attack-range

  # === åˆ†æå¼•æ“ ===
  analyzer:
    build: ./analyzer
    container_name: analyzer-engine
    volumes:
      - ./analyzer:/app
    depends_on:
      - elasticsearch
    networks:
      - attack-range
    command: python -u /app/main.py

networks:
  attack-range:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

volumes:
  es-data:
  web-logs:
  db-logs:
  internal-logs:
  dc-logs:
  zeek-logs:
```

**æ”»å‡»æ¨¡æ‹Ÿè„šæœ¬ï¼š**

```python
# infrastructure/attack_simulator/scenarios/full_attack_chain.py

"""
å®Œæ•´æ”»å‡»é“¾æ¨¡æ‹Ÿè„šæœ¬
æ¨¡æ‹Ÿä»åˆå§‹è®¿é—®åˆ°æ•°æ®çªƒå–çš„å®Œæ•´æ”»å‡»è¿‡ç¨‹
"""

import subprocess
import time
import logging

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

class AttackSimulator:
    """æ”»å‡»æ¨¡æ‹Ÿå™¨"""
    
    def __init__(self):
        self.targets = {
            "web_server": "172.20.0.20",
            "db_server": "172.20.0.30",
            "internal_host": "172.20.0.40",
            "dc_server": "172.20.0.50"
        }
    
    def run_full_attack(self):
        """è¿è¡Œå®Œæ•´æ”»å‡»é“¾"""
        logger.info("=" * 60)
        logger.info("å¼€å§‹æ‰§è¡Œå®Œæ•´æ”»å‡»é“¾æ¨¡æ‹Ÿ")
        logger.info("=" * 60)
        
        # é˜¶æ®µ 1ï¼šåˆå§‹è®¿é—® - SSH æš´åŠ›ç ´è§£
        logger.info("\n[é˜¶æ®µ 1] åˆå§‹è®¿é—® - SSH æš´åŠ›ç ´è§£")
        self.ssh_bruteforce(self.targets["web_server"])
        time.sleep(5)
        
        # é˜¶æ®µ 2ï¼šæ‰§è¡Œ - å‘½ä»¤æ‰§è¡Œ
        logger.info("\n[é˜¶æ®µ 2] æ‰§è¡Œ - è¿œç¨‹å‘½ä»¤æ‰§è¡Œ")
        self.execute_commands(self.targets["web_server"])
        time.sleep(5)
        
        # é˜¶æ®µ 3ï¼šå‘ç° - å†…ç½‘æ‰«æ
        logger.info("\n[é˜¶æ®µ 3] å‘ç° - å†…ç½‘æ‰«æ")
        self.network_discovery()
        time.sleep(5)
        
        # é˜¶æ®µ 4ï¼šæ¨ªå‘ç§»åŠ¨ - SSH åˆ°å†…ç½‘ä¸»æœº
        logger.info("\n[é˜¶æ®µ 4] æ¨ªå‘ç§»åŠ¨ - è®¿é—®å†…ç½‘ä¸»æœº")
        self.lateral_movement(self.targets["internal_host"])
        time.sleep(5)
        
        # é˜¶æ®µ 5ï¼šæƒé™æå‡ - å°è¯•ææƒ
        logger.info("\n[é˜¶æ®µ 5] æƒé™æå‡ - å°è¯• sudo ææƒ")
        self.privilege_escalation()
        time.sleep(5)
        
        # é˜¶æ®µ 6ï¼šæ•°æ®æ”¶é›† - è®¿é—®æ•æ„Ÿæ–‡ä»¶
        logger.info("\n[é˜¶æ®µ 6] æ•°æ®æ”¶é›† - è®¿é—®æ•æ„Ÿæ–‡ä»¶")
        self.collect_data()
        time.sleep(5)
        
        # é˜¶æ®µ 7ï¼šæ•°æ®çªƒå– - å¤–ä¼ æ•°æ®
        logger.info("\n[é˜¶æ®µ 7] æ•°æ®çªƒå– - æ¨¡æ‹Ÿæ•°æ®å¤–ä¼ ")
        self.exfiltrate_data()
        
        logger.info("\n" + "=" * 60)
        logger.info("æ”»å‡»é“¾æ¨¡æ‹Ÿå®Œæˆ")
        logger.info("=" * 60)
    
    def ssh_bruteforce(self, target: str):
        """SSH æš´åŠ›ç ´è§£æ¨¡æ‹Ÿ"""
        logger.info(f"  ç›®æ ‡: {target}")
        
        # æ¨¡æ‹Ÿå¤šæ¬¡å¤±è´¥çš„ SSH ç™»å½•å°è¯•
        passwords = ["admin", "123456", "password", "root", "correct_password"]
        
        for pwd in passwords:
            logger.info(f"  å°è¯•å¯†ç : {pwd}")
            # ä½¿ç”¨ sshpass æ¨¡æ‹Ÿç™»å½•ï¼ˆå®é™…ç¯å¢ƒä¸­ï¼‰
            # subprocess.run(["sshpass", "-p", pwd, "ssh", "-o", 
            #                 "StrictHostKeyChecking=no", f"root@{target}", "echo 'test'"])
            time.sleep(1)
        
        logger.info("  [æˆåŠŸ] SSH ç™»å½•æˆåŠŸ")
    
    def execute_commands(self, target: str):
        """è¿œç¨‹å‘½ä»¤æ‰§è¡Œ"""
        commands = [
            "whoami",
            "id",
            "uname -a",
            "cat /etc/passwd",
            "netstat -an"
        ]
        
        for cmd in commands:
            logger.info(f"  æ‰§è¡Œå‘½ä»¤: {cmd}")
            # subprocess.run(["ssh", f"root@{target}", cmd])
            time.sleep(0.5)
    
    def network_discovery(self):
        """å†…ç½‘æ‰«æ"""
        logger.info("  æ‰«æå†…ç½‘: 172.20.0.0/24")
        # subprocess.run(["nmap", "-sn", "172.20.0.0/24"])
        
        # æ¨¡æ‹Ÿå‘ç°çš„ä¸»æœº
        discovered = ["172.20.0.30 (db-server)", 
                      "172.20.0.40 (internal-host)",
                      "172.20.0.50 (dc-server)"]
        for host in discovered:
            logger.info(f"  å‘ç°ä¸»æœº: {host}")
    
    def lateral_movement(self, target: str):
        """æ¨ªå‘ç§»åŠ¨"""
        logger.info(f"  æ¨ªå‘ç§»åŠ¨åˆ°: {target}")
        # subprocess.run(["ssh", f"root@{target}", "hostname"])
    
    def privilege_escalation(self):
        """æƒé™æå‡"""
        logger.info("  æ‰§è¡Œ sudo -l æ£€æŸ¥æƒé™")
        logger.info("  å°è¯• sudo su ææƒ")
    
    def collect_data(self):
        """æ•°æ®æ”¶é›†"""
        sensitive_files = [
            "/etc/passwd",
            "/etc/shadow",
            "/home/user/.ssh/id_rsa",
            "/var/www/html/config.php"
        ]
        
        for f in sensitive_files:
            logger.info(f"  è®¿é—®æ•æ„Ÿæ–‡ä»¶: {f}")
    
    def exfiltrate_data(self):
        """æ•°æ®çªƒå–"""
        logger.info("  å‹ç¼©æ•æ„Ÿæ•°æ®...")
        logger.info("  é€šè¿‡ HTTP å¤–ä¼ æ•°æ®åˆ° C2 æœåŠ¡å™¨...")
        logger.info("  [å®Œæˆ] æ•°æ®å¤–ä¼ å®Œæˆ")


if __name__ == "__main__":
    simulator = AttackSimulator()
    simulator.run_full_attack()
```

---

## å…­ã€é¡¹ç›®ç›®å½•ç»“æ„ï¼ˆæœ€ç»ˆï¼‰

```
attack-tracing-system/
â”œâ”€â”€ docker-compose.yml              # ä¸»ç¼–æ’æ–‡ä»¶
â”œâ”€â”€ README.md                       # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ requirements.txt                # Python ä¾èµ–
â”‚
â”œâ”€â”€ collector/                      # æ•°æ®é‡‡é›†å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ es_client.py           # Elasticsearch å®¢æˆ·ç«¯ï¼ˆå…¬å…±ï¼‰
â”‚   â”‚   â”œâ”€â”€ schema.py              # ç»Ÿä¸€æ•°æ®æ ¼å¼å®šä¹‰
â”‚   â”‚   â””â”€â”€ utils.py               # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ host_collector/            # ã€ç»„å‘˜1ã€‘
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auditd_config.py
â”‚   â”‚   â”œâ”€â”€ log_parser.py
â”‚   â”‚   â””â”€â”€ pipeline/
â”‚   â””â”€â”€ network_collector/         # ã€ç»„å‘˜2ã€‘
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ zeek_config.py
â”‚       â”œâ”€â”€ flow_parser.py
â”‚       â””â”€â”€ dns_tunnel_detector.py
â”‚
â”œâ”€â”€ analyzer/                       # åˆ†æå¼•æ“å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main.py                    # åˆ†æå¼•æ“ä¸»å…¥å£
â”‚   â”œâ”€â”€ attack_analyzer/           # ã€ç»„å‘˜3ã€‘
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ attack_mapper.py
â”‚   â”‚   â”œâ”€â”€ attack_rules.py
â”‚   â”‚   â”œâ”€â”€ timeline_correlator.py
â”‚   â”‚   â””â”€â”€ causality_analyzer.py
â”‚   â””â”€â”€ graph_analyzer/            # ã€ç»„å‘˜4ã€‘
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ entity_extractor.py
â”‚       â”œâ”€â”€ graph_builder.py
â”‚       â”œâ”€â”€ path_rebuilder.py
â”‚       â””â”€â”€ attacker_profiler.py
â”‚
â”œâ”€â”€ infrastructure/                 # åŸºç¡€è®¾æ–½å±‚
â”‚   â”œâ”€â”€ range/                     # ã€ç»„å‘˜5ã€‘é¶åœºé…ç½®
â”‚   â”‚   â”œâ”€â”€ attacker/
â”‚   â”‚   â”œâ”€â”€ web-server/
â”‚   â”‚   â”œâ”€â”€ db-server/
â”‚   â”‚   â”œâ”€â”€ internal-host/
â”‚   â”‚   â””â”€â”€ dc-server/
â”‚   â””â”€â”€ attack_simulator/          # ã€ç»„å‘˜5ã€‘æ”»å‡»æ¨¡æ‹Ÿ
â”‚       â”œâ”€â”€ scenarios/
â”‚       â””â”€â”€ run_scenario.py
â”‚
â”œâ”€â”€ frontend/                       # å‰ç«¯å±•ç¤ºå±‚ã€ç»„å‘˜5ã€‘
â”‚   â”œâ”€â”€ kibana_dashboards/
â”‚   â””â”€â”€ visualizations/
â”‚
â”œâ”€â”€ config/                         # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ elasticsearch/
â”‚   â”‚   â”œâ”€â”€ index_templates/
â”‚   â”‚   â””â”€â”€ ingest_pipelines/
â”‚   â””â”€â”€ filebeat/
â”‚
â””â”€â”€ tests/                          # æµ‹è¯•
    â”œâ”€â”€ test_host_collector.py
    â”œâ”€â”€ test_network_collector.py
    â”œâ”€â”€ test_attack_analyzer.py
    â””â”€â”€ test_graph_analyzer.py
```

---

## ä¸ƒã€å…¬å…±æ¨¡å—ä»£ç ï¼ˆæ‰€æœ‰äººä½¿ç”¨ï¼‰

### 7.0 ä»€ä¹ˆæ˜¯å…¬å…±æ¨¡å—ï¼Ÿä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

#### 7.0.1 é€šä¿—è§£é‡Š

**å…¬å…±æ¨¡å—** å°±æ˜¯"å¤§å®¶éƒ½è¦ç”¨çš„ä»£ç "ï¼Œåªå†™ä¸€æ¬¡ï¼Œæ‰€æœ‰äººå…±äº«ã€‚

**ç±»æ¯”ç†è§£ï¼š**
```
æƒ³è±¡ 5 ä¸ªäººä¸€èµ·åšèœï¼š
- æ¯é“èœéƒ½éœ€è¦åˆ‡èœ
- å¦‚æœæ¯ä¸ªäººè‡ªå·±å¸¦åˆ€ï¼š
  - å¼ ä¸‰çš„åˆ€åˆ‡å‡ºæ¥ 1 å˜ç±³
  - æå››çš„åˆ€åˆ‡å‡ºæ¥ 2 å˜ç±³
  - ç»“æœï¼šèœçš„å¤§å°ä¸ä¸€è‡´ï¼

æœ‰äº†å…¬å…±çš„åˆ€ï¼ˆå…¬å…±æ¨¡å—ï¼‰ï¼š
- å¤§å®¶éƒ½ç”¨åŒä¸€æŠŠåˆ€
- åˆ‡å‡ºæ¥çš„å¤§å°ä¸€è‡´
- ç»“æœï¼šèœå“æ ‡å‡†åŒ–ï¼
```

**åœ¨æˆ‘ä»¬é¡¹ç›®ä¸­ï¼š**
```
5 ä¸ªç»„å‘˜éƒ½éœ€è¦ï¼š
- è¿æ¥ Elasticsearch
- å†™å…¥æ•°æ®
- æŸ¥è¯¢æ•°æ®

å¦‚æœæ¯ä¸ªäººè‡ªå·±å†™ï¼š
- ç»„å‘˜1 å†™çš„è¿æ¥æ–¹å¼å¯èƒ½æœ‰ bug
- ç»„å‘˜2 å†™çš„æ•°æ®æ ¼å¼å¯èƒ½ä¸å¯¹
- ç»„å‘˜3 æŸ¥è¯¢çš„å­—æ®µå¯èƒ½ä¸ä¸€è‡´
- ç»“æœï¼šé›†æˆæ—¶ä¸€å †é—®é¢˜ï¼

æœ‰äº†å…¬å…±æ¨¡å—ï¼š
- ESClient ç±»ï¼šç»Ÿä¸€çš„æ•°æ®åº“è¿æ¥å’Œæ“ä½œ
- Schema ç±»ï¼šç»Ÿä¸€çš„æ•°æ®æ ¼å¼å®šä¹‰
- æ‰€æœ‰äºº import åŒä¸€ä¸ªæ¨¡å—
- ç»“æœï¼šæ•°æ®æ ¼å¼å®Œå…¨ä¸€è‡´ï¼
```

#### 7.0.2 å…¬å…±æ¨¡å—åŒ…å«ä»€ä¹ˆï¼Ÿ

| æ¨¡å— | æ–‡ä»¶ | ä½œç”¨ | è°ç”¨ |
|------|------|------|------|
| **ES å®¢æˆ·ç«¯** | `collector/common/es_client.py` | è¿æ¥ ESã€å†™å…¥æ•°æ®ã€æŸ¥è¯¢æ•°æ® | æ‰€æœ‰äºº |
| **æ•°æ®æ ¼å¼å®šä¹‰** | `collector/common/schema.py` | å®šä¹‰ç»Ÿä¸€çš„äº‹ä»¶æ ¼å¼ | æ‰€æœ‰äºº |
| **å·¥å…·å‡½æ•°** | `collector/common/utils.py` | æ—¶é—´è½¬æ¢ã€UUID ç”Ÿæˆç­‰ | æ‰€æœ‰äºº |

#### 7.0.3 å…¬å…±æ¨¡å—çš„ä½¿ç”¨æ–¹å¼

```python
# ç»„å‘˜1 çš„ä»£ç 
from collector.common.es_client import ESClient
from collector.common.schema import UnifiedEvent

# ç»„å‘˜2 çš„ä»£ç 
from collector.common.es_client import ESClient
from collector.common.schema import UnifiedEvent

# ç»„å‘˜3 çš„ä»£ç 
from collector.common.es_client import ESClient

# ç»„å‘˜4 çš„ä»£ç 
from collector.common.es_client import ESClient

# ç»„å‘˜5 çš„ä»£ç 
from collector.common.es_client import ESClient
```

**æ‰€æœ‰äººéƒ½ import åŒä¸€ä¸ªæ¨¡å—ï¼Œä¿è¯æ•°æ®æ ¼å¼å’Œæ“ä½œæ–¹å¼ä¸€è‡´ï¼**

#### 7.0.4 å…¬å…±æ¨¡å—ç”±è°å¼€å‘ï¼Ÿ

**å»ºè®®ç”±ç»„å‘˜5ï¼ˆè´Ÿè´£æ•´åˆçš„äººï¼‰åœ¨ç¬¬ 1 å¤©å¼€å‘å®Œæˆ**ï¼Œç„¶åå…¶ä»–ç»„å‘˜ç›´æ¥ä½¿ç”¨ã€‚

---

### 7.1 å…¬å…±æ¨¡å—ä»£ç 

```python
# collector/common/es_client.py

from elasticsearch import Elasticsearch
from elasticsearch.helpers import bulk
from datetime import datetime
import uuid

class ESClient:
    """Elasticsearch å®¢æˆ·ç«¯å°è£…"""
    
    def __init__(self, hosts=["http://localhost:9200"]):
        self.es = Elasticsearch(hosts)
    
    def write_event(self, event: dict, index_prefix: str = "unified-logs") -> str:
        """å†™å…¥å•æ¡äº‹ä»¶"""
        # ç¡®ä¿æœ‰äº‹ä»¶ID
        if "event" not in event:
            event["event"] = {}
        if "id" not in event["event"]:
            event["event"]["id"] = str(uuid.uuid4())
        
        # ç¡®ä¿æœ‰æ—¶é—´æˆ³
        if "@timestamp" not in event:
            event["@timestamp"] = datetime.utcnow().isoformat() + "Z"
        
        # ç”Ÿæˆç´¢å¼•å
        date_str = datetime.utcnow().strftime("%Y.%m.%d")
        index_name = f"{index_prefix}-{date_str}"
        
        # å†™å…¥
        result = self.es.index(index=index_name, body=event)
        
        return event["event"]["id"]
    
    def write_events_bulk(self, events: list, index_prefix: str = "unified-logs") -> dict:
        """æ‰¹é‡å†™å…¥äº‹ä»¶"""
        date_str = datetime.utcnow().strftime("%Y.%m.%d")
        index_name = f"{index_prefix}-{date_str}"
        
        actions = []
        for event in events:
            if "event" not in event:
                event["event"] = {}
            if "id" not in event["event"]:
                event["event"]["id"] = str(uuid.uuid4())
            if "@timestamp" not in event:
                event["@timestamp"] = datetime.utcnow().isoformat() + "Z"
            
            actions.append({
                "_index": index_name,
                "_source": event
            })
        
        success, failed = bulk(self.es, actions, raise_on_error=False)
        
        return {"success": success, "failed": len(failed)}
    
    def query_events(self, start_time: str, end_time: str, 
                     index_prefix: str = "unified-logs",
                     filters: dict = None, size: int = 1000) -> list:
        """æŸ¥è¯¢äº‹ä»¶"""
        query = {
            "bool": {
                "must": [
                    {
                        "range": {
                            "@timestamp": {
                                "gte": start_time,
                                "lte": end_time
                            }
                        }
                    }
                ]
            }
        }
        
        # æ·»åŠ è¿‡æ»¤æ¡ä»¶
        if filters:
            for field, value in filters.items():
                query["bool"]["must"].append({
                    "term": {field: value}
                })
        
        result = self.es.search(
            index=f"{index_prefix}-*",
            body={
                "query": query,
                "size": size,
                "sort": [{"@timestamp": "asc"}]
            }
        )
        
        return [hit["_source"] for hit in result["hits"]["hits"]]


# collector/common/schema.py

"""ç»Ÿä¸€æ•°æ®æ ¼å¼å®šä¹‰"""

from dataclasses import dataclass, field, asdict
from typing import Optional, List, Dict
from datetime import datetime
import uuid

@dataclass
class GeoLocation:
    lat: float = 0.0
    lon: float = 0.0

@dataclass
class GeoInfo:
    country_name: str = ""
    city_name: str = ""
    location: GeoLocation = field(default_factory=GeoLocation)

@dataclass
class SourceInfo:
    ip: str = ""
    port: int = 0
    mac: str = ""
    geo: GeoInfo = field(default_factory=GeoInfo)

@dataclass
class DestinationInfo:
    ip: str = ""
    port: int = 0
    mac: str = ""

@dataclass
class HostInfo:
    name: str = ""
    hostname: str = ""
    ip: List[str] = field(default_factory=list)

@dataclass
class ProcessParent:
    pid: int = 0
    name: str = ""
    executable: str = ""

@dataclass
class ProcessUser:
    name: str = ""
    id: str = ""

@dataclass
class ProcessInfo:
    pid: int = 0
    name: str = ""
    executable: str = ""
    command_line: str = ""
    parent: ProcessParent = field(default_factory=ProcessParent)
    user: ProcessUser = field(default_factory=ProcessUser)

@dataclass
class FileHash:
    md5: str = ""
    sha256: str = ""

@dataclass
class FileInfo:
    path: str = ""
    name: str = ""
    extension: str = ""
    size: int = 0
    hash: FileHash = field(default_factory=FileHash)

@dataclass
class NetworkInfo:
    protocol: str = ""
    transport: str = ""
    application: str = ""
    bytes: int = 0
    packets: int = 0
    direction: str = ""

@dataclass
class UserInfo:
    name: str = ""
    id: str = ""
    domain: str = ""

@dataclass
class TacticInfo:
    id: str = ""
    name: str = ""

@dataclass
class TechniqueInfo:
    id: str = ""
    name: str = ""

@dataclass
class ThreatInfo:
    framework: str = "MITRE ATT&CK"
    tactic: TacticInfo = field(default_factory=TacticInfo)
    technique: TechniqueInfo = field(default_factory=TechniqueInfo)

@dataclass
class EventInfo:
    id: str = field(default_factory=lambda: str(uuid.uuid4()))
    category: str = ""  # process, network, file, authentication, host
    type: str = ""      # start, end, info
    action: str = ""    # å…·ä½“åŠ¨ä½œ
    outcome: str = ""   # success, failure, unknown
    severity: int = 5   # 1-10
    dataset: str = ""   # auditd, zeek, cowrie, etc.

@dataclass
class UnifiedEvent:
    """ç»Ÿä¸€äº‹ä»¶æ ¼å¼"""
    timestamp: str = field(default_factory=lambda: datetime.utcnow().isoformat() + "Z")
    event: EventInfo = field(default_factory=EventInfo)
    source: SourceInfo = field(default_factory=SourceInfo)
    destination: DestinationInfo = field(default_factory=DestinationInfo)
    host: HostInfo = field(default_factory=HostInfo)
    process: ProcessInfo = field(default_factory=ProcessInfo)
    file: FileInfo = field(default_factory=FileInfo)
    network: NetworkInfo = field(default_factory=NetworkInfo)
    user: UserInfo = field(default_factory=UserInfo)
    threat: ThreatInfo = field(default_factory=ThreatInfo)
    message: str = ""
    raw: Dict = field(default_factory=dict)
    
    def to_dict(self) -> dict:
        """è½¬æ¢ä¸ºå­—å…¸ï¼ˆç”¨äºå­˜å…¥ ESï¼‰"""
        data = asdict(self)
        # å°† timestamp è½¬æ¢ä¸º @timestamp
        data["@timestamp"] = data.pop("timestamp")
        return data
    
    @classmethod
    def from_dict(cls, data: dict) -> "UnifiedEvent":
        """ä»å­—å…¸åˆ›å»º"""
        if "@timestamp" in data:
            data["timestamp"] = data.pop("@timestamp")
        # ç®€åŒ–å¤„ç†ï¼Œå®é™…éœ€è¦é€’å½’è½¬æ¢
        return cls(**{k: v for k, v in data.items() if k in cls.__dataclass_fields__})
```

---

## å…«ã€4 å¤©æ—¶é—´å®‰æ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          4 å¤©æ—¶é—´å®‰æ’                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  ã€ç¬¬ 1 å¤©ã€‘ç¯å¢ƒæ­å»º + å…¬å…±æ¨¡å—                                          â”‚
â”‚  â”œâ”€ ç»„å‘˜5ï¼šç§Ÿç”¨æœåŠ¡å™¨ï¼Œæ­å»º Docker ç¯å¢ƒï¼Œé…ç½® Git åä½œ                  â”‚
â”‚  â”œâ”€ æ‰€æœ‰äººï¼šç»Ÿä¸€å­¦ä¹ æ¥å£è§„èŒƒ                                            â”‚
â”‚  â”œâ”€ ç»„å‘˜5ï¼šå®ŒæˆåŸºç¡€ docker-compose.yml                                  â”‚
â”‚  â””â”€ æ‰€æœ‰äººï¼šæ‹‰å–ä»£ç ï¼Œæµ‹è¯•æœ¬åœ°å¼€å‘ç¯å¢ƒ                                  â”‚
â”‚                                                                          â”‚
â”‚  ã€ç¬¬ 2 å¤©ã€‘å„æ¨¡å—ç‹¬ç«‹å¼€å‘                                               â”‚
â”‚  â”œâ”€ ç»„å‘˜1ï¼šå®Œæˆä¸»æœºæ—¥å¿—é‡‡é›† + è§£æå™¨                                    â”‚
â”‚  â”œâ”€ ç»„å‘˜2ï¼šå®Œæˆç½‘ç»œæµé‡é‡‡é›† + Zeek é…ç½®                                 â”‚
â”‚  â”œâ”€ ç»„å‘˜3ï¼šå®Œæˆ ATT&CK æ˜ å°„è§„åˆ™ + æ—¶é—´çº¿å…³è”                            â”‚
â”‚  â”œâ”€ ç»„å‘˜4ï¼šå®Œæˆå®ä½“æŠ½å– + å…³ç³»å›¾æ„å»º                                    â”‚
â”‚  â””â”€ ç»„å‘˜5ï¼šå®Œæˆé¶åœºèŠ‚ç‚¹é…ç½® + æ”»å‡»æ¨¡æ‹Ÿè„šæœ¬                              â”‚
â”‚                                                                          â”‚
â”‚  ã€ç¬¬ 3 å¤©ã€‘æ¨¡å—é›†æˆ + æµ‹è¯•                                              â”‚
â”‚  â”œâ”€ ä¸Šåˆï¼šå„æ¨¡å—å•å…ƒæµ‹è¯•                                                â”‚
â”‚  â”œâ”€ ä¸‹åˆï¼šæ¨¡å—é›†æˆæµ‹è¯•                                                  â”‚
â”‚  â”œâ”€ ç»„å‘˜5ï¼šè¿è¡Œæ”»å‡»æ¨¡æ‹Ÿï¼Œç”Ÿæˆæµ‹è¯•æ•°æ®                                   â”‚
â”‚  â””â”€ æ‰€æœ‰äººï¼šä¿®å¤é›†æˆé—®é¢˜                                                â”‚
â”‚                                                                          â”‚
â”‚  ã€ç¬¬ 4 å¤©ã€‘æ¼”ç¤ºå‡†å¤‡ + æ–‡æ¡£                                              â”‚
â”‚  â”œâ”€ ä¸Šåˆï¼šKibana ä»ªè¡¨ç›˜é…ç½®                                             â”‚
â”‚  â”œâ”€ ä¸‹åˆï¼šå‡†å¤‡æ¼”ç¤ºææ–™ï¼Œæˆªå›¾ï¼ŒPPT                                       â”‚
â”‚  â””â”€ æ™šä¸Šï¼šæ¼”ç¤ºæ’ç»ƒ                                                      â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¹ã€åä½œå¼€å‘å»ºè®®

### 1. Git åä½œæµç¨‹

```bash
# 1. å…‹éš†ä»“åº“
git clone git@github.com:your-team/attack-tracing-system.git

# 2. åˆ›å»ºä¸ªäººåˆ†æ”¯
git checkout -b feature/member1-host-collector

# 3. å¼€å‘å®Œæˆåæäº¤
git add .
git commit -m "[ç»„å‘˜1] å®Œæˆä¸»æœºæ—¥å¿—é‡‡é›†æ¨¡å—"

# 4. æ¨é€åˆ†æ”¯
git push origin feature/member1-host-collector

# 5. åˆ›å»º Pull Requestï¼Œç”±ç»„å‘˜5 åˆå¹¶
```

### 2. æ¯æ—¥åŒæ­¥

```
æ¯å¤©æ™šä¸Š 21:00ï¼š
1. å„ç»„å‘˜æ¨é€å½“æ—¥ä»£ç 
2. ç»„å‘˜5 åˆå¹¶ä»£ç åˆ° main åˆ†æ”¯
3. æ‰€æœ‰äººæ‹‰å–æœ€æ–°ä»£ç 
4. ç®€çŸ­ä¼šè®®åŒæ­¥è¿›åº¦ï¼ˆ15åˆ†é’Ÿï¼‰
```

### 3. æ¥å£æµ‹è¯•

```bash
# æ¯ä¸ªæ¨¡å—æä¾›æµ‹è¯•å‘½ä»¤
python -m pytest tests/test_host_collector.py -v
python -m pytest tests/test_network_collector.py -v
python -m pytest tests/test_attack_analyzer.py -v
python -m pytest tests/test_graph_analyzer.py -v
```

---

## åã€å¿«é€Ÿå¼€å§‹å‘½ä»¤

```bash
# 1. ç™»å½•æœåŠ¡å™¨
ssh root@your-server-ip

# 2. å®‰è£… Docker
curl -fsSL https://get.docker.com | sh

# 3. å®‰è£… Docker Compose
apt install docker-compose-plugin

# 4. å…‹éš†é¡¹ç›®
git clone https://github.com/your-team/attack-tracing-system.git
cd attack-tracing-system

# 5. å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker compose up -d

# 6. æŸ¥çœ‹çŠ¶æ€
docker compose ps

# 7. è¿è¡Œæ”»å‡»æ¨¡æ‹Ÿ
docker exec -it attacker-node python /attack_simulator/scenarios/full_attack_chain.py

# 8. è®¿é—® Kibana
http://your-server-ip:5601
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **ç»Ÿä¸€æ¥å£è§„èŒƒ** - æ‰€æœ‰æ¨¡å—ä½¿ç”¨ç›¸åŒçš„æ•°æ®æ ¼å¼ï¼ˆECSï¼‰ï¼Œé€šè¿‡ ESClient å­˜å–æ•°æ®
2. **æ¨¡å—ç‹¬ç«‹å¼€å‘** - æ¯ä¸ªç»„å‘˜è´Ÿè´£ç‹¬ç«‹æ¨¡å—ï¼Œå¯å•ç‹¬æµ‹è¯•
3. **ç»„å‘˜5 è´Ÿè´£æ•´åˆ** - é¶åœºæ­å»ºã€æ”»å‡»æ¨¡æ‹Ÿã€æœ€ç»ˆé›†æˆ
4. **4 å¤©æ—¶é—´ç´§å‡‘** - ç¬¬1å¤©ç¯å¢ƒï¼Œç¬¬2å¤©å¼€å‘ï¼Œç¬¬3å¤©é›†æˆï¼Œç¬¬4å¤©æ¼”ç¤º

### å…³é”®æ–‡ä»¶

- `collector/common/es_client.py` - å…¬å…± ES å®¢æˆ·ç«¯ï¼ˆæ‰€æœ‰äººç”¨ï¼‰
- `collector/common/schema.py` - ç»Ÿä¸€æ•°æ®æ ¼å¼å®šä¹‰
- å„ç»„å‘˜æŒ‰åˆ†å·¥å®Œæˆå„è‡ªæ¨¡å—

### è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ç»„é•¿ï¼ˆç»„å‘˜5ï¼‰åè°ƒè§£å†³ã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*åˆ›å»ºæ—¥æœŸï¼š2024å¹´*
